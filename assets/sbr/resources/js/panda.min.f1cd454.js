/*! Welcome to Comicpanda! We're using d3, jquery, marked, moment, odometer, pikaday, soundcloud, tiny scrollbar, trunk8, mo, and YUI. 2018-12-08 */var pInt=function(a){return parseInt(a||0,10)},blankImgSrc="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",PANDA=function(){var a,b,c,d,e,f,g,h,i=pandaConfig,j=".",k=!1,l={msg:!1,isError:!1,callbackFn:!1},m=!1,n=[],o=[],p=$(window),q=this;return a={init:function(){q.__initialize()},__initialize:function(){e=$("#panda-action-form"),q.require(["common.initiation","account.signin","account.resendEmail","account.saveEmail"]),q.blockConsole(),q.hideOutlineOnMouseDown(),q.tooltipAutoload(),h&&setTimeout(function(){try{$(h.el).each(function(){var a=$(this).trigger(h.eventType)[0];if(h.setFocus&&a){a.getBoundingClientRect().top>$(window).height()&&a.scrollIntoView(!0)}return!1})}catch(a){q.log("callback error.")}},1e3)},tooltipAutoload:function(){$(".tooltip-autoload").tooltip()},hideOutlineOnMouseDown:function(){var a=$("<style>");$("head").append(a),$(document).mousedown(function(){a.text("a:focus{outline:none}")}).keydown(function(){a.text("")})},blockConsole:function(){"prod"===q.getEnvs("env")&&"undefined"!=typeof console&&Object.hasOwnProperty("defineProperty")&&Object.defineProperty(console,"_commandLineAPI",{get:function(){throw"Hello world!"}})},isSignedIn:function(){return q.getEnvs("isSignedIn")},log:function(){if("undefined"!=typeof console&&void 0!==console.log)try{console.log.apply(console,arguments)}catch(a){}},dir:function(){"undefined"!=typeof console&&void 0!==console.dir&&console.dir.apply(console,arguments)},namespace:function(){for(var a,b,c,d=arguments,e=0,f=this;e<d.length;e++)if(c=d[e],c.indexOf(j)>0)for(a=c.split(j),b="PANDA"===a[0]?1:0;b<a.length;b++)f[a[b]]=f[a[b]]||{},f=f[a[b]];else f[c]=f[c]||{};return f},stopEvent:function(a,b){a&&(a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault(),"click"===a.type&&a.currentTarget&&a.currentTarget.className.indexOf("ga-tracking")>-1&&q.addGATrackEvent($(a.currentTarget)),!1!==b&&(p.trigger("click.closed").trigger("tap.closed"),q.triggerTopMenuEvent()))},triggerTopMenuEvent:function(){p.data("isRegTopMenuEvent")&&p.trigger("top.menu.closes").data("isRegTopMenuEvent",!1)},require:function(){var a=this,b=arguments;if(!pandaModules||pandaModules.isAllJsReady)return q.__require.apply(a,arguments);pandaModules.requiredFns.push(function(){q.__require.apply(a,b)})},__require:function(){var a,b=Array.prototype.slice.call(arguments),c=b.shift(),d="init",e=function(a){var c=q._objectDeepProp("get",a);if("function"==typeof c&&(c=new c,c.hasOwnProperty(d)))return c=c[d].apply(q,b),q._objectDeepProp("add",a,c),c;q.log(a+" does not have the "+d+" function!!")},f=function(c){if(c=c.replace("panda.",""),c.indexOf(j)<0)return q.log(c+" can not be loaded."),q;if(c.indexOf("fn.")>-1){var f=new q._objectDeepProp("get",c)();return f.init.apply(f,b)}a=c.split(j);var g=q._objectDeepProp("get",c);if("object"==typeof g)return g;if(void 0===g){var h=a.length-1;d=a[h],c=a.slice(0,h).join(".")}return e(c)};return $.isArray(c)?($.each(c,function(a,b){f(b)}),q):f(c)},_objectDeepProp:function(a,b){var c=q,d=b;if(b.indexOf(j)>0){var e,f=!0,g=b.split(j);for(e=0;e<g.length-1;e++)c.hasOwnProperty([g[e]])&&(c=c[g[e]],f=!1);if(f)return!1;d=g[g.length-1]}return"get"===a?c[d]||void 0:c[d]=arguments[2]},loadJavascript:function(a,b){var c,d=arguments[2]||+new Date;document.getElementById(d)||(c=document.createElement("script"),c.type="text/javascript",c.async=!0,c.id=d,c.src=a,void 0===c.onload?c.onreadystatechange=function(){"complete"!==this.readyState&&"loaded"!==this.readyState||q.callback(b)}:c.onload=b,document.getElementsByTagName("head")[0].appendChild(c))},callback:function(a){if(a)return"function"==typeof a?a.apply(this,Array.prototype.slice.call(arguments,1)):q},alert:function(a){q.stopRunning(),a=a||{};var b=q.templateCompile("alert-popup",{title:a.title||"oops!",body:a.body||""});a.isConfirm&&b.find(".js-cancel").removeClass("hidden");var d=b.find(".js-action").click(q.alertActionDelegate);b.on("rendered",function(){d.focus()}),q.showOverlay(b,!0),c=a.cb?a.cb:$.noop},alertActionDelegate:function(a){q.stopEvent(a),"ok"===$(this).data("action")&&q.callback(c),q.hideOverlay()},startRunning:function(){k=!0},isRunning:function(){return k},stopRunning:function(){k=!1},ajaxJSON:function(a,c,d,e){var f=c.isSkipCommonAlert||!1,g=c.alertCB||$.noop,h=c.keepOverlay||!1;if(delete c.isSkipCommonAlert,delete c.alertCB,delete c.keepOverlay,!q.isRunning()||b!==a){b=a,q.startRunning(),$.ajaxSettings.contentType="application/x-www-form-urlencoded; charset=UTF-8";var i=function(a,b,c){if(q.stopRunning(),a){var e=a.code;h||q.hideOverlay(),f||500!==e&&403!==e&&404!==e&&503!==e&&400!==e?401===e?"UNAUTHORIZED_ACCESS"===a.type?(q.setGlobalMessage(a.msg,!0,function(){q.require("panda.account.resendEmail").open(null,"activate")}),q.showGlobalMessage()):$(".js-activate-bar").length>0?q.require("panda.account.resendEmail").open(null,"activate"):q.alert({body:a.msg}):"function"==typeof d&&d(a,b,c):q.alert({body:a.msg,cb:g})}};return"post"===e&&(c.isPlain?delete c.isPlain:(c=JSON.stringify(c),$.ajaxSettings.contentType="application/json; charset=utf-8")),jQuery[e||"get"](a,c,i,"json")}},getEnvs:function(a){return a?i[a]:i},showOverlay:function(a,b,c){var e;if(a)return e=$("body"),d&&(d.data("locked",!1),q.hideOverlay()),a.find(".hide-overlay").on("click",function(a){q.stopEvent(a),q.hideOverlay(a)}),d=$('<div class="modal-backdrop hidden" />').append(a),e.append(d).addClass("overlay"),b&&($(document).on("keyup.dismiss.modal",function(a){27===a.which&&q.hideOverlay(a)}),d.on("click",function(a){a.target===this&&q.hideOverlay(a)})),"function"==typeof c&&d.on("popup.closed",c),q.isStopShortCutEvent(!0),setTimeout(function(){d&&d.removeClass("hidden"),a.trigger("rendered")},1),d},hideOverlay:function(a,b){if(q.stopEvent(a),!d||!d.data("locked"))return q.isStopShortCutEvent(!1),d&&($.browser().msie&&8===pInt($.browser().version)&&d.prev().remove(),d.trigger("popup.closed"),d.remove(),$(document).off("keyup.dismiss.modal").find("body").removeClass("overlay"),d=!1),c=$.noop,b&&q.callback(b),q},showLoading:function(){var a=q.templateCompile("tpLoadingIndicator");a.css({marginTop:screen.height/2-20+"px"}),q.showOverlay(a,!1)},isFileUploadSupport:function(){var a=jQuery.ajaxSettings.xhr();return a&&"upload"in a&&"onprogress"in a.upload},goToTop:function(a,b,c,d){q.stopEvent(a),b=Math.min(b||0,document.body.scrollHeight-p.height());var e=Math.ceil(Math.abs(p.scrollTop()-b)),f=Math.min(e?Math.max(.45*e,450):0,2e3);$("html , body").animate({scrollTop:b},{duration:f,easing:"easeInOutQuad"}).promise().done(function(){c&&c(),d||$(window).trigger("scroll")})},enter2submit:function(a,b){return!(!1!==a.shiftKey||!1!==a.altKey||!1!==a.ctrlKey||!q.isEnter(a))&&b.fn.call(b.scope||this,b.args||null)},toggleHolder:function(a,b){return a=$(a),a.val()||b?a.next().hide():a.next().show(),q},openSharePopup:function(a,b,c){var d=600,e=420;"gplus"===a?e=600:"pinterest"===a||"pin"===a?(d=700,e=300):"stumbleupon"===a?(d=920,e=540):"reddit"===a?(d=1e3,e=800):"tumblr"===a&&(d=500),q.openPopup({url:b,width:d,height:e}),q.callback(c)},openPopup:function(a){var b,c=0,d=0;return!!(a&&a.width&&a.height&&a.url)&&(!1!==a.center&&screen.width>a.width&&(c=screen.width?(screen.width-a.width)/2:100,d=screen.height?(screen.height-a.height)/2:100),b="width="+a.width+",height="+a.height+",top="+d+",left="+c+",scrollbars=yes,resizable=no,toolbar=no,location=no,menubar=no",window.open(a.url,a.title||"popup",b))},actionFormSubmit:function(a){if(q.isRunning())return!1;q.startRunning(),e.attr({action:a}).submit(),q.stopRunning()},getActionFormSubmit:function(){return e.empty().attr("target","_self")},clearActionFormSubmit:function(){e.attr({action:"/"}).empty()},getTimezoneOffset:function(){return-(new Date).getTimezoneOffset()},uploadFile:function(a,b,c,d){q.isFileUploadSupport()?$.ajaxFileUpload(a.attr("action"),a[0],b||{},function(a){q.callback(c,a)},d):(a.attr({target:"hidden-iframe"}),g=setTimeout(function(){window.iframeCallback=void 0},2e4),window.iframeCallback=function(a){g&&clearTimeout(g),q.callback(c,a),window.iframeCallback=void 0},a.submit())},makePlural:function(a,b){return 1===b?a:a+"s"},detectOffsetTime:function(){q.putJSON("/detect/offset_time?offsetTime="+q.getTimezoneOffset())},setGlobalMessage:function(a,b,c){l={msg:a,isError:!0===b,callbackFn:c||!1}},hideGlobalMessage:function(a){f&&(f.addClass("hidden").find(">div").removeClass("error confirm").html(""),q.callback(a))},showGlobalMessage:function(a,b,c,d){if(f||(f=$(".global-tongue-feedback")),a=a||l.msg,void 0===b&&(b=l.isError),a){if(clearTimeout(f.data("timeout")||null),f.find(">div").toggleClass("error",b||!1).toggleClass("confirm",c||!1).html(a),-1!==d){var e=l.callbackFn;f.data("timeout",setTimeout(function(){q.hideGlobalMessage(e)},d||3e3))}f.removeClass("hidden")}l={}},goPage:function(a,b){a?b?window.location.replace(a):window.location=a:window.location.reload()},isStopShortCutEvent:function(a){return void 0!==a&&(m=a),m},scrollTop:function(){return document.body.scrollTop||document.documentElement.scrollTop},putJSON:function(a,b){$.ajax({url:a,type:"PUT",success:b||$.noop})},makeUrl:function(a,b){return a+(-1!==a.indexOf("?")?"&":"?")+$.customParam(b)},historyStateOption:function(a){var b={isAjaxHistory:!0,url:document.location.href};if(a)for(var c in a)b[c]=a[c];return b},historyPushState:function(a){history.pushState&&(a=q.historyStateOption(a),history.pushState(a,document.title,a.url),$("#from").val(a.url))},setPopstateEvent:function(a){$(window).bind("popstate",function(b){b=b.originalEvent,b.state?b.state.isAjaxHistory&&(a.html(b.state.body),$("#from").val(b.state.url)):init?q.goPage(document.location.href):init=!0})},setCallbackFn:function(a){h=a},isDesktop:function(){return q.getEnvs("isDesktop")},pushGAPageView:function(a){"undefined"!=typeof ga&&ga("send","pageview",a)},isNumber:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},formattedString:function(a){return q.isNumber(a)?a.toLocaleString("en-US"):""},shortFormat:function(a){if(q.isNumber(a)){var b;return a<1e3?a+"":a>=1e3&&a<1e6?(b=a/1e3,Math.floor(10*b)/10+"k"):a>=1e6&&a<1e9?(b=a/1e6,Math.floor(10*b)/10+"m"):(b=a/1e9,Math.floor(10*b)/10+"b")}return"0"},arrayToMakeUrl:function(a){return"/"+a.join("/")},uid:function(a){return(a||"_id")+Math.random().toString().replace(".","")},templateCompile:function(a,b){b=b||{};var c=q.format($.trim($("#"+a).html()||""),b);return b.__pure?c:$(c)},format:function(a,b){if(void 0===b||null===b)return a;if("object"==typeof b){b=b||{};var c=function(b,c){a=a.replace(new RegExp("\\{\\{"+b+"\\}\\}","gi"),c)};return $.each(b,function(a,b){void 0===b&&(b=""),null!==b&&"object"==typeof b?$.each(b,function(b,d){c(a+"."+b,d)}):c(a,b)}),a.replace(/\{\{\w+\}\}/g,"")}return a.replace(/\{\{\w+\}\}/g,b)},addGATrackEvent:function(a){var b=a;if(a.jquery){if(!a.hasClass("ga-tracking"))return;a.removeClass("ga-tracking"),b={category:b.data("gaCategory")||"",action:b.data("gaAction")||"",label:b.data("gaLabel")||""}}$.isEmptyObject(b)||("undefined"==typeof ga?o.push(b):ga("send","event",b.category||"",b.action||"",b.label||""))},addAmplitudeEvent:function(a,b){if(window.amplitude)amplitude.logEvent(a,b||{});else{var c={};c[a]=b||{},n.push(c)}},pushAmplitudeEvent:function(){window.amplitude&&n.length>0&&$.each(n,function(a,b){for(var c in b)amplitude.logEvent(c,b[c])})},pushGAEvent:function(){ga&&o.length>0&&$.each(o,function(a,b){ga("send","event",b.category||"",b.action||"",b.label||"")})},isInViewPort:function(a,b){if(a){var c=a.getBoundingClientRect(),d=window.innerHeight||document.documentElement.clientHeight;return c.top>=0&&c.top-(void 0===b?c.height/2:b)<=d||c.top<=0&&c.bottom>=0}return!1},isEnter:function(a){return 13===a.keyCode||10===a.keyCode},setBlankImage:function(a){return a.attr("src",blankImgSrc)},cleanUpFileInput:function(a){a&&(a[0].value&&(a[0].value=null),a.replaceWith(a.clone(!0)))},addPressEscKeyEvent:function(a){q.detachPressEscKeyEvent().one("keyup.esckey",function(b){27===b.keyCode&&p.trigger(a)})},detachPressEscKeyEvent:function(){return p.off("keyup.esckey")},updateTooltipTitle:function(a,b,c){var d=(void 0===c?"":"<span>{{indicator}}</span>")+"{{title}}",e=q.format(d,{title:b,indicator:c});a.data("originalTitle",e).tooltip("update")},commifyNumbers:function(a){if(void 0===a)return 0;var b=a.toString().split(".");return b[0]=b[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),b.join(".")},initTooltip:function(){$('[data-toggle="tooltip"]').tooltip("destroy").tooltip()},dismissAlert:function(a){q.stopEvent(a);var b=$(this),c=b.data("dismiss");b.parent("."+c).addClass("hidden")},escapeCssNotation:function(a){return(a||"").replace(/(:|\.|\[|\]|,)/g,"\\$1")},convertKeyFromSnakeToCamel:function(a){if(!a)return a;var b={};for(var c in a)b[c.replace(/_\w/g,function(a){return a[1].toUpperCase()})]=a[c];return b},convertQuerystringToObj:function(a){if(a.indexOf("?")<0)return{};var b=a.substring(a.indexOf("?")+1),c=b.split("&"),d={};return c.forEach(function(a){var b=a.split("=");d[b[0]]=b[1]}),q.convertKeyFromSnakeToCamel(d)},preUploadingHook:function(a,b){q.callback(b,a)}},q=PANDA.prototype=a},panda=new PANDA;!function(){if("undefined"!=typeof pandaModules){var a=[pandaConfig.staticServer,pandaConfig.prefixResourceSrc,pandaModules.prefix,""].join("/");$.each(pandaModules.names,function(b,c){panda.loadJavascript(a+c,function(){delete pandaModules.names[b],$.isEmptyObject(pandaModules.names)&&(pandaModules.isAllJsReady=!0,$.each(pandaModules.requiredFns,function(a,b){b()}))},"panda-"+b)})}else pandaModules=!1}(),jQuery(function(){try{panda.init()}catch(a){panda.log("Panda init failed."),panda.log(a)}}),panda.namespace("common"),panda.common.initiation=function(){var a,b,c,d,e,f={},g=$(".js-buy-coins-btn"),h=$(".js-go-to-top-btn"),i=$(".js-nav-content"),j=i.parent(),k=$(".js-nav-menus"),l=$(".js-search-wrap"),m=$(".js-search-open-btn"),n=l.find(".js-search-close-btn"),o=$("#nav-search-form"),p=$(".js-search-input",o),q=$(".js-reading-list-wrap"),r=$(".js-activities-wrap"),s=$(".js-search-result"),t=$(window),u=38,v=40,w="top.menu.closes",x=function(){$("#ajax-error").ajaxError(function(a,b,c,d){$.ajaxSettings.async=!0,panda.stopRunning(),panda.log(d)})},y=function(){panda.addGATrackEvent($(this))},z=function(){l.hasClass("on")||(l.addClass("on"),k.addClass("off"),j.addClass("hold-effect"),C(),setTimeout(function(){p.focus(),k.addClass("hidden"),l.parent().addClass("on")},400))},A=function(){l.hasClass("on")&&(p.val(""),l.removeClass("on"),k.removeClass("hidden"),j.removeClass("hold-effect"),B(),setTimeout(function(){k.removeClass("off"),l.parent().removeClass("on")},10))},B=function(){c=-1,s.empty()},C=function(){a&&(a.removeClass("on"),a=void 0)},D=function(){var a=$(".js-site-notice-bar"),b=function(b){panda.stopEvent(b),panda.putJSON($(this).getHref()),a.remove(),j.removeClass("tall"),"object"==typeof panda.smartView.main?panda.smartView.main.removeSiteNoticeBar():t.trigger("resize")};a.isExists()&&$(".js-dismiss-btn",a).on("click",b)},E=function(){var a=panda.scrollTop();a>=400&&!h.data("hasUP")?h.data("hasUP",!0).addClass("on"):a<400&&h.data("hasUP")&&h.data("hasUP",!1).removeClass("on")},F=function(b){var c=$(this).closest(".js-top-menu"),d=c.hasClass("on"),e=c.data("id"),g=!!a&&a.data("id")===e;panda.stopEvent(b),d&&g||("reading-list"===e?f.loadReadingList(c):"activities"===e&&f.loadActivities(c),c.addClass("on"),j.addClass("hold-effect"),a=c,panda.addPressEscKeyEvent(w),t.one(w,function(){C(),panda.detachPressEscKeyEvent()}).data("isRegTopMenuEvent",!0))};return f={init:function(){x(),panda.showGlobalMessage(),D();var a=$(document);return a.on("click",".ga-tracking",y),$("#smart-view").isExists()||(h.on("click",panda.goToTop),t.on("scroll",E),E()),m.on("click",z),n.on("click",A),p.on("keydown paste cut",f.loadSearchResult),panda.require("coins.shop").appendBtn(g),i.on("click",".js-nav-btn",F),i.on("click",".js-mark-all",f.markAll),r.on("click",".js-activity-item",f.markActivity),t.on("click",function(a){$(a.target).closest(".js-event-menu").isExists()||panda.triggerTopMenuEvent()}),a.on("click",".alert >.alert-close",panda.dismissAlert),f},toggleHolder:function(){return $("span.text-holder").click(function(){$(this).prev().focus()}).each(function(){$(this).prev().keydown(function(){var a=$(this);if(a.val()&&a.val()>1)return!0;panda.toggleHolder(a,a.val()||!0)}).bind("blur focus",function(){panda.toggleHolder(this)}).each(function(){panda.toggleHolder(this)})}),this},markViewedActivity:function(a,b){b=b||$.noop,panda.putJSON("/activities/"+a+"/viewed",b)},markActivity:function(a){panda.stopEvent(a);var b=$(this),c=b.closest(".js-item").data("activityId"),d=function(){panda.goPage(b.getHref())};panda.addGATrackEvent({category:"top-navigation",action:"clicked",label:"activity"}),f.markViewedActivity(c,d)},markAll:function(a,b){panda.stopEvent(a,!1);var c=$(this),d=c.closest(".js-top-menu");(b||d.data("canMarkAll")||d.data("hasCount"))&&panda.putJSON(c.getHref(),function(){d.data("hasCount",!1).data("canMarkAll",!1).find(".js-notice-count").text(0).addClass("hidden"),$(".js-item.mod-unread").removeClass("mod-unread").find(".js-indicator").addClass("hidden")})},keyboardUpDownEvent:function(a,b,d){panda.stopEvent(a);var e,f=s.find(".js-search-result"),g=f.length,h=g-1;if(panda.isEnter(a)){if(!d)return;e=f.filter(".on").length>0,panda.addGATrackEvent({category:"top-navigation",action:"searched",label:e?"search":"suggestions-bar"}),setTimeout(function(){e?panda.goPage(f.filter(".on").find(".js-search-link").getHref()):o.attr("action",o.getHref()+d).submit()},300)}g<0||b!==v&&b!==u||(c+=b===v?1:-1,c<-1?c=h:c>h&&(c=-1),f.removeClass("on"),c>-1&&f.filter(function(a){return a===c}).addClass("on"))},loadSearchResult:function(a){var g=$(this),h=g.getHref(),i=a?a.keyCode:-1,j=i===v||i===u||panda.isEnter(a);j&&panda.stopEvent(a),a&&(a.metaKey||a.ctrlKey)&&86===i||setTimeout(function(){var g=p.val().replace(/^\s+/g,"").replace(/\s{2,}/," ");if(j)return f.keyboardUpDownEvent(a,i,g);g!==p.data("prevVal")&&(clearTimeout(b),p.data("prevVal",g),b=setTimeout(function(){g.length>0?(panda.isRunning()&&d&&(d.abort(),panda.stopRunning()),e=g,d=$.getJSON(h,{query:g},function(a){e===a.data.query&&(c=-1,s.html(a.data.body))})):B()},10))},1)},loadReadingList:function(a){var b=a.find(".js-nav-btn"),c=b.getHref();q.data("isLoad")||$.getJSON(c,{},function(a){q.html(a.data.body).data("isLoad",!0).next().removeClass("hidden").find(".js-link").addClass("hidden").filter(a.data.reading_list_cnt>0?".js-reading-list":".js-browse").removeClass("hidden");var b=$(".js-reading-list-sc-wrap");b.isExists()&&(panda.require("fn.tinyscrollbar",b,{axis:"y"}),panda.require("fn.lazyLoadVertical",b))})},loadActivities:function(a){var b=a.find(".js-nav-btn"),c=b.getHref(),d=b.parent();r.data("isLoad")||(d.data("hasCount")&&$.putJSON("/activities/mark-counts",function(){b.find(".js-notice-count").text(0).addClass("hidden"),d.data("hasCount",!1)}),$.getJSON(c,{},function(a){r.html(a.data).data("isLoad",!0);var b=$(".js-activies-sc-wrap");b.isExists()&&(panda.require("fn.tinyscrollbar",b,{axis:"y"}),panda.require("fn.lazyLoadVertical",b),d.data("canMarkAll",b.find(".js-item.mod-unread").length>0))}))}}},panda.namespace("pages"),panda.pages.home=function(){var a,b={};return b={init:function(){return a=panda.require("pages.fn"),$(".tp-carousel").each(function(a,b){panda.require("fn.carousel",{$el:$(b)})}),b.setEvents(),b},setEvents:function(){a.tieHoverStatus(),$(".js-desc-tip").tooltip({title:"Comic ranking is based on likes, shares, views, comments, and new subscribers today",placement:"bottom",trigger:"click hover"})}}},panda.pages.browse=function(){var a,b,c={},d=$(".filter-item"),e=$(".item-title",d),f=$(".sort-item"),g=$(".item-title",f);return c={init:function(){return b=panda.require("pages.fn"),a=panda.require("fn.dropdown",$(".js-dropdown-wrap"),c.searchSeries),c.setEvents(),c},setEvents:function(){b.tieHoverStatus(),a.setOption(),e.on("click",c.switchTap),g.on("click",b.passSortCB(c.searchSeries).sortBy),$(".js-desc-tip").tooltip({title:"Comic ranking is based on likes, shares, views, comments, and new subscribers today",placement:"bottom",trigger:"click hover"})},switchTap:function(a){panda.stopEvent(a);var b=$(this),c=b.getHref(),d=$(".js-dropdown").data("type");c+=""!==d?"&genre="+d:"",panda.goPage(c)},searchSeries:function(a){panda.stopEvent(a);var b=f.filter(".on").children().getHref(),c=$(".js-dropdown").data("type"),e=d.filter(".on"),g=e.data("type");b=""===b?e.children().getHref():b+"&browse="+g,b+=""!==c&&"all"!==c?"&genre="+c:"",panda.goPage(b)}}},panda.pages.collection=function(){var a,b,c={},d=$(".item-title");return c={init:function(d){return a=d.from,b=panda.require("pages.fn"),c.setEvents(),c},setEvents:function(){return b.tieHoverStatus(),d.on("click",b.passSortCB(c.searchCollection).sortBy),panda.require("fn.carousel",{$el:$(".tp-carousel")}),"info"===a&&($(".more-link").on("click",c.toggleDesc),c.loadTrunk()),c},searchCollection:function(){var a=$(".sort-item").filter(".on");panda.goPage(a.children().getHref())},loadTrunk:function(){$(".trunk-target").trunk8({tooltip:!1,lines:2})},toggleDesc:function(a){panda.stopEvent(a);var b=$(this);b.hasClass("less")?b.removeClass("less").prev().removeClass("expend").trunk8({tooltip:!1,lines:2}):b.addClass("less").prev().addClass("expend").trunk8("revert")}}},panda.pages.creator=function(){var a,b={},c=$(".filter-item"),d=$(".item-title",c),e=$(".sort-item"),f=$(".item-title",e);return b={init:function(){return a=panda.require("pages.fn"),b.setEvents(),b},setEvents:function(){panda.initTooltip(),a.tieHoverStatus(),d.on("click",a.passSortCB(b.searchCreator).sortBy),f.on("click",a.passSortCB(b.searchCreator).sortBy)},searchCreator:function(){var a=e.filter(".on"),b=a.children().getHref();panda.goPage(b)}}},panda.pages.readinglist=function(){var a,b={},c=$(".filter-item"),d=$(".item-title",c),e=$(".sort-item"),f=$(".item-title",e),g=$(".js-markall-btn"),h=$(".content-list-wrap");return b={init:function(){return a=panda.require("pages.fn"),h.length>0&&!$(".js-activate-bar").isExists()&&panda.require("pushMessage.main"),b.setEvents(),b},setEvents:function(){panda.initTooltip(),a.tieHoverStatus(),d.on("click",a.passSortCB(b.searchSubscription).sortBy),f.on("click",a.passSortCB(b.searchSubscription).sortBy),g.on("click",b.updateAllRead)},searchSubscription:function(){var a=c.filter(".on"),b=e.filter(".on"),d=b.children().getHref()+"&type="+a.data("type");panda.goPage(d)},updateAllRead:function(a){panda.stopEvent(a);var c=$(this);$.putJSON(c.getHref(),function(a){var c=a.data.success;panda.showGlobalMessage(c?"Marked all read.":"Failed to mark all read."),c&&b.searchSubscription()})}}},panda.pages.search=function(){var a,b={},c=$(".js-search-form"),d=$(".js-search-query"),e=$(".js-search-btn");return b={init:function(){$("#from").val(document.location.href),d.on("keydown",b.changeIcon),e.on("click",function(a){panda.stopEvent(a),c.submit()})},changeIcon:function(){a=setTimeout(function(){a&&clearTimeout(a),e.toggleClass("on",d.val().length>0)},1)}}},panda.pages.embedcomics=function(){return{init:function(a,b,c){var d=[];if("v2"===b){var e,f=function(){var b=$(".episode-body-v2").height();window.parent.postMessage({id:a,height:b,isOverlay:c,from:"tapas-embed"},"*")},g=function(a){var b=a.originalEvent.data;if(b.rgba){var c=$(".episode-body-v2");if(c.hasClass("embed-cropped")&&0===c.find(".embed-gradient").length){var d=$('<div class="embed-gradient">');d.css("background-image",function(){return"linear-gradient(to bottom, rgba(0, 0, 0, 0), "+b.rgba+")"}),c.append(d)}}};$(window).resize(function(){clearTimeout(e),e=setTimeout(f,1e3)}),$(window).load(f),$(window).on("message",g)}else panda.require("fn.shares",$(".share-btn"));c||panda.require("fn.lazyLoad"),parent&&parent!==parent.parent||(document.referrer.length>0&&d.push(document.referrer),navigator.userAgent&&d.push(navigator.userAgent),d.length>0&&$.postJSON(panda.arrayToMakeUrl(["embed","popular",a]),{referrers:d.join(","),isPlain:!0}))}}},panda.pages.about=function(){var a={},b=$(".js-team-img"),c=$(".js-story"),d=$(".js-page-dot"),e=$(".js-page-item.first"),f=$(".js-page-item.last"),g=$(".js-page-item"),h=d.length,i=function(){var a=$(this),b=a.find("i"),c=b.data("alter"),d=b.attr("class"),e=a.next().find("p:last-child"),f=e.data("special"),g=e.text();b.removeClass().addClass(c).data("alter",d),e.text(f).data("special",g).toggleClass("on",!e.hasClass("on"))},j=function(a){var b=$(".js-news-item-"+a);$(".js-news").addClass("hidden").filter(b).removeClass("hidden")},k=function(a){panda.stopEvent(a);var b=$(this),c=b.data("idx");d.filter("[data-idx="+c+"]").hasClass("active")||(d.removeClass("active").filter("[data-idx="+c+"]").addClass("active"),0===c?(e.removeClass("active"),f.addClass("active")):c===h-1?(e.addClass("active"),f.removeClass("active")):(e.addClass("active"),f.addClass("active")),j(c))},l=function(a){panda.stopEvent(a);var b=$(this),c=$(".js-page-dot.active"),d=c.data("idx");if(b.hasClass("first")){if(0===d)return;var g=c.prev(),i=g.data("idx");b.toggleClass("active",0!==i),f.addClass("active"),g.click()}else{if(d===h-1)return;var j=c.next(),k=j.data("idx");b.toggleClass("active",k!==h-1),e.addClass("active"),j.click()}},m=function(){c.each(function(){var a=$(this),b=a.find("a").attr("href");a.find("p").on("click",function(){window.open(b,"_blank")})})};return a={init:function(){var b=panda.require("fn.dockedMenu");return $(window).load(function(){b.refreshPositions()}),a.setEvent(),a},setEvent:function(){b.on("mouseenter mouseleave",i),m(),d.on("click",k),g.on("click",l)}}},panda.pages.faq=function(){var a,b={},c=$(window);return b={init:function(){a=panda.require("fn.dockedMenu"),c.on("resize",function(){setTimeout(function(){a.refreshPositions()},500)});var d=window.location.hash;if(d){var e=$(d);e.isExists()||(e=$("#qa-"+d.slice(1)),e.isExists()&&setTimeout(function(){panda.goToTop(!1,e.offset().top-$(".shortcut-nav").height()),e.parent().click()},500))}$(".js-line").on("click",b.toggleAnswer),$(".js-per-link").on("click",b.tabPermaLink)},tabPermaLink:function(b){panda.stopEvent(b);var c=$(this),d=c.attr("href").replace("#","");d&&(location.hash=d),setTimeout(function(){a.refreshPositions()},500)},toggleAnswer:function(a){panda.stopEvent(a);var b=$(this);b.toggleClass("active",!b.hasClass("active"))}}},panda.pages.userLists=function(){return{init:function(){panda.require("pages.fn")}}},panda.pages.userHome=function(){var a,b,c,d,e,f={},g=$("#profile-page"),h=$(".desc-proxy-wrap"),i=$(window),j=0;return f={init:function(a,h,j,k,l,m,n,o){d=j,e=panda.require("pages.fn"),i.unload(function(){document.body.scrollTop=0}),document.documentElement.scrollTop=0,f.refreshPositions(),i.on("resize",function(){clearTimeout(c),c=setTimeout(function(){f.refreshPositions()},10)}).trigger("scroll"),f.initDescWrap(),b=panda.require("fn.tinyscrollbar",g.find(".scrollbar-wrap"),{axis:"y"}),panda.require("wall.main",a,h,d,k,m,n);var p=panda.require("tip.main");o&&p.showPopupByCall(),l&&setTimeout(function(){var a=$("a.js-post-"+l);a&&a.click()},300),$(".custom-tooltip").tooltip({container:$("#page-wrap")})},initDescWrap:function(){var a=h.find(".desc"),b=h.find(".desc-proxy");b.height()<a.height()?b.next().removeClass("hidden").on("click",function(a){panda.stopEvent(a),$(this).addClass("hidden").next().removeClass("hidden"),b.removeClass("effect"),f.refreshPositions()}).next().on("click",function(a){panda.stopEvent(a),$(this).addClass("hidden").prev().removeClass("hidden"),b.addClass("effect"),f.refreshPositions()}):b.removeClass("effect")},refreshPositions:function(){return a=window.innerHeight||document.documentElement.clientHeight,j=0===g.css("z-index")?130:$(".main",g).offset().top,b&&b.update("relative"),f}}},panda.pages.activities=function(){var a,b,c={},d=$(".filter-item"),e=$(".item-title",d),f=$(".mark-read-btn");return c={init:function(){return b=panda.require("pages.fn"),a=panda.require("fn.dropdown",$(".js-dropdown-wrap"),c.search),c.setEvents(),c},setEvents:function(){c.read(),a.setOption(),e.on("click",b.passSortCB(c.search).sortBy),f.on("click",c.markAsRead);var d=$(".js-mark-all",".activity-page").on("click",function(a){panda.stopEvent(a),d.data("hasUnreadItems")&&(d.data("hasUnreadItems",!1),panda.common.initiation.markAll.apply($(".js-mark-all",".activity-page"),[a,!0]),$(".js-mark-read-btn").remove())});d.data("hasUnreadItems",$(".item.mod-unread",".activity-page").length>0)},read:function(){$("a.activity").on("click",function(){panda.common.initiation.markViewedActivity.apply($(this),[$(this).data("id")])})},markAsRead:function(a){panda.stopEvent(a);var b=$(this),c="all"===$(".dropdown-option.hidden").data("type"),d=function(){c?(b.parent().removeClass("mod-unread"),b.remove()):b.parent().remove()};panda.common.initiation.markViewedActivity.apply($(this),[$(this).data("id"),d])},search:function(a){panda.stopEvent(a);var b=$(".dropdown-option.hidden > a"),c=b.getHref(),d=$(".filter-item.on > a"),e=pInt(d.data("kind"));c+=e>-1?(-1!==c.indexOf("?")?"&":"?")+"kind="+e:"",panda.goPage(c)}}},panda.pages.creatorPage=function(){var a,b={},c=$(window),d=$(".shortcut-nav-btn"),e=$(".upload-btn"),f=$(".jump-down-btn"),g=$(".publish-section .grow-btns a"),h=$(".publish-section figure"),i=$(".publish-section .earn-btns a");return b={init:function(){a=panda.require("fn.dockedMenu",b.callbackDockedMenu),c.load(function(){a.refreshPositions()}),b.setEvents()},setEvents:function(){f.on("click",b.jumpDown),e.on("click",b.getStarted),g.on("click",b.changeGrowSectionFigure),i.on("click",b.changeEarnSectionCard)},changeGrowSectionFigure:function(a){panda.stopEvent(a);var b=$(this),c=b.getHref();$(".grow-btns-wrap").find("li.grow-btn").removeClass("on").filter(b.parent()).addClass("on"),h.find(".js-fig").addClass("hidden").filter("."+c).removeClass("hidden"),h.find("figcaption").text(b.data("caption"))},changeEarnSectionCard:function(a){panda.stopEvent(a);var b=$(this),c=b.getHref();$(".earn-btns").find("li.earn-btn").removeClass("on").filter(b.parent()).addClass("on"),$(".earn-section-card-wrap").addClass("hidden"),$(".earn-section-card-wrap."+c+"-wrap").removeClass("hidden")},jumpDown:function(a){panda.stopEvent(a),$(".shortcut-item a:first").click()},getStarted:function(a){$(this).hasClass("have-to-sign")||(panda.stopEvent(a),panda.goPage("/dashboard"))},callbackDockedMenu:function(a){d.toggleClass("hidden",!a)}}},panda.pages.publisherDashboard=function(){return{init:function(){$('[data-toggle="tooltip"]').tooltip(),$(".sign-in .txt").on("keyup",function(){var a=0===$(this).val().length;$(this).parent().toggleClass("js-not-empty",!a)}),$(".js-dropdown-toggle").on("click",function(){$(this).parent().toggleClass("on")})}}},panda.pages.fn=function(){var a,b={};return b={init:function(){return b},passSortCB:function(c){return a=c,b},tieHoverStatus:function(){panda.isDesktop()&&$(".title").on("mouseenter",function(){$(this).parent().addClass("in")}).on("mouseleave",function(){$(this).parent().removeClass("in")})},sortBy:function(b){panda.stopEvent(b);var c=$(this),d=c.parent().parent();c.parent().hasClass("on")||(d.find("li").removeClass("on").filter(c.parent()).addClass("on"),panda.callback(a),a={})}}},panda.namespace("wall"),panda.wall.main=function(){var a,b,c,d,e,f,g={},h=$("#wall-streams"),i=$("#loading-indicator"),j=$(".comment-type-wrap"),k=panda.require("fn.scrollLoader",h),l=panda.getEnvs("isMobileView"),m={},n=674;return g={init:function(i,j,k,m,n,o){a=i,b=k,d=panda.require("fn.fileUploadToS3"),e=panda.require("wall.reporting"),f=panda.require("fn.showDoneIt"),n&&""!==n?f.showMessage("Blocked "+n):o&&""!==o&&f.showMessage("Unblocked "+n),h.data("isExistNextPage")&&h.on("scroll.loader.load",g.loadWallStreams),$(".js-block-option").on("click tap","a",g.toggleFilterOption).on("click tap",".js-block-user",e.openBlockPopup).on("click tap",".js-unblock-user",e.openUnblockPopup),$(".js-comment-filter-btn").on("click tap",g.toggleCommentFilter);var p=$(".wall.comment-section");return $(".auto-link").autoLink(),l?p.on("click tap",".have-to-sign",function(a){panda.stopEvent(a),panda.account.signin.load.call(this)}):g.tooltipNotify($(".notify-subscribers")),p.on("change",".js-file-input",g.uploadImage).on("keydown",".comment-body",g.activateSubmit).on("click tap",".delete-image",g.deleteImage).on("click tap",".post-btn",g.savePost).on("click tap",".open-reply",g.openReplyBox).on("click tap",".edit-comment",g.editComment).on("click tap",".manage-option > a",g.toggleFilterOption).on("click tap",".edit-post",g.editPost).on("click tap",".delete-post",g.deletePost).on("click tap",".delete-comment",g.deleteComment).on("click tap",".more-comments",g.loadAllComments).on("click tap",".notify-subscribers",g.setNotify).on("click tap",".js-block-user",e.openBlockPopup).on("change",".private-message-checkbox",function(){var a=$(this),b=a.is(":checked"),d=a.closest(".input-outer"),e=d.find(".post-btn"),f=b?"send":"share",g=a.data("$commentBody");e.text(a.data("isEditing")?"save":f),g||(g=d.find(".comment-body"),a.data("$commentBody",g)),c||(c=g.attr("placeholder")),g.attr("placeholder",b?g.data("placeholderPm"):c)}),$("textarea.comment-body").autogrow().trigger("keydown"),g.moveToFanComment(j),m&&setTimeout(function(){panda.alert({body:"Sorry, that post no longer exists."})},300),g},moveToFanComment:function(a){if(a){var b,c=$("#fan-comment-"+a);c.isExists()&&setTimeout(function(){b=function(){c.css({backgroundColor:"#FFFFDD"}).animate({backgroundColor:"#FFFFFF"},1e3)},panda.isInViewPort(c[0],-1*c.height())?b():panda.goToTop(!1,c.offset().top-70,b)},500)}},activateSubmit:function(){var a,b=$(this),c=b.closest(".input-outer"),d=c.find(".post-btn");setTimeout(function(){a=!$.trim(b.val()).length,d.prop("disabled",a&&!g.hasImage(b))},1)},activateSubmitForReply:function(a){var b,c=$(this),d=a.data.btn;setTimeout(function(){b=!$.trim(c.val()).length,d.toggleClass("disabled",b)},1)},hasImage:function(a){var b=m[g.getPostId(a)];return!$.isEmptyObject(b)},getPostId:function(a){var b=a.data("postId");return b||(b=a.closest(".comment-stream").data("postId")||"emptyPostId",a.data("postId",b)),b},openReplyBox:function(a){panda.stopEvent(a);var b=$(this),c=b.closest(".comment-stream"),d=panda.templateCompile("tpReply",{body:"",label:c.hasClass("private")?"send":"post"}),e=$(".reply-body",d);$(".cancel-reply",d).on("click",function(a){panda.stopEvent(a),b.removeClass("hidden").next().remove(),e.removeWithAutogrow()}),b.addClass("hidden").parent().append(d.removeClass("hidden"));var f;if(l){var h=$(".save-reply",d).on("click tap",function(){g.saveComment(e)});e.on("keydown",{btn:h},g.activateSubmitForReply)}else f={notAllowEnter:!0,enterFn:g.saveComment};e.autogrow(f).focus()},editComment:function(a){panda.stopEvent(a);var b,c=$(this),d=c.closest(".body-header").next(),e={body:$.trim(d.text()),id:c.closest(".comment-filters").data("commentId")},f=panda.templateCompile("tpEditCommentBody",e),h=f.find(".edit-body");if(d.hasClass("hidden"))return!1;var i;if(l){var j=$(".save-edit",f).on("click tap",function(){g.updateComment(h)});h.on("keydown",{btn:j},g.activateSubmitForReply)}else i={notAllowEnter:!0,enterFn:g.updateComment};b=d.addClass("hidden").parent().append(f).closest(".reply-streams").addClass("editing"),h.autogrow(i).focus(),$(".cancel-edit",f).on("click tap",function(a){panda.stopEvent(a),d.removeClass("hidden"),f.removeWithAutogrow(),b.removeClass("editing")})},updateComment:function(a){if($.trim(a.val())){var b={comment:a.val(),isPlain:!0};$.postJSON(a.getHref(),b,function(b){200===b.code?a.closest(".reply-stream").replaceWith(b.data.body).removeClass("editing"):panda.alert({body:b.data.errors[0].message})})}else a.val("")},getInputOuter:function(){var a=h.hasClass("individual"),b=a?panda.templateCompile("writeBox"):$(".write-box.top"),c=b.find(".input-outer"),d=c.find(".notify-subscribers");return d&&d.removeClass("selected").data("notify",!1),a?c:c.clone()},editPost:function(a){panda.stopEvent(a,!1);var b,c,d,e=$(this),f=e.closest(".parent-body-wrap"),h=e.closest(".comment-stream"),i=f.find(".preview-wrap"),j=i.children().length>0,k=g.getInputOuter(),n=k.find("textarea"),o=h.data("accessAuth"),p="PRIVATE"===o,q=g.getPostId(e);if(k.find(".g-recaptcha").remove(),h.addClass("editing write-box"),k.find(".notify-subscribers").addClass("hidden"),k.find(".cancel-btn").removeClass("hidden"),k.find(".post-btn").data("href","#!/artist-post/update/"+q),n.val($.trim(f.find(".comment-txt").text())),k.find(".cancel-btn").click(function(a){panda.stopEvent(a),h.removeClass("editing"),n.removeWithAutogrow(),h.find(".input-outer").remove(),c.removeClass("hidden")}),c=h.children(".avatar-wrap"),l&&c.addClass("hidden"),c.after(k),b=k.find(".private-message-checkbox").appendAttrValue("id",q).appendAttrValue("data-comment-body-id",q).prop("checked",p).data("isEditing",!0).trigger("change"),b.next().appendAttrValue("for",q),j){var r=k.find(".preview-wrap");r.removeClass("hidden"),r.html(i.html()),d=r.find(".preview").addClass("thumb").data("fileName");var s=i.find(".preview");m[q]={file:JSON.stringify(s.data("fileJson").file)},g.toggleImageUploadButtons(k.find(".actions-wrap"),!1,d)}n.autogrow().trigger("keydown").focus()},toggleFilterOption:function(a){var b=$(this),c=b.parent(),d="click.closed";c.toggleClass("on"),panda.stopEvent(a),l&&(d="tap.closed"),c.hasClass("on")?$(window).one(d,function(){c.removeClass("on")}):$(window).off(d)},toggleCommentFilter:function(a){panda.stopEvent(a);var b=$(this).parent();if(j.isExists()){j.find("li").removeClass("on").filter(b).addClass("on"),g.searchPost(b)}},searchPost:function(a){var b=a.find("a"),c=b.data("type");h.empty().data("pageNum",1),i.removeClass("hidden"),g.__loadWallStreams({type:c})},deleteComment:function(a){panda.stopEvent(a);var b=$(this);panda.alert({title:"confirmation",body:"Are you sure you want to delete this comment?",isConfirm:!0,cb:function(){$.postJSON(b.getHref(),{isPlain:!0},function(a){if(200===a.code){var c=$(b.data("parentId")),d=c.parent();1===d.children().length&&d.next().find("a.depth").removeClass("depth"),c.remove(),g.updateCommentCnt(d,-1)}})}})},updatePostCount:function(a,b){var c=$(".js-post-"+a);if(a&&c.isExists()){var d=c.find("span");if(d.isExists()){var e=pInt(d.text())+b;e<1?d.remove():d.text(e)}else c.append("<span>"+b+"</span>")}},updateCommentCnt:function(a,b){var c,d,e=a.closest(".reply-streams").prev();e.hasClass("paging-header")&&(c=e.find(">.more-comments"),d=c.data("totalCommentCount"),d+=b,c.data("totalCommentCount",d).find(".txt").text(d+" "+panda.makePlural("comment",d)))},loadAllComments:function(a){panda.stopEvent(a);var b=$(this),c=b.parent(),d=c.next(),e=c.hasClass("expend");b.data("isLoaded")?($(".can-hidden",d).toggleClass("hidden",e),c.toggleClass("expend")):$.get(b.getHref(),{},function(a){200===a.code&&(d.prepend(g.makingAutoLink(a.data.html)),b.data("isLoaded",!0),c.toggleClass("expend"))})},deletePost:function(a){panda.stopEvent(a);var b=$(this);panda.alert({title:"confirmation",body:"Are you sure you want to delete this post?",isConfirm:!0,cb:function(){$.postJSON(b.getHref(),{isPlain:!0},function(a){200===a.code&&($(b.data("postId")).remove(),g.updatePostCount(a.data.element_label,-1))})}})},saveComment:function(a){if($.trim(a.val())){var b={comment:a.val(),isPlain:!0};$.postJSON(a.getHref()+g.getPostId(a),b,function(b){if(200===b.code){a.val("").trigger("keydown");var c=a.closest(".body-wrap").find(".reply-streams").append(b.data.body);g.updateCommentCnt(c,1),a.closest(".reply-write-wrap").find(".open-reply").replaceClass("hidden","depth"),a.removeWithAutogrow().closest(".reply-write").remove()}else panda.alert({body:b.data.errors[0].message})})}else a.val("")},savePost:function(b){panda.stopEvent(b);var c=$(this),d=-1!==c.getHref().indexOf("update"),e=c.closest(".input-outer"),f=e.find("textarea"),i=m[g.getPostId(c)],j=e.find(".private-message-checkbox"),k=j.is(":checked"),l=e.find(".audience-dropdown .top"),n=e.find(".notify-subscribers"),o=$('[name="g-recaptcha-response"]'),p=function(){return k?"PRIVATE":l.data("accessAuth")}(),q={post:$.trim(f.val()),isPlain:!0,"user.id":a,accessAuth:p,gRecaptchaResponse:o?o.val():null,notifySubscribers:n.data("notify")};if(g.hasImage(c))q.file=i.file;else if(!q.post)return;$.postJSON(c.getHref(),q,function(a){if(200===a.code){if(d){var b=g.getPostId(c);f.removeWithAutogrow(),$("#wall-stream-"+b).replaceWith(a.data.body)}else h.prepend(g.makingAutoLink(a.data.body)),0===parseInt(h.data("postCount"))&&h.find(".js-no-post").remove(),g.deleteImage.call(e.find(".delete-image")),f.val("").trigger("keydown"),j.prop("checked",!1).trigger("change"),c.blur(),g.updatePostCount(a.data.element_label,1),"undefined"!=typeof grecaptcha&&grecaptcha.reset();k&&g.mpTracking()}else panda.alert({body:a.data.errors[0].message})})},toggleImageUploadButtons:function(a,b,c){var d=a.hasClass(".actions-wrap")?a:a.closest(".actions-wrap"),e=d.find(".image-upload-btn"),f=d.find(".delete-image");e.toggleClass("hidden",!b),f.parent().toggleClass("hidden",b),c&&(l||f.tooltip({placement:"bottom",trigger:"hover",title:c,container:".main"}))},deleteImage:function(a){panda.stopEvent(a);var b=$(this),c=b.closest(".input-outer"),d=c.find(".preview");g.toggleImageUploadButtons(b,!0),d.attr("src",blankImgSrc).closest("div").addClass("hidden"),m[g.getPostId(b)]={},c.find(".comment-body").trigger("keydown")},uploadImage:function(a){panda.stopEvent(a);var b=$(this),c=b.data("type"),e=g.getPostId(b),f=!1,h=b.closest(".input-outer"),i=h.find(".preview"),j=function(a){f||i.attr("src",a.s3.url),i.siblings().remove(),i.removeClass("fadeout"),g.toggleImageUploadButtons(b,!1,a.filename),m[e]={file:JSON.stringify(a)},h.find(".comment-body").trigger("keydown")},k=function(){i.closest("div").addClass("hidden"),panda.setBlankImage(i),panda.cleanUpFileInput(b)};if(""!==b.val().trim()){if(d.uploadToR(c,{files:this.files[0]},j,{errorCallback:k}),m[e]={},void 0!==window.FileReader){var l=new FileReader;l.onload=function(a){i.attr("src",a.target.result).addClass("fadeout"),f=!0},l.readAsDataURL(this.files[0])}panda.setBlankImage(i).closest("div").removeClass("hidden").append('<div class="spinner"/>')}},loadWallStreams:function(){i.removeClass("hidden");var a=j.find("li.on > a");g.__loadWallStreams({type:a.data("type")})},__loadWallStreams:function(a){var b=h,c={pageNumber:b.data("pageNum"),pageSize:b.data("pageSize")};a&&(c.type=a.type),$.getJSON(b.getHref(),c,function(a){k.callback();var c=a.data;c.html?(h.append(g.makingAutoLink(a.data.html)),b.off("scroll.loader.load",g.loadWallStreams),c.is_exist_next_page?(b.on("scroll.loader.load",g.loadWallStreams),b.data("pageNum",a.data.next_page_number),k.resume()):k.release()):k.release(),i.addClass("hidden")})},makingAutoLink:function(a){var b=$(a);try{b.find(".auto-link").autoLink()}catch(c){panda.log(c),panda.log("makingAutoLink")}return b},mpTracking:function(){panda.addAmplitudeEvent("private message",{at:l?"mobile-wall":"wall",uname:b})},setNotify:function(a){panda.stopEvent(a);var b=$(this),c=b.data("notify"),d="sp-ico-noti",e="sp-ico-noti-on";if(c?b.find("i").replaceClass(e,d):b.find("i").replaceClass(d,e),b.data("notify",!c),!l){var f=b.data("notify")?"on":"off",h=g.getNotifyTooltipTitle(f);b.data("originalTitle",h).tooltip("update")}},tooltipNotify:function(a){var b=a.data("notify")?"on":"off";a.tooltip({placement:"bottom",trigger:"hover",title:g.getNotifyTooltipTitle(b),html:!0})},getNotifyTooltipTitle:function(b){return'<span class="notify-desc">notify '+(n===a?"followers":"subscribers")+'</span><br><span class="notify-status">'+b+"</span>"}}},panda.wall.reporting=function(){var a={};return a={init:function(){return a},openBlockPopup:function(a){panda.stopEvent(a);var b=$(this),c=b.data("uid"),d={id:c,userName:b.data("uname")},e=b.data("returnUrl"),f=panda.templateCompile("tpUserReport",d),g=$(".js-reporting-btn",f),h=function(){var a=f.find("textarea").val().trim();return 1===f.find(".p-radio:checked").length&&a.length<=f.find(".js-words").data("limit")};$(".p-radio",f).on("change",function(){g.toggleClass("disabled",!h())}),$("textarea",f).on("input",function(){var a=$(this),b=a.next(),c=b.find(".js-words").data("limit"),d=$(this).val().trim(),e=d.length;b.find(".js-words").text(e),b.toggleClass("error",e>c),g.toggleClass("disabled",!h())}),g.on("click tap",function(a){if(panda.stopEvent(a),!$(this).hasClass("disabled")){var b=$("#blocked-report-form",f),d={isPlain:!0};$.each(b.serializeArray(),function(a,b){d[b.name]=b.value}),$(this).addClass("loading"),c?$.postJSON(b.getHref(),d,function(){panda.goPage(e)}):panda.goPage(e)}}),pInt(d.id)>0&&panda.showOverlay(f,!0)},openUnblockPopup:function(a){panda.stopEvent(a);var b=$(this),c=b.data("uid"),d={id:c,userName:b.data("uname")},e=b.data("returnUrl"),f=panda.showOverlay(panda.templateCompile("tpUnblockUser",d),!0);$(".js-unblock-btn",f).on("click",function(a){panda.stopEvent(a),c?$.deleteJSON($(this).getHref(),{},function(){panda.goPage(e)}):panda.goPage(e)})}}},panda.namespace("account");var __account={keydownDelayTime:500,immediatelyTime:0,urls:{popup:"/account/sign",validate:"/account/validate_email",welcome:"/account/welcome",activate:"/account/activate",resend:"/account/resend-email",refreshAuthorities:"/account/refresh-author"},addAnimation:function(a,b){a.one("rendered",function(){a.addClass(b)})}};panda.account.resetPassword=function(){var a={},b=!1,c=$("#verifyPassword"),d=panda.require("fn.validation",c);return a={init:function(){return $(".js-validate").keydown(function(){var a=$(this),c=a.data("timeoutId");c&&clearTimeout(c),c=setTimeout(function(){b=d.verifyPassword.call(a)},300),a.data("timeoutId",c)}),$(".js-submit").on("click",a.submit),a},submit:function(a){if(panda.stopEvent(a),!b||0===c.val().trim().length)return $(".js-error").find("p").text("Passwords do not match."),!1;this.form.submit()}}},panda.account.welcome=function(){return{init:function(){$.getJSON(__account.urls.welcome,function(a){var b=$(a.data.html);__account.addAnimation(b,"slideUp"),panda.showOverlay(b,!0)})}}},panda.account.signin=function(){var a,b={},c=".js-sign-prompt",d={COMMENT:"comment|wall|reply",LIKE:"like|thumbs",SUBSCRIBE:"subscription|subscribe",UPLOAD:"dashboard",NSFW:"nsfw",PUBLISHER:"publisher-dashboard",TIP:"tip"};return b={init:function(){$("body").on("click",".have-to-sign[data-permalink]",function(a){b.load.call(this,a,$(this).data("permalink"))}),$(".js-social-connect").on("click",b.socialConnect),$(".js-sign-page").on("click",".js-effect-btn",b.toggleSignup).on("click",".js-show-password",b.togglePassword);var a=$(c);return a.hasClass("popup")||b.setEvents(a),b},socialConnect:function(b){if(panda.stopEvent(b),panda.isRunning()||$(this).attr("disabled"))return!1;panda.startRunning();var c=$(this),d=c.data("from"),e=c.data("kind"),f=c.getHref(),g=panda.getActionFormSubmit();"facebook"===e&&g.appendHiddenField({name:"scope",value:"email"}).appendHiddenField({name:"display",value:"popup"}),"google"===e&&g.appendHiddenField({name:"scope",value:"https://www.googleapis.com/auth/plus.profile.emails.read"}).appendHiddenField({name:"display",value:"popup"}),a=d||$("#from").val(),panda.openPopup({url:"about:blank",title:e,width:800,height:435}),$.postJSON("/account/set-signup-where",{isPlain:!0,where:c.data("where")}),setTimeout(function(){panda.stopRunning()},3e3),g.appendHiddenField({name:"from",value:a}).attr({target:e,method:"POST",action:f}).submit()},sign:function(){$(this).appendHiddenField({name:"offsetTime",value:panda.getTimezoneOffset()})},load:function(c,e){panda.stopEvent(c);var f=$(this),g=__account.urls.popup,h="DEFAULT",i=f.data("where");e+=f.getHref(),a=$("#from").val(),f.data("permalink")&&(a=f.data("permalink")),$.each(d,function(a,b){new RegExp(b).test(e)&&(h=a)});var j={from:a,action:h,where:i};$.getJSON(g,j,function(a){var c=$(a.data.html);c.one("rendered",function(){c.addClass("bigEntrance"),b.setEventsForPopup($(this))}),panda.showOverlay(c,!0)})},setEvents:function(a){a.on("keydown paste cut",".js-txt",function(){setTimeout(function(){b.toggleLoginButtons(a)},1)}).on("submit",".js-sign-form",b.sign),a.find(".js-focus").focus()},setEventsForPopup:function(a){a.on("click",".js-social-connect",b.socialConnect).on("click",".js-effect-btn",b.toggleSignup).on("click",".js-close-btn",b.closeSignPromptPopup).on("click",".js-show-password",b.togglePassword),b.setEvents(a)},togglePassword:function(a){panda.stopEvent(a);var b=$(this),c=b.next().val();b.toggleClass("on");var d=b.hasClass("on")?"sp-field-showpw":"sp-field-hidepw",e=b.hasClass("on")?"sp-field-hidepw":"sp-field-showpw";b.find("i").replaceClass(d,e);var f=$('<input type="text" name="password" placeholder="password" maxlength="100" class="sign-input-text mod-padding js-txt">').val(c),g=$('<input type="password" name="password" placeholder="password" maxlength="100" class="sign-input-text mod-padding js-txt">').val(c);b.next().remove(),b.after(b.hasClass("on")?f:g)},toggleLoginButtons:function(a){if(a.find(".js-social-connect").length>0){var b=!0;$(".js-txt").each(function(){b=b&&this.value.length>0}),a.find(".js-submit").toggleClass("shaded",b)}},toggleSignup:function(a){panda.stopEvent(a);var b=$(".js-sign-prompt").isExists(),c=b?$(".js-sign-prompt"):$(".js-sign-page"),d=$(this),e=d.data("target"),f=c.find(".js-sign-module").filter(e);c.find(".js-sign-module").removeClass("on").addClass("hidden").filter(e).removeClass("hidden"),c.find(".js-txt").val(""),setTimeout(function(){f.addClass("on"),f.find(".js-focus").focus()},100)},closeSignPromptPopup:function(a){panda.stopEvent(a),panda.hideOverlay()}}},panda.account.activate=function(){var a,b={};return b={init:function(){return a=panda.require("account.resendEmail"),b},open:function(){$.getJSON(__account.urls.activate,function(b){var c=$(b.data.html);c.find(".js-close-btn").click(panda.hideOverlay),c.find(".js-resend-email").on("click",function(b){panda.stopEvent(b),panda.hideOverlay(),setTimeout(function(){a.open(b)},300)}),__account.addAnimation(c,"slideUp"),panda.showOverlay(c,!0)})}}},panda.account.saveEmail=function(){var a,b,c,d={},e=$(".js-butter-bar");return d={init:function(){return d.setEvents(),d},setEvents:function(){$(".js-save-email").on("click",d.saveEmail),a=$(".js-input-email").on("keydown",d.validate).data("hasError",!0),b=$(".js-input-wrap").find(".js-error-wrap"),$(".js-close-error").on("click",d.closeErrorBar)},saveEmail:function(c){panda.stopEvent(c);var d=$(this);if(a.data("hasError")||""===a.val())return!0;$.postJSON(d.getHref(),{pendingEmail:a.val(),isPlain:!0,isSkipCommonAlert:!0},function(c){if(200===c.code){var d=$(".js-before").next();$(".js-before").addClass("hidden"),a.val(""),d.removeClass("hidden").find(".js-sent-email").html(c.data.email)}else 406===c.code?(b.addClass("in").find(".msg").html(c.msg),a.data("hasError",!0)):e.addClass("error").find(".js-before").addClass("hidden").next().next().find(".js-msg").html(c.msg).removeClass("hidden")})},closeErrorBar:function(a){panda.stopEvent(a),e.removeClass("error").find(".js-error").addClass("hidden").parent().find(".js-before").removeClass("hidden")},validate:function(){var d=$(this);c&&clearTimeout(c),c=setTimeout(function(){var c=d.val();c&&d.data("pEmail")!==c?(d.data("pEmail",c),$.getJSON(__account.urls.validate,{pendingEmail:c},function(c){var d=406===c.code,e=d&&c.data.errors?c.data.errors[0].message:"";b.toggleClass("in",d).find(".msg").html(e),a.data("hasError",d)})):d.data("pEmail")===c&&""!==c||(b.removeClass("in").find(".msg").html(""),a.data("hasError",!1))},500)}}},panda.account.resendEmail=function(){var a,b,c,d,e,f,g,h,i={};return i={init:function(){return $(".js-resend-email").on("click",i.open),i},open:function(a,b){panda.stopEvent(a),$.getJSON(__account.urls.resend,{type:$(this).data("type")||b||"resend"},function(a){var b=$(a.data.html);__account.addAnimation(b,"slideUp"),panda.showOverlay(i.setEvents(b),!0)})},setEvents:function(f){return f.find(".js-close-btn").click(panda.hideOverlay),f.find(".js-resend-form").submit(i.resend),a=f.find(".js-password-wrap"),b=f.find(".js-email-error"),c=f.find(".js-password-error"),d=f.find(".js-txt").on("keydown",i.checkPassword),e=f.find(".js-validate"),h=d.data("prevEmail"),g=d.data("activeEmail"),f.find(".js-txt-wrap").toggleHolder(),f},resend:function(a){panda.stopEvent(a);var b=$(this),f={isPlain:!0,email:g,prevEmail:h,pendingEmail:d.val(),password:e.val()};if(d.data("hasError"))return!1;$.postJSON(b.getHref(),f,function(a){if(200===a.code){panda.hideOverlay();var b=$(".js-before"),d=b.next();b.isExists()?$(".js-before").remove():d=$(".js-complete"),d.removeClass("hidden").find(".js-sent-email").html(a.data.email),$.putJSON(__account.urls.refreshAuthorities),panda.require("panda.account.activate").open()}else c.addClass("in").find(".msg").html(a.msg),setTimeout(function(){c.removeClass("in")},2e3)})},checkPassword:function(){var d=$(this);a.isExists()&&setTimeout(function(){a.toggleClass("hidden",h===d.val())},1),f&&clearTimeout(f),f=setTimeout(function(){var a=d.val();a&&h!==a&&d.data("pEmail")!==a?(d.data("pEmail",a),$.getJSON(__account.urls.validate,{pendingEmail:a},function(a){var c=406===a.code,e=c&&a.data.errors?a.data.errors[0].message:"";b.toggleClass("in",c).find(".msg").html(e),d.data("hasError",c)})):d.data("pEmail")===a&&h!==a||(b.removeClass("in").find(".msg").html(""),c.removeClass("in").find(".msg").html(""),e.val(""),d.data("hasError",!1))},500)}}},panda.namespace("profile"),panda.profile.update=function(){var a,b,c,d,e={},f=$("#updateForm"),g={},h=panda.require("fn.validation");return e={init:function(){b=panda.require("fn.dockedMenu"),a=panda.require("fn.saveWarning"),c=panda.require("fn.observer"),d=panda.require("fn.fileUploadToS3"),f.submit(e.update),$(".js-file-input").on("change",e.uploadThumbnail),$(".fake-button-title").on("click",function(a){panda.stopEvent(a),$(".js-file-input").click()}),$("#profile-save-btn").on("click",function(a){panda.stopEvent(a),$(this).hasClass("disabled")||f.submit()}),$(".js-add-link").on("click",e.addAnotherSite),panda.require("profile.toggleTip",$(".js-label")),f.find(".observer").on("input",e.watchChanges),$(".js-display-name").on("keydown",function(){$("#error-displayName").isExists()&&$("#error-displayName").remove()})},watchChanges:function(){c.isChanged()?$("#profile-save-btn").removeClass("disabled").addClass("mint"):$("#profile-save-btn").addClass("disabled").removeClass("mint")},update:function(b){panda.stopEvent(b);var c=$(this),d={isPlain:!0},e=c.serializeArray();$.each(e,function(a,b){d[b.name]=b.value}),d.uploadFile=g,g&&(d.enableThirdPartyImage=!1),$.postJSON(c.attr("action"),d,function(b){200!==b.code?h.checkErrorAllField(b,c):b.data&&(a.release(),panda.goPage())})},uploadThumbnail:function(a){panda.stopEvent(a);var b=$(this),c=b.data("type"),f=$(".preview"),h=function(a){g=JSON.stringify(a),f.attr("src",a.s3.url),panda.showGlobalMessage(a.filename+" uploaded."),e.watchChanges()};""!==b.val().trim()&&(panda.showGlobalMessage("Uploading..."),d.uploadToR(c,{files:this.files[0]},h))},addAnotherSite:function(a){panda.stopEvent(a);var b=$(this),d=b.parent(),e=d.find(">div.inner"),f=e.length,g=e.eq(0).clone(!0);g.data("idx",f).find("input.text").val("").data("uid","").each(function(){var a=$(this);a.attr("name",a.attr("name").replace(/(\d+)/g,f))}),b.before(g),c.refresh()}}},panda.profile.toggleTip=function(){return{init:function(a){a.on("click",function(){$(this).parents(".row-input").prev(".row-label.js-toggle-hidden").find(".tip").toggleClass("hidden")})}}},panda.namespace("settings"),panda.settings.main=function(){var a,b,c,d,e,f,g,h={},i=$("#updateForm"),j=function(a){var b=a.siblings(".onoff-tip.js-text-tip"),c=a.siblings(".onoff-title.js-tip-title");b.isExists()&&b.toggleClass("hidden"),c.isExists()&&c.toggleClass("hidden")},k=function(){var a=$(this),b=a.is(":checked")?"ON":"OFF",c=a.attr("name"),d=panda.arrayToMakeUrl([a.data("url"),c,b]);panda.showGlobalMessage("Saving settings..."),$.putJSON(d,function(){h.toggleLabel(a),setTimeout(function(){panda.showGlobalMessage("Settings updated.")},500)})},l=function(){var a=$(this),b=a.parent().next(),c=a.val(),d=a.data("prevUname");c=c.replace(/\s+/g,""),c!==d?$.getJSON("/validate-uname",{name:c},function(a){a.data.exist?b.text("Darn! That's already taken. Please try something else.").removeClass("hidden"):b.text("").addClass("hidden")}):b.text("").addClass("hidden"),a.val(c)};return h={init:function(){return c=$(".js-new-password"),d=$(".js-verify-password"),e=$(".dropdown-menu"),a=$("#uname").on("input",l),b=$("#email").on("blur",h.checkEmail),f=panda.require("fn.saveWarning"),g=panda.require("fn.dockedMenu"),panda.require("fn.deleteAccount",$(".delete-account-btn")),$("#account-save-btn").on("click",h.save),$(".onoff-switcher").on("change",k),$(".js-change-email").on("click",function(a){panda.stopEvent(a),$(".item-title.personal").click()}),$(".js-delete-payment-method").on("click",h.removePaymentMethod),h},toggleLabel:function(a){var b=a.parent();b.hasClass("main")?(h.toggleOptions(a.prop("checked")),$("#notification-opt").toggleClass("hidden",!a.prop("checked"))):j(b)},toggleOptions:function(a){var b=[];$.each($(".email-noti"),function(c,d){var e=$(d).find(":checkbox");a?(e.prop("checked",e.data("prev")),e.prop("checked")&&b.push(e.attr("name"))):(e.data("prev",e.prop("checked")),e.prop("checked",!1)),j($(d))}),$.putJSON("/profile/settings/revert-notification",{fields:b.toString()})},removePaymentMethod:function(){var a=$(this);if(a.hasClass("disabled"))return!1;$.deleteJSON("/profile/payment-method",{},function(b){200===b.code&&(a.addClass("disabled"),panda.showGlobalMessage("Payment methods removed"),a.find("span").text("No saved payment methods"))})},save:function(a){panda.stopEvent(a);var b=$("#password-confirm"),e=!b.isExists();if(f.getObserver().isChanged()){if(c.val()!==d.val())return!1;if(e)return""===c.val()?panda.alert({body:"You need to add a password to update your account settings. Please enter a new password in the Add Password fields."}):(f.release(),i.submit()),!1;var g=b.clone(!0).removeClass("hidden").find(".save").on("click",h.__save).end(),j=g.find(".text").on("keypress",function(a){panda.isEnter(a)&&h.__save(a)}).attr("id","currentPassword");panda.showOverlay(g,!0),j.focus()}},__save:function(a){panda.stopEvent(a);var b=$("#currentPassword").val();b&&(i.appendHiddenField({name:"currentPassword",value:b}).appendHiddenField({name:"requiredPassword",value:"true"}),f.release(),i.submit())},checkEmail:function(){var a=$(this),b=a.val(),c=a.data("prevEmail");b&&c!==b&&a.data("pEmail")!==b?(a.data("pEmail",b),$.getJSON("/account/validate_email",{pendingEmail:b},function(b){var c=406===b.code,d=c&&b.data.errors?b.data.errors[0].message:"";a.data("hasError",c),c?$(".field-error.email").html(d).removeClass("hidden"):$(".field-error.email").addClass("hidden")})):a.data("pEmail")===b&&c!==b||(a.data("hasError",!1),$(".field-error.email").addClass("hidden"))}}},panda.settings.blockedUsers=function(){return{init:function(a){a&&""!==a&&panda.require("fn.showDoneIt").showMessage("Unblocked "+a),$(".js-unblock-btn").on("click",function(a){panda.stopEvent(a),$.deleteJSON($(this).getHref(),{},function(){panda.goPage("/profile/blocked-users")})})}}},panda.namespace("dashboard"),panda.dashboard.common=function(){var a,b={},c=$.noop,d=$(".alert-error"),e=d.find(".js-form-alert"),f=function(){var a=(e[0].offsetHeight-20)/2;e.next().css({marginTop:a+"px"})};return b={init:function(){return a=panda.require("fn.fileUploadToS3"),$(".js-file").change(b.uploadImage),d.isExists()&&!d.hasClass("hidden")&&f(),b},showError:function(a){e.html(""),e.append(a),f()},showErrors:function(a){d.removeClass("hidden"),e.html(""),$.each(a,function(a,b){e.append("<li>"+b.message+"</li>")}),f()},setDelegateCB:function(a){return c=a,b},delegateDelete:function(a){panda.stopEvent(a);var b=$(this),d=b.data("kind")||"episode",e=panda.templateCompile("delete-alert",{title:d}).find(".delete").on("click",function(a){panda.stopEvent(a),panda.callback(c),panda.actionFormSubmit(b.getHref())}).end();panda.showOverlay(e,!0),c=null},uploadHTML:function(b,c,d,e,f){panda.showGlobalMessage("Uploading content..."),a.uploadToR("HTML",{html:b},function(a){d["contents[0].file"]=JSON.stringify(a),panda.showGlobalMessage(c+" uploaded."),setTimeout(function(){panda.callback(e)},10)},{errorCallback:f})},uploadB64:function(b,c){""!==b?a.uploadToR("SERIES_ASSET",{b64:b},c):panda.callback(c)},uploadImage:function(){var b=$(this),c=b.data("type"),d=b.data("field"),e=this.files[0],f=b.parent().next();panda.showGlobalMessage("Uploading..."),a.uploadToR(c,{files:e},function(a){var c="js-"+d,e=$("<input>").attr({class:c,type:"hidden",name:d,value:JSON.stringify(a)});$(c).remove(),b.closest(".js-thumb-form").append(e);var g=f.find(".js-thumb").prop("src",a.s3.url).removeClass("hidden default-bg").next();g.isExists()&&g.addClass("hidden"),panda.showGlobalMessage(a.filename+" uploaded.")})}}},panda.dashboard.seriesStats=function(){var a,b,c,d,e,f,g,h,i,j,k,l={},m=$(".js-stats-filter"),n=$(".js-sort-options"),o=$("#stats-episode-list-table"),p=$(".header",o),q=$(".body-holder",o);return l={init:function(){return panda.require("fn.dropdown",$(".js-dropdown-wrap"),function(){panda.goPage($(".js-options > .hidden > a").getHref())}),h=panda.require("fn.dockedMenu"),i=panda.require("dashboard.searchStats",{statsFilter:$(".js-stats-filter"),sortOptions:$(".js-sort-options"),searchBtns:$(".js-search-button")},l.searchStats),j=panda.require("fn.dateUtils"),k=panda.require("dashboardChart.chart"),a=$(".stats-tab"),b=$(".tab-pane"),a.on("click",l.tabStatusGraph),l.searchStats($("li.hidden",n),function(){h.refreshPositions()}),l.setSortingEvent(),l},setSortingEvent:function(){p.on("click",".sortable",l.sortEpisodeList)},tabStatusGraph:function(c){panda.stopEvent(c);var d=$(this);a.children("a").removeClass("active").filter(d.children("a")).addClass("active"),b.removeClass("active").filter("."+d.data("type")).addClass("active")},sortEpisodeList:function(){var a=$(this),b=a.data("type"),d=a.hasClass("asc");a.toggleClass("asc",!d).toggleClass("desc",d);var e=a.hasClass("desc"),f=e?-1:1;c||(c=q.find(".tr")),c.sort(function(a,c){var d=$(a).data(b),e=$(c).data(b);return(d===e?0:d>e?1:-1)*f}),c.appendTo(q.find(".contents"))},searchStats:function(a,b){var c=a||$("li.hidden",n),h=i.values(),l={},o=$(c).data("kind");l.factor=h.factor,l.kind=o,$.getJSON(m.getHref(),l,function(a){var c=a.data.series_stats,h=a.data.is_daily,l=a.data.month,m=h?"day":"month",n=a.data.start_date.substring(0,10),o=a.data.end_date.substring(0,10),p=[];$.each(j.range(n,o,m),function(a,b){var d=i.getStatsData(c,b);void 0===d?p.push({date:b,popular_cnt:0,thumbsup_cnt:0,subscribe_cnt:0,comment_cnt:0}):p.push(d)}),k.drawStatistics(p,l,d,".views","view",h),k.drawStatistics(p,l,e,".likes","like",h),k.drawStatistics(p,l,f,".subscribe","subscribe",h),k.drawStatistics(p,l,g,".comments","comment",h),panda.callback(b)})}}},panda.dashboard.openAds=function(){var a,b,c,d,e,f,g,h={},i=$(".js-stats-filter"),j=$(".js-sort-options");return h={init:function(b,c){return f=b,a=c,h.setEvents(),h},setEvents:function(){f?panda.require("dashboard.activateProgram"):(b=panda.require("fn.dockedMenu"),c=panda.require("dashboard.searchStats",{statsFilter:$(".js-stats-filter"),sortOptions:$(".js-sort-options"),searchBtns:$(".js-search-button")},h.searchStats),d=panda.require("fn.dateUtils"),e=panda.require("dashboardChart.chart"),$('[data-toggle="tooltip"]').tooltip(),h.searchStats($("li.hidden",j),function(){b.refreshPositions(),a&&panda.require("dashboard.welcomePop","tpWelcomeOpenAd")}),$(".card").on("click",function(){var a=$(this);if(a.hasClass("scroll")){var b=$(a.data("scroll"));panda.goToTop(null,b.offset().top)}else panda.goPage(a.getHref())}))},searchStats:function(a,b){var f=a||$("li.hidden",j),h=c.values(),k={},l=$(f).data("kind");k.factor=h.factor,k.kind=l,$.getJSON(i.getHref(),k,function(a){var f=a.data.impression_stats,h=a.data.is_daily,i=a.data.month,j=h?"day":"month",k=a.data.start_date.substring(0,10),l=a.data.end_date.substring(0,10),m=a.data.has_more_data,n=[];$(".search-prev").toggleClass("last",!m),$.each(d.range(k,l,j),function(a,b){var d=c.getStatsData(f,b);void 0===d?n.push({id:0,publisherId:0,impressionCnt:0,targetDate:b,createdDate:b}):n.push(panda.convertKeyFromSnakeToCamel(d))}),e.drawOpenAds(n,i,g,".tab-pane.ads",h),panda.callback(b)})}}},panda.dashboard.searchStats=function(){var a,b,c,d,e,f,g,h,i={},j=0,k=0;return i={init:function(g,j){return a=g.statsFilter,c=g.sortOptions,f=g.searchBtns,f.filter(".today").addClass("last"),b=$("span",a),d=$("li",c),e=c.filter(".hidden"),h=j,i.setEvents(),i},values:function(){return{factor:j,startPeriod:k,endPeriod:g}},setEvents:function(){a.on("click",i.toggleOptions),d.on("click",i.selectPeriod),f.on("click",i.searchStatsWithPeriod)},toggleOptions:function(b){var c=$(this);c.parent().toggleClass("on"),panda.stopEvent(b),c.parent().hasClass("on")?$(window).one("click.closed",function(){a.parent().removeClass("on")}):$(window).off("click.closed")},selectPeriod:function(a){panda.stopEvent(a);var b=$(this);k=0,g=0,j=0,i.changeFilterText(b),i.controlSearchBtns(),panda.callback(h)},changeFilterText:function(c){b.text($(c).data("sortLabel")),d.removeClass("hidden").filter(c).addClass("hidden"),a.removeClass("on")},controlSearchBtns:function(){f.filter(".search-next, .today").toggleClass("last",0===j)},searchStatsWithPeriod:function(a){panda.stopEvent(a);var b=$(this),d=b.hasClass("today"),e=b.hasClass("search-prev"),f=$("li.hidden",c),l=f.data("period");b.hasClass("last")||(d?j=0:j+=e?-1:1,k=Math.abs(j)*l,g=k+l,i.controlSearchBtns(),panda.callback(h))},getStatsData:function(a,b){var c;for(var d in a)if(a[d].date===b){c=a[d];break}return c}}},panda.dashboard.welcomePop=function(){return{init:function(a){var b=panda.templateCompile(a);b.one("rendered",function(){b.addClass("slideUp")}),b.find(".continue-btn").on("click",panda.hideOverlay),panda.showOverlay(b,!0)}}},panda.dashboard.activateProgram=function(){var a={},b=function(a){panda.stopEvent(a);var b=$(this);b.hasClass("disabled")||(b.addClass("disabled"),panda.getActionFormSubmit().attr({method:"post"}),panda.actionFormSubmit(b.getHref()))},c=function(){var a=3===$(":checkbox:checked").length;$(".activate-btn").toggleClass("mint",a).toggleClass("disabled",!a)};return a={init:function(){return $(".activate-btn").on("click",b),$(":checkbox").on("change",c),a}}},panda.dashboard.customAmount=function(){var a,b,c,d,e,f,g,h,i,j,k="Please enter between ${{min}} and ${{max}}.";return a={init:function(d){return b=d.$input,e=d.isSupportCent,c=d.withCurrencySymbol,f=d.inverseStyle||!1,b.tooltip({placement:"bottom",trigger:"manual",html:!0}),b.on("input",e?a.validateAmountWithCents:a.validateAmount),(d.enterEvent||d.inputEvent)&&b.on("keyup",function(a){panda.isEnter(a)?d.enterEvent&&panda.callback(d.enterEvent):d.inputEvent&&panda.callback(d.inputEvent)}),g=a.getMinAmount(d),h=a.getMaxAmount(d),k=panda.format(k,{min:g,max:h}),a},getMinAmount:function(a){return e?a.minAmount.toFixed(2)||1:a.minAmount||1},getMaxAmount:function(a){return e?a.maxAmount.toFixed(2)||999:a.maxAmount||999},getAmount:function(){return b.val().replace(/\${1}/,"")},getFloatAmount:function(){return parseFloat(a.getAmount()).toFixed(2)},isNumber:function(a){return new RegExp(/^[\d]+$/).test(a)},isFloat:function(a){return new RegExp(/^[\d]+\.[\d]+$/).test(a)},validateAmount:function(){var e,f=a.getAmount(),g=/^[\d]+$/.test(f)||""===f;g?""!==f&&(f*=1):f=f.replace(/[^\d]/g,""),b.val((c?"$":"")+f),e=""===f||a.validateMinMaximumAmount(),d&&e?d&&g&&e&&a.toggleTooltip(!1):g&&e||a.toggleTooltip(!0,g?k:"Enter a whole dollar amount without cents, symbols, or letters. Example: <strong>35</strong>"),b.trigger("amount.changed",[f,a.validateMinMaximumAmount()])},validateAmountWithCents:function(){var e,f=a.getAmount(),g=a.isNumber(f),h=a.isFloat(f),i=/^[\d]+\.$/.test(f);h?/\.([\d]+)/.exec(f)[1].length>2&&(h=!1,f=parseFloat(f).toFixed(2)):g||h||i||(f=f.replace(/[^\d|\.]/g,"")),b.val((c?"$":"")+f),e=""===f||a.validateMinMaximumAmountWithCents(),d&&e?d&&(g||h)&&e&&a.toggleTooltip(!1):(h||g)&&e||a.toggleTooltip(!0,g||h?k:"Enter a whole dollar amount with cents but not symbols, or letters. Example: <strong>35.00</strong>")},toggleTooltip:function(c,e){clearTimeout(i),clearTimeout(j),i=setTimeout(function(){c&&(panda.updateTooltipTitle(b,e||""),j=setTimeout(function(){a.toggleTooltip(!1)},3e3)),b.tooltip(c?"show":"hide")},c?300:1),d=c},validateMinMaximumAmount:function(){var b=parseInt(a.getAmount(),10)||0;return!(b>h||b<g)},validateMinMaximumAmountWithCents:function(){var b=parseFloat(a.getAmount())||0;return!(b>h||b<g)},showInvalidAmountTooltip:function(){return a.toggleTooltip(!0,k),a},hideTooltip:function(){return a.toggleTooltip(!1),a},validate:function(){var c=a.getAmount();return!(!a.isNumber(c)&&!a.isFloat(c)||e?!a.validateMinMaximumAmountWithCents():!a.validateMinMaximumAmount())||(a.showInvalidAmountTooltip(),b.focus(),!1)},clearAddAmount:function(c){return b.val(""),c&&b.trigger("amount.changed",[0,!1]),a}}},panda.namespace("dashboardChart"),panda.dashboardChart.chart=function(){var a={};return a={init:function(){return a},drawStatistics:function(b,c,d,e,f,g){var h="stats",i=function(a){var b;switch(f){case"view":b=a.popular_cnt;break;case"like":b=a.thumbsup_cnt;break;case"subscribe":b=a.subscribe_cnt;break;case"comment":b=a.comment_cnt}return b},j=a._svgOption(b,h,i);d=a._drawSVG(e,j),j.x.domain(b.map(function(a){return a.date})),j.y.domain([0,j.yMax<5?5:j.yMax]),a._drawAxis(d,j,c,h,g),d.selectAll(".bar").data(b).enter().append("rect").attr("class","bar "+f+"-bar").attr("data-toggle","tooltip").attr("data-title",function(b){return'<span class="stats-count">'+panda.formattedString(i(b))+"</span> "+a._formatText(b.date,h,g)}).attr("x",function(a){return j.x(a.date)}).attr("width",j.x.rangeBand()).attr("y",j.height).attr("height",0).transition().duration(250).attr("y",function(a){return j.y(i(a))}).attr("height",function(a){return j.height-j.y(i(a))}),a._setSVGTooltip("top",e)},drawTips:function(b,c,d,e,f){var g="tips",h=a._svgOption(b,g);d=a._drawSVG(e,h),h.x.domain(b.map(function(a){return a.baseDate})),h.y.domain([0,h.yMax<1?200:h.yMax]),a._drawAxis(d,h,c,g,f),d.selectAll(".bar").data(b).enter().append("rect").attr("class","bar revenue-tips").attr("data-toggle","tooltip").attr("data-title",function(b){return'<span id="chart-bar">$'+(b.sum/100).toFixed(2)+"</span> "+a._formatText(b.date,g,f)}).attr("x",function(a){return h.x(a.baseDate)}).attr("width",h.x.rangeBand()).attr("y",h.height).attr("height",0).transition().duration(500).attr("y",function(a){return 0===h.yMax?h.height:h.height-h.height*a.sum/h.yMax}).attr("height",function(a){return 0===h.yMax?0:h.height*a.sum/h.yMax}),a._setSVGTooltip("top",".dashboard-page-wrap.dark")},drawOpenAds:function(b,c,d,e,f){var g="ads",h=a._svgOption(b,g);d=a._drawSVG(e,h),h.x.domain(b.map(function(a){return a.targetDate})),h.y.domain([0,h.yMax<1?200:h.yMax]),a._drawAxis(d,h,c,g,f),d.selectAll(".bar").data(b).enter().append("rect").attr("class","bar revenue-ads").attr("data-toggle","tooltip").attr("data-title",function(b){return'<span id="chart-bar">'+panda.commifyNumbers(b.impressionCnt)+"</span> "+a._formatText(b.date,g,f)}).attr("x",function(a){return h.x(a.targetDate)}).attr("width",h.x.rangeBand()).attr("y",h.height).attr("height",0).transition().duration(500).attr("y",function(a){return 0===h.yMax?h.height:h.height-h.height*a.impressionCnt/h.yMax}).attr("height",function(a){return 0===h.yMax?0:h.height*a.impressionCnt/h.yMax}),a._setSVGTooltip("top",".dashboard-page-wrap.dark")},drawRevenue:function(b,c,d,e,f){var g="revenue",h=a._svgOption(b,g);d=a._drawSVG(e,h),h.x.domain(b.map(function(a){return a.date})),h.y.domain([0,h.yMax<200?200:1.2*h.yMax]),a._drawAxis(d,h,c,g),f.hasNoHistories||(d.selectAll(".bar").data(b).enter().append("rect").attr("class","bar revenue-bar ").attr("data-toggle","tooltip").attr("data-title",function(a){return panda.format('<span class="currency">${{rev}}</span> {{title}}',{rev:(h.revenue(a)/100).toFixed(2),title:"Ad revenue"})}).attr("x",function(a){return h.x(a.date)}).attr("width",h.x.rangeBand()).attr("y",h.height).attr("height",0).transition().duration(500).attr("y",function(a){return h.y(h.revenue(a))}).attr("height",function(a){return h.height-h.y(h.revenue(a))}),d.select("rect:last-child").attr("class",function(a){var b="bar revenue-bar ";return moment(a.date).format("MMMYYYY")===moment().utc().subtract(1,"day").format("MMMYYYY")&&(b+=" last"),b}),a._setSVGTooltip("top","#revenue-history-section"))},drawRevenueStack:function(b,c,d,e,f){var g="revenue",h=a._svgOption(b,g),i=d3.scale.ordinal().range(["#42C2D2","#82C242"]);if(d=a._drawSVG(e,h),i.domain(["ad","tip"]),b.forEach(function(a){var b=0;a.sum=i.domain().map(function(c){return{name:c,y0:b,y1:b+=a[c]}})}),h.x.domain(b.map(function(a){return a.date})),h.y.domain([0,h.yMax<200?200:1.2*h.yMax]),a._drawAxis(d,h,c,g),!f.hasNoHistories){var j=d.selectAll(".stack").data(b);j.enter().append("g").attr("class","stack").attr("data-toggle","tooltip").attr("data-title",function(b){return panda.format('<span class="currency">${{totalRev}}</span> Total {{title}}<br>{{tipRev}}{{adRev}}',{totalRev:(h.revenue(b)/100).toFixed(2),title:"Revenue",tipRev:f.hasCreatorTip?a.getPrefix(b.tip,"Support"):"",adRev:f.hasAdProgram?a.getPrefix(b.ad,"Ad"):""})}).attr("transform",function(a){return"translate("+h.x(a.date)+", 0)"}),j.selectAll("rect").data(function(a){return a.sum}).enter().append("rect").attr("class",function(a){return a.name}).attr("width",h.x.rangeBand()).attr("y",h.height).attr("height",0).transition().duration(500).attr("y",function(a){return h.y(a.y1)}).attr("height",function(a){return h.y(a.y0)-h.y(a.y1)}),a._setSVGTooltip("top","#revenue-history-section")}},getPrefix:function(a,b){return panda.format('<span class="dark">${{rev}} {{title}}</span><br>',{rev:(a/100).toFixed(2),title:b+" Revenue"})},_svgOption:function(a,b,c){var d=395,e=885,f={top:20,right:20,bottom:30,left:25},g=d3.scale.ordinal().rangeRoundBands([0,e],.2),h=d3.scale.linear().range([d,0]),i=d3.svg.axis().scale(g).orient("bottom").ticks(6),j={height:d,width:e,margin:f,x:g,y:h,xAxis:i,dataSize:a.length};if("stats"===b)j.yAxis=d3.svg.axis().scale(h).orient("left").ticks(5).tickFormat(function(a){return a>=1e6?a/1e6+"M":a>=1e3?a/1e3+"K":a}),j.yMax=d3.max(a,function(a){return c.apply(this,[a])});else if("ads"===b)j.yAxis=d3.svg.axis().scale(h).orient("left").ticks(6).tickFormat(function(a){return a>=1e3?a/1e3+"K":a}),j.yMax=d3.max(a,function(a){return a.impressionCnt});else if("tips"===b)j.yAxis=d3.svg.axis().scale(h).orient("left").ticks(6).tickFormat(function(a){var b=a/100;return"$"+(b>=1e3?b/1e3+"K":b)}),j.yMax=d3.max(a,function(a){return a.sum});else if("revenue"===b){var k=function(a){return a.totalRevenue};j.yAxis=d3.svg.axis().scale(h).orient("left").ticks(6).tickFormat(function(a){var b=a/100;return"$"+(b>=1e3?b/1e3+"K":b)}),j.yMax=d3.max(a,function(a){return k(a)}),j.revenue=function(a){return a.totalRevenue}}return j},_drawSVG:function(a,b){return $(a).empty(),d3.select(a).append("svg").attr("width","940").attr("height",b.height+b.margin.top+b.margin.bottom).append("g").attr("transform","translate(50, 20)")},_drawAxis:function(b,c,d,e,f){b.append("g").attr("class","x axis").attr("transform","translate(0, 395)").call(c.xAxis).selectAll(".tick").style(a._axisStyle(d,e,c,f)).selectAll(".tick > text").attr("class","stats"===e||"ads"===e||"tips"===e?"sm":"").text(function(b){return a._formatText(b,e,f)}),b.append("g").attr("class","y axis").call(c.yAxis)},_axisStyle:function(a,b,c,d){return"stats"===b||"ads"===b||"tips"===b?{display:function(b,e){var f=pInt(b.substring(5,7));return d?(e%3==0||c.dataSize<10)&&f===a?"block":"none":"block"}}:{display:function(b,c){return a<10?"block":0===c||c%5==0||c%a==0?"block":"none"}}},_formatText:function(a,b,c){if(void 0!==a)switch(b){case"revenue":return moment(a).format("MMM YYYY");case"tips":case"ads":case"stats":var d="MMM YYYY",e="MMM";return c&&(d="MMM D YYYY",e="MMM D"),a.substring(0,4)<panda.getEnvs("today").substring(0,4)?moment(a).format(d):moment(a).format(e)}},_setSVGTooltip:function(a,b){$('[data-toggle="tooltip"]').tooltip({placement:a,trigger:"hover",container:b,html:!0})}}},panda.namespace("dashboardSeries"),panda.dashboardSeries.main=function(){var a,b,c,d,e,f,g,h,i={},j=$(window),k=function(a){panda.stopEvent(a);var b,c,d,e,f,g,h=$(this),i=!0,j=function(a){panda.stopEvent(a);var h=d.find("#scheduleForm");if(h.appendHiddenField({name:"id",value:b}).appendHiddenField({name:"series.id",value:c}),i){var j=moment(e.val()+" "+f.val()).format("YYYY-MM-DD HH:mm");if(g===j)return panda.hideOverlay(),!1;h.appendHiddenField({name:"publishDate",value:j})}h.submit()};$.getJSON(h.getHref(),function(a){if(200===a.code){var g=a.data,h=moment(panda.getEnvs("today"),"yyyy/MM/DD HH:mm:ss"),k=moment(g.publish_date_in_pst),l={calendar:panda.templateCompile("calendar-template").selfHtml(),day:k.format("MMMM DD, YYYY"),time:k.format("hh:mm A")};b=g["episode.id"],c=g["series.id"],$.each(g,function(a,b){l[a]=b}),d=panda.templateCompile("schedule-template",l),d.data("isValid",!0).find(".js-save-schedule").on("click",j).end().find(".js-publish-now").on("click",function(a){panda.stopEvent(a),i=!1,j()}).end().find(".date").on("change",function(){var a=e.val(),b=$(this),c=moment(a+" "+b.val(),["YYYY-MM-DDThh:mm a"]),g=c.isValid();d.data("isValid",g).find(".date-wrap").toggleClass("warning",!g),g&&(b.val(c.format("hh:mm A")),f.val(c.format("HH:mm")))}).end(),e=d.find("#schedule-date").val(k.format("YYYY-MM-DD")),f=d.find("#schedule-time").val(k.format("HH:mm")),panda.showOverlay(d,!0),panda.require("fn.calendar",h).load(k).setOnSelected(function(a){d.find(".schedule-date").html(a.format("MMMM DD, YYYY")),e.val(a.format("YYYY-MM-DD"))})}})},l=function(){var a=$(".js-dropdown").data("type");"all"===a?$(".js-content-card").removeClass("hidden"):$(".js-content-card").addClass("hidden").filter(".js-"+a).removeClass("hidden")},m=function(a){panda.stopEvent(a);var b=$(this),c=b.data("where"),d=b.attr("href"),e="gplus"===c?600:420;panda.openPopup({url:d,width:600,height:e}),j.trigger("click")},n=function(a){var b=$(this),c=b.find("i"),d="mouseenter"===a.type,e=c.attr("class"),f=d?b.data("ico")+"-on":b.data("ico");c.replaceClass(e,f)},o=function(a){panda.stopEvent(a);var b=$(this),c=$("#"+b.data("typeId"));c.siblings("div.default-bg").hasClass("hidden")&&(c.attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==").addClass("hidden"),c.siblings("div.default-bg").removeClass("hidden"),$(".js-"+b.data("path")).remove(),$("#"+b.data("resetId")).remove())},p=function(c){panda.stopEvent(c);var e=$("#seriesForm"),f=$(this).data("returnUrl");if(!$(this).hasClass("disabled"))if("add"===h){if(e.data("submit"))return;e.data("submit",!0),e.submit()}else{var g={isPlain:!0};$.each(e.serializeArray(),function(a,b){g[b.name]=b.value}),$.postJSON(e.getHref(),g,function(c){var e=c.data;406===c.code?(a.showErrors(e.errors),b&&b.moveTo("_info")):(d.release(),panda.goPage(f))})}},q=function(a){panda.stopEvent(a),f.find(">li.hidden").removeClass("hidden"),$(this).remove(),b.refreshPositions()},r=function(){var a=$(".dropdown-option.hidden > a"),b=a.data("sortBy"),c=a.data("sortDirection")||"desc";g||(g=$(".series-episode",f)),g.sort(function(a,d){var e="desc"===c?-1:1;return($(a).data(b)-$(d).data(b))*e}),f.next().isExists()&&g.addClass("hidden").filter(function(a){return a<5}).removeClass("hidden"),g.appendTo(f)},s=function(){c.isChanged()?$("#save-btn").removeClass("disabled").addClass("mint"):$("#save-btn").addClass("disabled").removeClass("mint")},t=function(a){panda.stopEvent(a);var b=$(this),c=b.getHref(),d=b.data("url")||"",e=$(".js-milestone-wrap");$.postJSON(c,function(a){if(""!==d)panda.goPage(d);else{var b=$(a.data.html);b.find(".js-achieved-btn").on("click",t),e.empty().append(b)}})},u=function(){var a=$(this);$.postJSON(a.getHref(),function(){panda.goPage()})};return i={init:function(a,b,c,d){if(h=a,i.setEvents(),b){var e=panda.templateCompile("tpPublishedEpisode");e.find(".share > .third-party").on("click",m),panda.showOverlay(e,!0)}return setTimeout(function(){c&&panda.addGATrackEvent({category:"data-tracking",action:"added",label:"BGM"}),d&&panda.addGATrackEvent({category:"data-tracking",action:"added",label:"NSFW"})},1e3),i},setEvents:function(){$(".js-btn").on("mouseenter mouseleave",n),$('[data-toggle="tooltip"]').tooltip({placement:"right"}),panda.require("fn.radio",$(".js-radio")),"index"===h?(panda.require("fn.dropdown",$(".js-dropdown-wrap"),l),panda.require("dashboardSeries.dropdown"),$(".js-achieved-btn").on("click",t),$(".js-main-checked").on("click",u),$(".js-dismiss-btn").on("click",function(a){panda.stopEvent(a),panda.putJSON($(this).getHref()),$(this).closest(".js-help-wrap").remove()})):($("#save-btn").on("click",p),$(".js-reset-to-default").on("click",o),a=panda.require("dashboard.common"),e=panda.require("fn.validation"),c=panda.require("fn.observer"),panda.require("fn.tagging",s),panda.require("dashboardSeries.humanUrl",h),$(".js-em-valid").on("input",e.checkEmoji),"edit"===h&&(f=$(".content-list"),b=panda.require("fn.dockedMenu"),d=panda.require("fn.saveWarning"),panda.require("fn.dropdown",$(".js-dropdown-wrap"),r),$(".js-show-all-episodes").on("click",q),$(".js-set-schedule").on("click",k),$(".js-delete-series, .js-delete-episode").on("click",a.setDelegateCB(function(){"edit"===h&&d.release()}).delegateDelete),$("#seriesForm").on("input",".observer",s).on("change",":radio.observer, :checkbox.observer",s),$("#seriesForm").find(".js-thumb.observer").on("load",s)))}}},panda.dashboardSeries.humanUrl=function(){var a,b,c,d,e,f={},g=null,h=function(e){var f=a.val(),g=!0,h=function(a){c.hasClass("hidden")||c.addClass("hidden"),d.removeClass("hidden"),b.addClass("error"),b.text(a)};""===f?h("This is required."):f.match(/^\d+$/g)?h("Mathematical! But please use at least one letter."):f.match(/[^\w\-]/g)?h("Slow down, fancy pants. Only letters, numbers, dash(-), and underline(_) please."):(d.addClass("hidden"),$.getJSON("/dashboard/series/check/"+f,function(d){var f=d.data;"title"===e?a.val(f.human_url).data("prevVal",f.human_url):f.is_duplicated_human_url&&(h("Uh oh! That URL is already taken. Please something else."),g=!1),g&&(c.removeClass("hidden"),b.text(""))}))},i=function(){var e=$(this);setTimeout(function(){g&&clearTimeout(g);var f=e.val().replace(/[\s]/g,"-").replace(/[^\w\-]/g,"");a.val(f),f&&f!==a.data("prevVal")&&f!==a.data("origin")?g=setTimeout(function(){b.removeClass("error"),h("title"),a.data("prevVal",f)},300):!f&&a.data("prevVal")&&(d.addClass("hidden"),c.addClass("hidden"),b.removeClass("error"),a.data("prevVal",""))},1)},j=function(){setTimeout(function(){g&&clearTimeout(g);var c=a.val();c!==a.data("prevVal")&&c!==a.data("origin")&&(g=setTimeout(function(){b.removeClass("error"),h("human"),a.data("prevVal",c)},300))},1)};return f={init:function(a){return e=a,f.setup(),f},setup:function(){a=$("#humanUrl"),a.isExists()&&(a.on("keydown",j),b=$(".row-input-humanurl .input-message"),c=$(".row-input-humanurl .button-wraps .mint"),d=$(".row-input-humanurl .button-wraps .sorbet"),$("#title").on("keydown",i))}}},panda.dashboardSeries.dropdown=function(){var a={},b=function(a){var b=$(this);b.toggleClass("clicked"),panda.stopEvent(a),b.hasClass("clicked")?$(window).one("click.closed",function(){b.removeClass("clicked")}):$(window).off("click.closed")};return a={init:function(){return $('.has-ndropdown[data-action="click"]').on("click",b),a}}},panda.namespace("dashboardEpisode"),panda.dashboardEpisode.main=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u={},v=new RegExp(/^(<p><br><\/p>)+/),w=!1,x=$("#title"),y=function(a){panda.stopEvent(a),panda.alert({body:"Please select series."})},z=function(){var a=$(".collapsible-box");a.on("click",".more-btn",function(b){panda.stopEvent(b),$(this).closest(a).toggleClass("less")})},A=function(a,b){panda.stopEvent(a);var c=$(this),d=function(a){$("#scene-num").html(a+1)};c.hasClass("step-1")&&($(".step1").addClass("hidden"),$(".step2").removeClass("hidden"),d(g.getScene()),panda.callback(b),q.refreshPositions(),$("html , body").scrollTop(0),x.focus())},B=function(a){panda.stopEvent(a);var b=$("#preview-form").empty();f?b.appendHiddenField({name:"content",value:s.html()}):$.each(h.getContentFileInfos(),function(a,c){b.appendHiddenField({name:"urls["+a+"]",value:c})}),b.appendHiddenField({name:"title",value:x.val()}).appendHiddenField({name:"story",value:$("#story").val()}).appendHiddenField({name:"book",value:f}),panda.addGATrackEvent({category:"dashboard-page",action:"clicked",label:"preview-btn"}),b.submit()},C=function(b,c){panda.stopEvent(b);var e=c||$("#save-btn"),k=$("#episodeForm"),l=e.data("returnUrl"),p=$(this).data("needNotify")||!1,r={isPlain:!0,needNotify:p},t=n.isScheduled();if(f){if(""===x.val())return void panda.alert({body:"Title is required.",cb:function(){x.focus()}});if(v.test(s.html()))return void panda.alert({body:a});e.data("submit",!0)}else e.data("submit",!0),h.updateContentFileInfos();if($.each(k.serializeArray(),function(a,b){r[b.name]=b.value}),r["series.id"]||(r["series.id"]=g.getId()),t||delete r.publishDate,!f&&h.hasFailedContents())return $("#failed-contents-msg").removeClass("hidden"),i.showError($("<li>Please remove or replace images with errors before publishing.</li>")),e.data("submit",!1),void q.moveTo("_files");panda.showLoading(),i.uploadB64(j.getImageData(),function(a){r.sharingThumbFile=JSON.stringify(a),r.alertCB=function(){e.data("submit",!1),panda.hideOverlay()};var b=function(){$.postJSON(k.getHref(),r,function(a){var b=a.data;200===a.code?(m.release(),d||(panda.addGATrackEvent({category:"data-tracking",action:"created",label:t?"scheduled-episode":"episode"}),panda.addAmplitudeEvent("create episode",{type:t?"scheduled":"published"})),setTimeout(function(){panda.goPage(l)},200)):(i.showErrors(b.errors),t=void 0!==r.publishDate&&""!==r.publishDate,n.setScheduled(t),q.moveTo("_episode"),e.data("submit",!1),panda.hideOverlay())})};f?i.uploadHTML(s.html(),x.val(),r,function(){var a=o.countWords(s.text());r.wordsCnt=a,$("#wordsCnt").val(a),b()},function(){e.data("submit",!1),panda.hideOverlay()}):b()})},D=function(){var a=panda.templateCompile("tpSubmit");a.on("click",".cancel-btn",function(a){panda.stopEvent(a),panda.hideOverlay()}).on("click",".save-btn",C),panda.showOverlay(a,!0)},E=function(){w||(w=!0)},F=function(){var a=$(this),b=function(){$("#files-section").addClass("m")};A.apply(a,b),h.uploadFiles(a),E(),r=panda.require("fn.dockedSideBar",$(".pro-tips-wrap"))};return u={init:function(b,g,i,k,l,m,n){return d="edit"===b,e=m,f=g,c=l||0,d?(a="You cant save a blank episode. Please write something!",p={subject:"changes",body:"You have unsaved changes, which will be lost if you continue. Stay and keep editing, or discard your changes and leave?"}):(a="You cant publish a blank episode. Please write something!",p={subject:"episode",body:"This episode is unpublished, and will be lost if you continue. Stay and keep editing, or discard your changes and leave?"}),j=panda.require("fn.croppingTool",{canvasId:"sharing-thumb-canvas",wrapperId:"sharing-thumb-wrap",ratio:1.91,minWidth:600,minImageWidth:260,imagePath:n}),u.setEvents(),i&&x.focus(),k&&h.addFiles(k.slice(1)),u},setEvents:function(){z(),panda.require("fn.tagging"),panda.require("dashboardEpisode.bgm"),i=panda.require("dashboard.common"),g=panda.require("fn.dropdown",$(".js-dropdown-wrap")),q=panda.require("fn.dockedMenu"),l=panda.require("fn.observer"),m=panda.require("fn.saveWarning",{observer:l,template:"warning-novel-popup",params:p}),n=panda.require("dashboardEpisode.schedule",$("#schedule-btn"),function(){t.trigger("click")}),o=panda.require("fn.validation");var a=$("#files-wrap");if(h=panda.require("fn.contentFileManager",a,$("#hidden-content-infos")).setChangedFileCallback(q.refreshPositions),a.on("file.deleted",function(a,b){j.updateContents(b)}).on("file.uploaded",function(a,b){j.addImageInfo(b)}).on("file.upload.end",function(){j.setDefaultImage()}),t=$("#save-btn").on("click",u.save),$("#preview-btn").on("click",B),$(".js-em-valid").on("input",o.checkEmoji),d&&(f||(r=panda.require("fn.dockedSideBar",$(".pro-tips-wrap"))),$(".delete-episode-btn").on("click",i.delegateDelete)),f){if(k=panda.require("dashboardEpisode.editor",".js-editable",$(".count-wrap")),s=$(".js-editable"),b=s.html()){var c=s.text().length;$(".count-wrap").find("span").text(panda.formattedString(c)),$("#wordsCnt").val(o.countWords(s.text()))}else $("#schedule-btn").addClass("disabled"),$("#save-btn").addClass("disabled");$(".js-book").on("click",A)}else panda.require("fn.sort",".content-row",$(".sorter")).setSortCallback(function(){h.reorderingRows(!1)}),$(".js-file-upload-btn").on("click",y),$(".file.contents").on("change",F)},save:function(a){panda.stopEvent(a),panda.hideOverlay();var b=$(this);b.hasClass("disabled")||b.data("submit")||(e&&d&&c>0&&(f&&l.isChanged()||!f&&h.hasNewContents())?D():C(null,b))}}},panda.dashboardEpisode.schedule=function(){var a,b,c,d,e,f,g={},h=$("#publishDate"),i=function(a){if(panda.stopEvent(a),!$(this).hasClass("disabled")){var g=moment(panda.getEnvs("today"),"yyyy/MM/DD HH:mm:ss"),i="HH:00",j=g.add(1,"h"),k=j.format("MMMM DD, YYYY"),l=j.format("hh:00 A"),m=function(a){if(panda.stopEvent(a),!d.data("isValid"))return d.find("input.date").focus(),!1;h.val(moment(b.val()+" "+c.val()).format("YYYY-MM-DD HH:mm")),e=!0,panda.callback(f)},n=function(a){panda.stopEvent(a),e=!1,panda.callback(f)};h.val()&&(j=moment(h.val()),l=j.format("hh:mm A"),k=j.format("MMMM DD, YYYY"),i="HH:mm"),d=panda.templateCompile("schedule-template",{calendar:panda.templateCompile("calendar-template").selfHtml(),day:k,time:l}),d.data("isValid",!0).find(".js-save-schedule").on("click",m).end().find(".js-publish-now").on("click",n).end().find(".date").on("change",function(){var a=b.val(),e=$(this),f=moment(a+" "+e.val(),["YYYY-MM-DDThh:mm a"]),g=f.isValid();d.data("isValid",g).find(".date-wrap").toggleClass("warning",!g),g&&(e.val(f.format("hh:mm A")),c.val(f.format("HH:mm")))}).end(),b=d.find("#schedule-date").val(j.format("YYYY-MM-DD")),c=d.find("#schedule-time").val(j.format(i)),panda.showOverlay(d,!0),panda.require("fn.calendar",g).load(j).setOnSelected(function(a){d.find(".schedule-date").html(a.format("MMMM DD, YYYY")),b.val(a.format("YYYY-MM-DD"))})}};return g={init:function(b,c){return a=b,f=c,e=""!==h.val(),a.on("click",i),g},setScheduled:function(a){e=a},isScheduled:function(){return e}}},panda.dashboardEpisode.bgm=function(){var a,b,c,d,e={},f=$(".bgm-add-wrap"),g=$(".bgm-play-wrap"),h=$("#bgmId"),i=$("#bgmTitle"),j="",k="",l=function(a){panda.stopEvent(a),j&&(h.val(j),i.val(k),g.find(".bgm-title").text(k),q()),m()},m=function(a){panda.hideOverlay(a)},n=function(a){panda.stopEvent(a),h.val(""),i.val(""),q(),d.pauseAll()},o=function(a){panda.stopEvent(a);var b=$(this).closest(".bgm-row"),e=b.find(".ico"),f=b.data("title"),g=b.data("id"),h=b.hasClass("selected");h||(j=g,k=f,c.find(".ico").removeClass("selected").replaceClass("sp-soundcloud-pause","sp-soundcloud-play"),c.find(".bgm-row").removeClass("selected")),d.pauseAll(),e.toggleClass("selected",!h),b.toggleClass("selected",!h)},p=function(a){panda.stopEvent(a),$.getJSON("/dashboard/episode/bgm",function(a){d.clear(),panda.showOverlay(e.setEvents($(a.data.html)),!0,d.pauseAll).find(".close-popup").on("click",m).end().find(".query").focus()})},q=function(){var a=""===h.val();g.toggleClass("hidden",a),f.toggleClass("hidden",!a)},r=function(a){panda.stopEvent(a);var b=$(this),e=b.closest(".bgm-row"),f=e.data("id"),g=b.find(".ico");d.pauseAll(),g.hasClass("sp-soundcloud-pause")?g.replaceClass("sp-soundcloud-pause","sp-soundcloud-play"):(d.play(f),c.find(".ico").replaceClass("sp-soundcloud-pause","sp-soundcloud-play"),g.replaceClass("sp-soundcloud-play","sp-soundcloud-pause"))},s=function(a){panda.stopEvent(a);var b=$(this),c=h.val(),e=b.find("i.js-icon");e.hasClass("sp-soundcloud-pause")?(d.pause(c),e.replaceClass("sp-soundcloud-pause","sp-soundcloud-play")):(d.play(c),e.replaceClass("sp-soundcloud-play","sp-soundcloud-pause"))};return e={init:function(){return d=panda.require("fn.soundCloud"),$(".bgm-btn").on("click",p),g.find(".delete-bgm").on("click",n),g.find(".play-pause-btn").on("click",s),q(),e},setEvents:function(d){var f=d.find("#bgmSearchForm").submit(e.search);return a=f.find(".query"),b=d.find(".search-desc"),c=d.find("#bgm-list"),d.find("#bgm-cancel-btn").on("click",m),d.find("#bgm-add-btn").on("click",l),d},search:function(e){var f=a.val();panda.stopEvent(e),d.pauseAll(),b.hide(),SC.get("/tracks",{q:f,limit:5,filter:"public"}).then(function(a){if(c.empty(),0===a.length)return b.text("We didn't find any results. Please check the spelling, or try a different search."),void b.show();$(a).each(function(a,b){var d=panda.templateCompile("bgm-row",{order:a+1,title:b.title,track_id:b.id,duration:moment(235139).format("mm:ss")});d.find(".play-pause-btn").on("click",r),d.find(".select-btn").on("click",o),c.append(d)})})}}},panda.dashboardEpisode.editor=function(){var a,b,c,d,e={},f=$(".js-mod-save");return e={init:function(g,h){return b=h,c=b.find("span"),d=b.data("limit"),a=new MediumEditor(g,{toolbar:{buttons:[{name:"bold",contentFA:'<i class="sp-bold inner"></i><i class="sp-bold-on hover"></i>'},{name:"italic",contentFA:'<i class="sp-italic inner"></i><i class="sp-italic-on hover"></i>'},{name:"quote",contentFA:'<i class="sp-quotation inner"></i><i class="sp-quotation-on hover"></i>'},{name:"h2",contentFA:'<i class="sp-heading inner"></i><i class="sp-heading-on hover"></i>'}],allowMultiParagraphSelection:!1},imageDragging:!1,buttonLabels:"fontawesome",placeholder:{text:"Write your story"},paste:{forcePlainText:!0,cleanPastedHtml:!0,cleanAttrs:["style"],cleanTags:["meta","script","a"]},extensions:{toolbar_states:new MediumEditorToolbarStates({states:{default:{buttons:["bold","italic","quote","h2"]},alternate:{buttons:["quote","h2"],nodeNames:["BLOCKQUOTE","H2"]}},hideClass:"mod-disabled"})}}),a.subscribe("editableInput",function(a){var e=a.target.textContent.length;b.data("length",e),c.text(panda.formattedString(e)),c.toggleClass("error",e>d),f.each(function(){$(this).toggleClass("disabled",e>d)}),e>d&&panda.showGlobalMessage("Please use "+d+" characters or less",!0)}),e}}},panda.namespace("dashboardRevenue"),panda.dashboardRevenue.main=function(){var a,b,c,d=2500,e=$(window),f=$(".js-request-payout-btn"),g=0;return a={init:function(d){return g=d.availableBalance,c=d.paypalEmail,b=panda.require("fn.validation"),panda.require("fn.dockedMenu"),panda.require("dashboardRevenue.stat",d),panda.require("dashboardRevenue.tooltip"),a.setEvents(),a},setEvents:function(){f.on("click",a.openPopup);var b=window.location.hash;b&&e.load(function(){var a=$(b);setTimeout(function(){panda.goToTop(null,a.offset().top)},300)})},openPopup:function(b){if(panda.stopEvent(b),!$(this).hasClass("disabled")){var c=panda.templateCompile("tpPayoutPopup");a.loadEmail(c),c.on("click",".js-email-edit",a.editEmail).on("click",".js-email-save",a.saveEmail).on("keydown",".js-email-input",a.enterEmail).on("click",".js-transfer-button",a.requestTransfer),panda.showOverlay(c,!0)}},loadEmail:function(a){""!==c&&(a.find(".js-email-save").addClass("hidden"),a.find(".js-email-edit").removeClass("hidden"),a.find(".js-email-label").removeClass("hidden").text(c),a.find(".js-email-input").addClass("hidden").val(c),a.find(".js-transfer-button").removeClass("disabled"))},editEmail:function(a){panda.stopEvent(a),$(this).addClass("hidden").next().removeClass("hidden"),$(".js-email-label").addClass("hidden"),$(".js-email-input").removeClass("hidden"),$(".js-transfer-button").addClass("disabled"),setTimeout(function(){$(".js-email-input").focus()},100)},enterEmail:function(b){panda.isEnter(b)?(panda.stopEvent(b),a.handleEmail($(this))):$(".js-email-save").removeClass("hidden")},handleEmail:function(b){var d=a.validateEmail(b),e=b.val().trim();if(d){if(c===e)return b.val(e),void a.renderEmail();a.updateEmail(b)}},saveEmail:function(b){panda.stopEvent(b),a.handleEmail($(".js-email-input"))},renderEmail:function(){$(".js-email-save").addClass("hidden"),$(".js-email-edit").removeClass("hidden"),$(".js-email-label").removeClass("hidden").text(c),$(".js-email-input").addClass("hidden"),$(".js-transfer-button").removeClass("disabled")},updateEmail:function(b){var d=b.val().trim(),e={paypalEmail:d,isPlain:!0};panda.showGlobalMessage("Saving payout information..."),$(".js-email-section").addClass("saving"),$.postJSON("/dashboard/revenue/payout-email/update",e,function(b){var d=b.data;c=d.email,$(".js-email-section").removeClass("saving"),a.renderEmail(),setTimeout(function(){panda.showGlobalMessage("Saved successfully.")},500)})},validateEmail:function(a){return a.one("validate.error",function(b,c){a.tooltip({placement:"bottom",trigger:"manual",html:!0,title:c}).tooltip("show"),a.focus(),setTimeout(function(){a.tooltip("destroy")},3e3)}),b.validateEmailInput(a)},requestTransfer:function(b){panda.stopEvent(b),!$(this).hasClass("disabled")&&a.isEnoughPayout()&&$.postJSON("/dashboard/revenue/payout",{},function(b){if(panda.hideOverlay(),200===b.code){var c=b.data;a.showRequestResult(c)}else panda.alert({body:b.msg})})},showRequestResult:function(a){var b=panda.templateCompile("tpPayoutResultPopup",a);panda.showOverlay(b,!0,function(){panda.goPage()})},isEnoughPayout:function(){return g>=d}}},panda.dashboardRevenue.stat=function(){var a,b,c,d,e,f,g,h,i,j={},k=$(".js-search-button"),l=0;return j={init:function(b){c=!b.hasHistories,d=b.hasAdProgram,e=b.hasCreatorTip,a=b.otherRevenueId,f=b.fromDate,g=b.toDate,i=panda.require("fn.dateUtils"),h=panda.require("dashboardChart.chart"),j.controlSearchNav(),j.setEvents()},setEvents:function(){k.on("click",j.searchStatsWithPeriod),a>0&&j.searchStats()},controlSearchNav:function(){k.filter(".search-next, .today").toggleClass("last",0===l)},searchStatsWithPeriod:function(a){panda.stopEvent(a);var b=$(this),c=b.data("period");b.hasClass("last")||(l+=c,b.hasClass("today")&&(l=0),j.controlSearchNav(),j.searchStats())},searchStats:function(){var j={};j.otherRevenueId=a,j.fromDate=f,j.toDate=g,j.period=l,j.kind="MONTH",$.getJSON("/dashboard/revenue/statistics",j,function(a){var f=a.data.stats,g=a.data.has_histories,l=a.data.has_more_data,m=a.data.stats_param,n=m.start_date,o=m.end_date,p=[],q=i.range(n,o,j.kind),r=function(a,b){for(var c=f.length,d=0;d<c;d++)if(f[d].base_date===a&&f[d].type===b)return f[d].sum;return 0};k.first().toggleClass("last",!l),$(".no-stats-message").toggleClass("hidden",g);var s=a.data.total_revenue,t=(s/100).toFixed(2);$(".js-total-revenue").text("$"+t),$.each(q,function(a,b){var c=r(b,"AD"),d=r(b,"TIP");p.push({date:b,ad:c,tip:d,totalRevenue:c+d})});var u={hasNoHistories:c,hasAdProgram:d,hasCreatorTip:e};h.drawRevenueStack(p,6,b,".monthly",u)})}}},panda.dashboardRevenue.history=function(){var a,b={},c="",d=$("#revenueHistoryTable"),e=$(".body-holder",d);return b={init:function(c){return a=c,$('[data-toggle="tooltip"]').tooltip(),b.setEvents(),b},setEvents:function(){panda.require("fn.dropdown",$(".js-dropdown-wrap"),b.selectOption),panda.require("dashboardRevenue.tooltip"),$(".export-list").on("click",b.historyDownload),d.on("click",".paging-prevnext",function(a){panda.stopEvent(a),b.loadHistory(null,$(this).getHref())})},selectOption:function(){b.loadHistory($(".js-dropdown").data("type"))},loadHistory:function(b,d){var f={};null!==b&&(f={otherRevenueId:a,period:"all"===b?"":b},c=f.period),$.getJSON("/dashboard/revenue/history"+(d||""),f,function(a){var b=a.data;e[0].innerHTML=b.html,$(".export-list").toggleClass("disabled",!b.has_histories)})},historyDownload:function(a){panda.stopEvent(a);var b=$(this);b.hasClass("disabled")||panda.goPage(b.getHref()+c)}}},panda.dashboardRevenue.tooltip=function(){return{init:function(){$(".js-help").tooltip({placement:"bottom",trigger:"hover",container:".dashboard-page"}),$(".js-help-fee").tooltip({placement:"bottom",trigger:"hover",html:!0,title:function(){return panda.templateCompile("tpHelpTooltip")}})}}},panda.namespace("dashboardTip"),panda.dashboardTip.main=function(){var a,b,c,d,e,f,g,h,i={},j=$(".js-stats-filter"),k=$(".js-sort-options"),l="",m=$("#tippersTable"),n=$(".header",m),o=$(".body-holder",m),p=$(".js-support-message"),q=$(".js-cancel-save"),r=$(".js-save-btn"),s=$(".js-file"),t=$(".js-remove-banner"),u=$(".js-input-wrap"),v=$(".js-button-wrap"),w=$(".js-cancel-goal"),x=$(".js-save-goal"),y=$(".js-edit-goal"),z=$(".js-remove-goal"),A=$(".js-new-goal"),B=$(".js-destroy-goal"),C=$(".js-goal-amount"),D=$(".js-progress-wrap"),E=$(".js-words");return i={init:function(h){return a=h,b=panda.require("fn.dockedMenu"),f=panda.require("fn.observer"),c=panda.require("dashboard.searchStats",{statsFilter:$(".js-stats-filter"),sortOptions:$(".js-sort-options"),searchBtns:$(".js-search-button")},i.searchStats),d=panda.require("fn.dateUtils"),e=panda.require("dashboardChart.chart"),g=panda.require("fn.fileUploadToS3"),panda.require("fn.dropdown",$(".js-dropdown-wrap"),i.selectOption),panda.require("dashboardTip.support"),i.setEvents(),i},setEvents:function(){return $('[data-toggle="tooltip"]').tooltip(),i.searchStats($("li.hidden",k),function(){b.refreshPositions(),a&&panda.require("dashboard.welcomePop","tpWelcomeCreatorTip")}),$(".card").on("click",function(){var a=$(this);if(a.hasClass("scroll")){var b=$(a.data("scroll"));panda.goToTop(null,b.offset().top)}else panda.goPage(a.getHref())}),m.on("click",".paging-prevnext",function(a){panda.stopEvent(a),i.loadTippers($(this).getHref())}),i.setSortingEvent(),i.loadWords(p),p.on("input",function(){i.loadWords($(this))}),r.on("click",i.saveMessage),q.on("click",i.cancelSaveMessage),s.on("change",i.saveBanner),t.on("click",i.removeBanner),$(".js-goal-type").on("change",i.selectGoalType),C.on("input",i.enterGoalAmount),w.on("click",i.cancelGoal),x.on("click",i.saveGoal),y.on("click",i.editGoal),z.on("click",i.removeGoal),A.on("click",i.prepareNewGoal),B.on("click",i.removeGoal),i},setSortingEvent:function(){n.on("click",".sortable",i.sortTipperList)},cancelGoal:function(a){var b=$(this),c=b.data("from");if(panda.stopEvent(a),!b.hasClass("disabled"))if("reach"===c){var d=f.getValue(C);C.val(d).next().text(d),$(".js-edit-mod").removeClass("hidden"),$(".js-save-mod").addClass("hidden"),v.addClass("hidden progressing"),D.removeClass("loading").addClass("loaded"),$(".js-goal-types").addClass("mod-reached").find(".js-goal-type").attr("disabled","disabled"),u.addClass("disabled")}else"ing"===c?(v.addClass("progressing").find(".js-edit-mod").removeClass("hidden"),u.addClass("progressing"),$(".js-save-goal").data("edit",!1)):($(".js-goal-type#none").click(),C.val(0).next().text(0))},cancelSaveMessage:function(a){var b=$(this);if(panda.stopEvent(a),!b.hasClass("disabled")){var c=f.getValue(p);p.val(c),i.loadWords(p),f.updateTargetValue(p),r.addClass("disabled"),b.addClass("disabled")}},compareAmount:function(a,b){var c=a.replace(/[^\d]+/g,""),d=b.replace(/[^\d]+/g,"");return c===d?0:c>d?1:-1},editGoal:function(a){panda.stopEvent(a),v.removeClass("progressing").find(".js-edit-mod").addClass("hidden"),u.removeClass("progressing"),$(".js-save-goal").data("edit",!0)},enterGoalAmount:function(){var a=$(this),b=a.val().trim(),c=i.getGoalAmount(b),d=c>0;a.val(panda.formattedString(pInt(c)));var e=f.isAltered(a);v.find("a").filter(".js-save-goal").toggleClass("disabled",!d||!e)},getGoalAmount:function(a){var b=a||C.val().trim();return panda.isNumber(b)||(b=b.replace(/[^\d]+/g,"")),b=b.replace(/\s+/g,"")},loadWords:function(a){var b=a,c=b.val().trim();E.text(c.length),E.parent().toggleClass("error",c.length>pInt(E.data("limit")));var d=f.isAltered(p);d&&(d=!E.parent().hasClass("error")),r.toggleClass("disabled",!d),q.toggleClass("disabled",!d)},loadTippers:function(a){var b=$(".js-selected").getHref(),c=$(".js-dropdown"),d="all"===c.data("type")?"":c.data("type"),e={period:d,uname:c.data("uname"),isDesc:$(".js-tipper-sort").hasClass("desc")};l=e.period,$.getJSON(b+(a||""),e,function(a){var b=a.data;o[0].innerHTML=b.html})},prepareNewGoal:function(a){panda.stopEvent(a),C.val(0).next().text(0),$(".js-edit-mod").addClass("hidden"),$(".js-save-mod").removeClass("hidden"),v.removeClass("hidden progressing"),$(".js-cancel-goal").removeClass("disabled"),D.removeClass("loaded").addClass("loading"),$(".js-goal-types").removeClass("mod-reached").find(".js-goal-type").removeAttr("disabled"),u.removeClass("disabled")},removeBanner:function(a){var b=$(this);panda.stopEvent(a),$.deleteJSON("/dashboard/tips/support-banner",{},function(){panda.showGlobalMessage("Banner removed."),b.addClass("hidden"),$(".js-thumb").prop("src","").addClass("hidden").next().removeClass("hidden")})},removeGoal:function(a){var b=$(this);panda.stopEvent(a),b.hasClass("disabled")||panda.alert({title:"remove active goal?",body:"Are you sure you want to remove the current goal? Participating supporters will be notified.",isConfirm:!0,cb:function(){v.find("a").addClass("disabled"),$.deleteJSON("/dashboard/tips/support-goal",{},function(a){var b=a.data,c=b.support_goal;$(".js-goal-types").removeClass("mod-reached").find(".js-goal-type").removeAttr("disabled"),$(".js-goal-type#none").click(),u.removeClass("progressing"),v.toggleClass("progressing",b.progressing).addClass("hidden").find("a").removeClass("disabled"),$(".js-save-goal").data("edit",!1),$(".js-goal-progress-outer").addClass("hidden"),i.updateProgress(c),C.val(c.amount).next().text(c.amount),f.updateTargetValue(C)})}})},saveBanner:function(){var a=$(this),b=a.data("type"),c=this.files[0],d=a.parent().next();panda.showLoading(),g.uploadToR(b,{files:c},function(a){var b=d.find(".js-thumb").prop("src",a.s3.url).removeClass("hidden default-bg").next();b.isExists()&&b.addClass("hidden"),$.postJSON("/dashboard/tips/support-banner",{isPlain:!0,uploadFile:JSON.stringify(a)},function(){t.removeClass("hidden"),panda.showGlobalMessage("Support banner saved.")})})},saveGoal:function(a){var b=$(this);if(panda.stopEvent(a),!b.hasClass("disabled")){var c=i.getGoalAmount();if(0!==c){var d=f.getValue(C);if(0!==i.compareAmount(d,c)){b.data("edit")||!1?i.updateGoal(c):i.setGoal(c,!1)}}}},saveMessage:function(a){var b=$(this);panda.stopEvent(a),b.hasClass("disabled")||$.postJSON(b.getHref(),{isPlain:!0,message:p.val()},function(){panda.showGlobalMessage("Message saved."),f.updateTargetValue(p),r.addClass("disabled"),q.addClass("disabled")})},searchStats:function(a,b){var f=a||$("li.hidden",k),g=c.values(),i={},l=$(f).data("kind");i.factor=g.factor,i.kind=l,$.getJSON(j.getHref(),i,function(a){var f=a.data.stats,g=a.data.is_daily,i=a.data.month,j=g?"day":"month",k=a.data.start_date.substring(0,10),l=a.data.end_date.substring(0,10),m=a.data.has_more_data,n=[];$(".search-prev").toggleClass("last",!m),$.each(f,function(a,b){b.date=b.base_date}),$.each(d.range(k,l,j),function(a,b){var d=c.getStatsData(f,b);void 0===d?n.push({sum:0,baseDate:b}):n.push(panda.convertKeyFromSnakeToCamel(d))}),e.drawTips(n,i,h,".tab-pane.tips",g),panda.callback(b)})},selectGoalType:function(){var a=$(".js-goal-type:checked").val(),b="total"===a;u.toggleClass("disabled",!b),v.toggleClass("hidden",!b)},selectOption:function(){i.loadTippers()},sortTipperList:function(){var a=$(this),b=a.hasClass("desc");n.find(".sorted").removeClass("asc desc"),a.addClass("sorted").addClass(b?"asc":"desc"),i.loadTippers()},setGoal:function(a,b){v.find("a").addClass("disabled"),$.postJSON("/dashboard/tips/support-goal",{isPlain:!0,amount:a,updated:b},function(a){var b=a.data,c=b.support_goal;u.addClass("progressing"),v.toggleClass("progressing",b.progressing).find("a").removeClass("disabled"),v.find(".js-edit-mod").removeClass("hidden"),$(".js-cancel-goal").data("from","ing"),$(".js-goal-progress-outer").removeClass("hidden"),i.updateProgress(c),C.next().text(panda.formattedString(c.amount)),f.updateTargetValue(C)})},updateGoal:function(a){$.getJSON("/dashboard/tips/support-goal/current-income",{},function(b){var c=b.data.income,d=pInt(a);if(c>0&&c>=d)return panda.alert({title:"hey!",body:"To set a goal lower than current progress, remove the active goal first"}),!1;panda.alert({title:"edit active goal?",body:"Are you sure you want to edit the current goal? Participating supporters will be notified.",isConfirm:!0,cb:function(){i.setGoal(a,!0)}})})},updateProgress:function(a){var b=a.amount,c=a.income,d=a.percentage;$(".js-progress-status").html('<span class="bold">'+panda.formattedString(c)+"</span> of "+panda.formattedString(b)).next().find("span").css({width:d+"%"}),D.removeClass("loaded loading"),a.reached?D.addClass("loaded"):D.addClass("loading")}}},panda.dashboardTip.support=function(){var a={},b=$(".js-message-load-more-btn");return a={init:function(){return a.setEvents(),b.on("click",a.loadMore),panda.require("fn.dropdown",$(".js-sort"),a.selectOption),panda.require("fn.dropdown",$(".js-filter"),a.selectOption),a},setEvents:function(){$(".js-message-wrapper").on("focus",".js-reply-input",a.readyToReply).on("input",".js-reply-input",a.countWords).on("click",".js-cancel-reply",a.cancelReply).on("click",".js-reply",a.sendReply).on("click",".js-edit",a.editReply)},cancelReply:function(b){var c=$(this),d=c.closest(".js-reply-wrap"),e=d.find(".js-reply-input"),f=d.find(".js-msg").text();panda.stopEvent(b),d.removeClass("editing"),""===f&&d.addClass("empty"),e.val(f),a.countWords.apply(e)},countWords:function(){var a=$(this),b=a.val().trim(),c=a.closest(".js-message-wrap"),d=c.find(".js-reply"),e=c.find(".js-reply-words");e.text(b.length),e.parent().toggleClass("error",b.length>pInt(e.data("limit"))),d.toggleClass("disabled",e.parent().hasClass("error"))},editReply:function(a){var b=$(this),c=b.closest(".js-reply-wrap"),d=c.find(".js-reply-input");panda.stopEvent(a),c.addClass("editing").removeClass("empty edited"),d.focus()},loadMore:function(a){panda.stopEvent(a);var b=$(this),c=b.data("sort"),d=b.data("page"),e=b.data("since");b.hasClass("disabled")||(b.addClass("disabled"),$.getJSON(b.getHref(),{isPlain:!0,sort:c,page:d,since:e},function(a){var c=a.data,d=c.body,e=$(d),f=e.filter(".js-separator:first-child"),g=$(".js-separator").last().attr("id"),h=f.data("key")===g;b.before(e),h&&$('[data-key="'+g+'"]').remove(),b.data("page",c.page).data("since",c.since).data("sort",c.sort_type).removeClass("disabled"),$(".js-separator").each(function(){$(this).attr("id",$(this).data("key"))}),c.has_more_message||b.remove()}))},readyToReply:function(){var b=$(this);b.closest(".js-reply-wrap").addClass("editing").removeClass("empty"),b.autogrow(),a.countWords.apply(b)},sendReply:function(b){panda.stopEvent(b);var c=$(this),d=c.closest(".js-reply-wrap"),e=d.find(".js-reply-input"),f=e.val().trim();if(c.hasClass("disabled"))return void e.focus();$.postJSON(c.getHref(),{isPlain:!0,message:f},function(b){var c=b.data.html,e=$(c);panda.showGlobalMessage("Reply saved."),e.filter(".js-edit").on("click",a.editReply),d.removeClass("empty editing").addClass("edited"),d.find(".js-msg").text(f),d.find(".js-desc").html(e)})},selectOption:function(){var a=$(".js-sort").find(".js-dropdown").data("type"),b=$(".js-filter").find(".js-dropdown").data("type"),c="/dashboard/tips/messages?sort="+a;b&&"ALL"!==b&&(c+="&filter="+b),panda.goPage(c)}}},panda.dashboardTip.supportHistory=function(){var a,b=$("#supportHistoryTable"),c=$(".header",b),d=$(".body-holder",b),e=function(){var b=$(this),c=b.data("type"),e=b.hasClass("asc");b.toggleClass("asc",!e).toggleClass("desc",e);var f=b.hasClass("desc"),g=f?1:-1;a||(a=d.find(".tr")),a.sort(function(a,b){var d=$(a).data(c),e=$(b).data(c);return(d===e?0:d>e?1:-1)*g}),a.appendTo(d.find(".contents"))};return{init:function(){c.on("click",".sortable",e)}}},panda.namespace("fn"),panda.fn.validation=function(){var a,b={},c=new RegExp(/^(?:[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+\.)*[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!\.)){0,61}[a-zA-Z0-9]?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\[(?:(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\.){3}(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\]))$/),d=new RegExp(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g);return b={init:function(c){return c&&(a=c),b},setErrorMessage:function(b){a.next().isExists()||a.after('<span class="field-error" id="error-'+a.attr("id")+'"></span>'),a.next().html(b)},checkErrorAllField:function(a,c){a.data&&a.data.errors&&a.data.errors.length>0?$.each(a.data.errors,function(a,d){b.setErrorAllMessage(d.message,d.field,c)}):200!==a.code&&b.setErrorAllMessage(a.msg)},setErrorAllMessage:function(a,b,c){b=b.replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\./g,"\\.");var d=c.find("#"+b);c.find("#error-"+b).isExists()||d.parent().after('<span class="field-error" id="error-'+b+'"></span>'),d.parent().next().html(a)},verifyPassword:function(){var b=this;return $(b.data("target")).val()!==b.val()&&a.val()?($(".js-error").find("p").text("Passwords do not match."),!1):($(".js-error").find("p").text(""),!0)},checkPassword:function(){var c=this;$(c.data("target")).val()!==c.val()&&a.val()?b.setErrorMessage("Passwords do not match."):a.next().remove()},validateEmail:function(a){return!(!(a=$.trim(a))||!c.test(a))||(a?"That doesn't look quite right.<br/>Please enter a valid email address.":"Email is required.")},validateEmailInput:function(a){if(a&&!a.isExists())return!1;var c=b.validateEmail(a.val());return!0===c||(a.trigger("validate.error",[c]),!1)},checkEmoji:function(){var a=$(this),b=$.trim(a.val()),c=a.next()&&a.next().hasClass("field-error");d.test(b)?c||(a.after('<span class="field-error" id="error-'+a.attr("id")+'"></span>'),a.next().html("You can not use emoji ")):c&&a.next().remove()},countWords:function(a){return a.trim().split(/\s+/).length}}},panda.fn.pagination=function(){return{init:function(){return{createPagerMultiOptions:function(a){var b,c=[],d=[],e=void 0!==a.data("listType")&&a.data("listType");for(b=0;b<a.data("sortLength");b++)c.push({property:a.data("sortProperty"+b),descending:void 0===a.data("sortDescending"+b)||a.data("sortDescending"+b)});for(b=0;b<a.data("searchLength");b++)d.push({property:a.data("searchProperty"+b),value:a.data("searchValue"+b)});return{pageNumber:a.data("pageNumber"),sortOrders:c,searchOptions:d,listType:e}}}}}},panda.fn.ajaxPaging=function(){var a,b,c,d,e,f=10,g=5,h=10,i=panda.require("fn.pagination"),j=!0;return{init:function(e,i,k,l,m,n,o){return d=this,a=e,k&&(g=k),i&&(f=i),l&&(h=l),void 0!==o&&(j=o),b=m,c=n,$(document).on("click",".g-act",d.load),b&&panda.setPopstateEvent(a,document.location.href),d},load:function(a){panda.stopEvent(a);var b=$(this),c=b.getHref(),e=i.createPagerMultiOptions(b);if(b.hasClass("disabled"))return!1;e.pageSize=f,e.blockSize=g,e.pageNumber=b.data("pageNumber"),e.pageElement=b.data("pageElement"),c=panda.makeUrl(c,e),d.go(c,e.pageElement)},go:function(d,f){e=d,b?(panda.pushGAPageView(d),$.getJSON(d,{},function(b){j&&panda.historyPushState({body:b.data.body,url:location.pathname+"#!"+d}),f?$(f).html(b.data.body):a.html(b.data.body),panda.callback(c)})):panda.goPage(d)},reload:function(){return!!e&&(d.go(e),!0)},update:function(b){a=b}}},panda.fn.tongue=function(){var a={};return a={init:function(){return a},toggleTongueUI:function(a,b){var c=a.data("tongue")||a.parent().find(".tongue-msg-wrap"),d=b?"error":"success",e=c.find(">div").addClass("hidden");c.data("originTop")?c.css("margin-top",c.data("originTop")):c.data("originTop",c.css("margin-top")),""!==b&&e.filter(".error").find(".tongue-msg").html(b),e.filter("."+d).removeClass("hidden").end(),"error"===d&&c.css("margin-top","-="+Math.ceil(c.height()/2)),a.removeClass("success error").addClass(d),a.hasClass("location")&&a.prev().removeClass("success error").addClass(d),a.data("tongue",c.removeClass("hidden"))},hiddenTongueUI:function(a){var b=a.data("tongue")||a.parent().find(".tongue-msg-wrap");b.addClass("hidden"),a.removeClass("success error").data("hasError",!1).data("tongue",b).prev().removeClass("success error")}}},panda.fn.shares=function(){var a,b,c,d,e,f=!1;return a={init:function(b){return d=b.on("click",a.toggleShare),c=b.next(),e=c.find(".share > .third-party").on("click",a.goShare),a},toggleShare:function(b){panda.stopEvent(b),f||(a.updateShareCount(!0),f=!0);var c=$(this),e=c.hasClass("on");c.toggleClass("on").next().toggleClass("hidden",e),e?$(window).off("click"):(d.trigger("open.box"),a.updateShareCount(),$(window).one("click",function(){d.trigger("click")}))},goShare:function(a){var c=$(this),d=c.data("where"),e=c.attr("href");panda.stopEvent(a),b=c,panda.openSharePopup(d,e,null),$(window).trigger("click")},updateShareCount:function(c){c?e.each(function(){var b=$(this);a.requestCount(b)}):b&&a.requestCount(b)},requestCount:function(a){$.postJSON("/share/counter/"+a.data("where"),{url:panda.getEnvs("currentUrl"),isPlain:!0,isSkipCommonAlert:!0},function(c){200===c.code&&a.find(".num").html(c.data.count),b=void 0})}}},panda.fn.lazyLoad=function(){var a,b=!1,c={},d=function(){b=!0;for(var a in c){var d=$(c[a].el);!0!==d.data("load")&&panda.isInViewPort(c[a].el)&&(panda.pushGAPageView("/episode/"+d.data("episodeId")+"/content/"+d.data("idx")),d.data("src")&&d.attr("src",d.data("src")),d.data("load",!0),delete c[a])}b=!1};return a={init:function(){return $("img.lazy").each(function(){var a=$(this).data("uid");c[a]={el:this}}),$(window).on("scroll",a.loadImage).on("resize",a.loadImage),a},loadImage:function(){if(b||$.isEmptyObject(c))return!0;d()}}},panda.fn.lazyLoadVertical=function(){var a,b,c,d,e=!1,f={};return a={init:function(c){return b=c.on("on.scroll",a.loadImage).find("img.lazy-vertical").each(function(){var a=$(this).data("uid");f[a]={el:this}}).end(),a.updateWrapHeight(),$(window).on("resize",function(){a.loadImage()}),b.trigger("on.scroll"),a},updateImages:function(){return b.find("img.lazy-vertical").filter(function(){return!$(this).data("load")}).each(function(){var a=$(this).data("uid");f[a]={el:this}}),a},updateWrapHeight:function(){return!!panda.isInViewPort(b[0],0)&&(c=b.height(),d=b[0].getBoundingClientRect().top,!0)},isInit:function(){return void 0!==c},loadImage:function(){if(e||$.isEmptyObject(f))return!0;a.__loadImage()},__loadImage:function(){if(!a.updateWrapHeight())return!1;e=!0;for(var b in f){var c=$(f[b].el);!1!==c.data("isTarget")&&!0!==c.data("load")&&a.isInViewPort(f[b].el)&&(c.attr("src",c.data("src")).data("load",!0).removeClass("lazy-vertical"),delete f[b])}e=!1},isInViewPort:function(a){var e=a.getBoundingClientRect(),f=b.scrollTop(),g=e.top-d;return g>=-e.height&&g<=c+f}}},panda.fn.lazyLoadHorizon=function(){var a,b,c,d,e=!1,f={};return a={init:function(c){return b=c.on("on.scroll",a.loadImage).find("img.lazy-horizon").each(function(){var a=$(this).data("uid");f[a]={el:this}}).end(),a.updateWrapWidth(),$(window).on("resize",function(){a.updateWrapWidth(),a.loadImage()}),b.trigger("on.scroll"),a},updateWrapWidth:function(){c=b.width(),d=b[0].getBoundingClientRect().left},loadImage:function(){if(e||$.isEmptyObject(f))return!0;a.__loadImage()},__loadImage:function(){e=!0;for(var b in f){var c=$(f[b].el);!1!==c.data("isTarget")&&!0!==c.data("load")&&a.isInViewPort(f[b].el)&&(c.attr("src",c.data("src")).data("load",!0).removeClass("lazy-horizon"),delete f[b])}e=!1},isInViewPort:function(a){var e=a.getBoundingClientRect(),f=b.scrollLeft(),g=e.left-d;return g>=-e.width&&g<=c+f}}},panda.fn.scrollLoader=function(){var a,b={},c=$(window),d=$(document),e=!1,f=!1,g=!0;return b={init:function(d){return f=d&&d.isExists(),f&&(a=d,b.resume(),c.on("scroll",function(){c.trigger("scroll.loader")})),b},scrollLoader:function(){return panda.scrollTop()+c.height()+250>=d.height()&&!e&&(e=!0,a.trigger("scroll.loader.load")),b},release:function(){return f&&(c.off("scroll.loader"),g=!0),b},resume:function(){g&&c.on("scroll.loader",b.scrollLoader)},callback:function(){return e=!1,b},isOff:function(){return g}}},panda.fn.saveWarning=function(){var a,b,c,d="warning-popup",e={},f=$(window);return a={init:function(f){return f&&f.observer?(b=f.observer,d=f.template||d,e=f.params||e):b=panda.require("fn.observer"),$('a:not([href^="#"]), [data-href]').on("click",function(f){var g=$(this);if("_blank"!==g.prop("target")&&(a.release(),b.isChanged())){panda.stopEvent(f);var h=panda.templateCompile(d,e).find(".js-cancel").on("click",function(a){panda.stopEvent(a),panda.hideOverlay(),c&&panda.callback(c,g)}).end().find(".js-action").on("click",function(a){panda.stopEvent(a),panda.goPage(g.getHref())}).end();panda.showOverlay(h,!0)}}),a.setEvent(),a},setEvent:function(){f.on("beforeunload",function(){if(b.isChanged())return"Do you want to leave without saving?"})},setStayPageCallback:function(b){return c=b,a},release:function(){f.off("beforeunload")},getObserver:function(){return b},refreshObserverTargets:function(){b.refreshTargets&&b.refreshTargets()}}},panda.fn.observer=function(){var a,b={};return a={init:function(){return a.watchObserver(),a},refreshTargets:function(){$(".observer").each(function(){var a=$(this),c=a.data("uid");b[c].target=a})},getValue:function(a){var c=$(".observer").filter(a);if(c){var d=c.data("uid");return void 0===d||""===d?"":b[d].value}},updateTargetValue:function(a){var c=$(".observer").filter(a);if(c){var d=c.data("uid");void 0!==d&&""!==d||(d=panda.uid("_ob_"),a.data("uid",d)),b[d]={value:a.obValue(),target:a}}},watchObserver:function(){$(".observer").each(function(){var a=$(this),c=a.data("uid");void 0!==c&&""!==c||(c=panda.uid("_ob_"),a.data("uid",c)),b[c]||(b[c]={value:a.obValue(),target:a})})},isAltered:function(a){var c=$(".observer").filter(a);if(c){var d=c.data("uid");return void 0!==d&&""!==d&&b[d].value!==a.obValue()}return!1},isChanged:function(){var a=!1;return $.each(b,function(b,c){if(!a){var d=c.target;d.isExists()&&c.value===d.obValue()||(a=!0)}}),a},hasElement:function(a){var c=!1;return $.each(b,function(b,d){var e=d.target;e.isExists()&&d.value!==e.obValue()&&e.attr("id")===a.attr("id")&&(c=!0)}),c},refresh:function(){return a.watchObserver(),a},clear:function(){b={},a.refresh()}}},panda.fn.dockedSideBar=function(){var a,b,c,d,e,f={},g=$(window),h=!1,i=!1;return f={init:function(c){a=c;var h=a.data("bottomTargetEl");return h&&(b=$(h)),e=a.outerHeight(),d=Math.ceil(a.offset().top-70),f.refreshPositions(),g.on("scroll",f.dockedSideBar).on("resize",function(){setTimeout(function(){f.refreshPositions(),f.dockedSideBar()},10)}),f},refreshPositions:function(){return c=window.innerHeight||document.documentElement.clientHeight,f},dockedSideBar:function(){var g=panda.scrollTop(),j=a[0].getBoundingClientRect();return e+70<=c?(h&&(a.removeClass("bottom-docked"),h=!1),!i&&g>d?(a.addClass("docked"),i=!0):i&&g<d&&(a.removeClass("docked"),i=!1)):(i&&(a.removeClass("docked"),i=!1),!h&&j.bottom+20<=c?(a.addClass("bottom-docked"),h=!0):h&&g<d&&(a.removeClass("bottom-docked"),h=!1)),b&&(!a.hasClass("bottom")&&j.bottom>b[0].getBoundingClientRect().bottom?a.addClass("bottom"):a.hasClass("bottom")&&(b[0].getBoundingClientRect().bottom>c||a.offset().top-70>g)&&a.removeClass("bottom")),f}}},panda.fn.dockedMenu=function(){var a,b,c,d,e={},f=!1,g=$(window),h=$(".shortcut-nav"),i=h.find(".item-title:not(.side-btn)"),j=$(".fake-shortcut-nav");return e={init:function(b,f){c=b,d=f,e.refreshPositions(),d||i.on("click",e.goSection);var j=h.data("defaultTab");return j&&(a=i.filter("."+j)),g.on("scroll",e.dockedMenu).on("resize",e.refreshPositions),e},selectDefaultNav:function(){a&&a.addClass("selected")},dockedMenu:function(){var a=panda.scrollTop();!f&&h.offset().top-a<0?(f=!0,h.addClass("docked")):f&&a<=b&&(h.removeClass("docked"),d||i.removeClass("selected"),e.selectDefaultNav(),f=!1),f&&!d&&i.each(function(){var b=$(this);b.data("which")<=a+80&&(i.removeClass("selected"),b.addClass("selected"))}),c&&c(f,i.filter(".selected"))},calShortcutNavPosition:function(){try{$(".js-shortcut-nav-section").each(function(){var a=$(this),b=$(this).data("id");i.filter("."+b).data("which",a.offset().top-h.height())})}catch(a){panda.log("calShortcutNavPosition"),panda.log(a)}},goSection:function(a){panda.stopEvent(a);var b=$(this);panda.goToTop(a,b.data("which"),function(){setTimeout(function(){i.removeClass("selected"),b.addClass("selected")},100),e.calShortcutNavPosition()},!0)},refreshPositions:function(){b=Math.ceil(j.offset().top),e.calShortcutNavPosition(),setTimeout(function(){g.trigger("scroll")},200)},moveTo:function(a){i.filter("."+a).trigger("click")}}},panda.fn.radio=function(){return{init:function(a,b){a.on("change",b)}}},panda.fn.dropdown=function(){var a,b,c,d,e,f={},g=function(a){b?b.removeClass("on"):a.removeClass("on")},h=function(a){panda.stopEvent(a);var c=$(this),f=c.data("type");if(c.hasClass("js-link"))return void panda.goPage(c.children().getHref());b.data("type",f).find(".js-selected > span").text(c.children().data("label")),g(),d.removeClass("hidden").filter("[data-type="+f+"]").addClass("hidden"),panda.callback(e)};return f={init:function(b,c){return a=b,e=c||$.noop(),f.setEvents(),f},setEvents:function(){a&&(b=a.find(".js-dropdown"),c=a.find(".js-options"),d=c.find("li"),b.on("click",f.toggleDropdown),d.on("click",h))},getId:function(){return b.data("type")},getScene:function(){return b.data("scene")||0},select:function(a){var e=a.parent();b=e.parent().prev(),c=e.parent(),d=c.find("li"),h.apply(e)},setOption:function(){$(".js-selected > span",b).text(d.filter(".hidden").children().data("label"))},toggleDropdown:function(a){var b=$(this);if(b.hasClass("unavailable"))return!1;b.toggleClass("on"),panda.stopEvent(a),b.hasClass("on")?$(window).one("click.closed",function(){g(b)}):$(window).off("click.closed")}}},panda.fn.tagging=function(){var a,b={},c=$(".tags"),d=$(".hide-tag"),e=function(){var d=$(this),e=d.val().trim();if(!1!==b.editTag("add",e)&&e.length<=100){var g=c.find(".tag-wrap").length,h=panda.templateCompile("tag",{"tag.name":e.trim(),"tag.idx":"tags["+g+"].name","tag.id":"tags["+g+"].id"});h.find(".js-remove-tag").on("click",f),c.append(h),panda.callback(a)}d.val("")},f=function(d){panda.stopEvent(d);var e=$(this).closest(".tag-wrap");b.editTag("remove",e.find(".tag-name-value").val()),e.remove(),c.find(".tag-name-value").each(function(a){var b=$(this),c=b.next();b.attr("name",b.attr("name").replace(/(\d+)/g,a)),c.isExists()&&c.attr("name",c.attr("name").replace(/(\d+)/g,a))}),panda.callback(a)},g=function(a){panda.stopEvent(a);var b=$(this),c=$(this).val().replace(/[^\s\w\d]+/g,"");c=c.replace(/\s+/g,"_"),b.val(c)};return b={init:function(c){return a=c,b.setEvents(),b},setEvents:function(){return $(".js-tag-text").on("keydown",function(a){panda.enter2submit(a,{fn:e,scope:this})}).on("input",g),$(".js-remove-tag").on("click",f),b},editTag:function(a,c){var e=d.val().split(" "),f=$.inArray(c,e);if("add"===a){if(-1!==f)return!1;e.push(c)}else e.splice(f,1);return d.val(e.join(" ")),b}}},panda.fn.contentFileManager=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n={},o=0,p=0,q=0,r=0;return n={init:function(g,h){return m=panda.require("fn.fileUploadToS3"),b=g,h&&(a=h),c=b.find(".file-count-wrap > .file-count"),d=b.find("#content-files-list"),e=d.find(".drop-target"),f=d.find(".no-files"),d.on("click",".content-row",n.rowSelected).on("click",".delete-row",n.deleteRow),n.setDnDEvent().setFileCount(),n},getTotalCount:function(){return o},setTotalCount:function(a){o+=a,n.setFileCount()},setFileCount:function(){return c.html(o),n},deleteRow:function(a,b){panda.stopEvent(a);var c=$(this),d=c.closest(".content-row").remove().hasClass("failed");n.toggleNoFiles(),d||n.setTotalCount(-1),n.setSelectedRowCounter().reorderingRows(),b||n.fireFileDeleteEvent()},fireFileDeleteEvent:function(){var a=[];n.makeContentFileInfo(function(b){b.url&&a.push(b.value)}),b.trigger("file.deleted",[a])},markUploading:function(){i=!i},setDnDEvent:function(){return d.on("dragenter",".content-row",n.dragenter).on("drop",".content-row",n.drop).on("dragstart",".content-row",n.dragStart).on("dragover",".content-row",n.dragoverNleave).on("dragleave",".content-row",n.dragoverNleave).on("dragend",".content-row",n.dragend),n},dragStart:function(a){var b,c=$(this),d=n.getSelectedRows(),e=d.length,f=n.getAllRows().length;if(0===e||f===e||!c.hasClass("on"))return panda.stopEvent(a),!1;b=a.originalEvent.dataTransfer,b.effectAllowed="move",b.setData("Text",""),b.setDragImage(l,25,20)},dragenter:function(a){var b=$(this),c=this.offsetHeight,d=b.offset().top;b.data("exclude")||(d+c/2>a.originalEvent.clientY?(h="top",b.before(e)):(h="bottom",b.after(e))),e.removeClass("hidden")},dragoverNleave:function(a){return panda.stopEvent(a),!1},drop:function(a){return panda.stopEvent(a),$.each(n.getSelectedRows(),function(a,b){e.before(b)}),!1},dragend:function(a){panda.stopEvent(a),e.addClass("hidden"),n.reorderingRows(!1)},makeDragImage:function(a){if(0===a||q===a||!panda.isFileUploadSupport())return!1;q=a;var b=n.createCanvas(),c=b.getContext("2d");c.drawImage($("#dnd-proxy")[0],0,0),c.font="13px/32px Verdana",c.textAlign="center",c.fillStyle="white",c.textBaseline="middle",c.fillText(q,16,16),l||(l=document.createElement("img"),l.width=32,l.height=32),l.src=b.toDataURL()},createCanvas:function(){return g||(g=document.createElement("canvas"),g.width=32,g.height=32),g},getSelectedRows:function(){return n.getRows(".on")},getFailedRows:function(){return n.getRows(".failed")},getReadyRows:function(){return n.getRows(".ready")},getSelectedRowsCount:function(){return n.getSelectedRows().length},getRows:function(a){return n.getAllRows().filter(a)},getAllRows:function(){return d.find(".content-row")},rowSelected:function(a){if(panda.stopEvent(a),i)return!1;var b=$(this),c=b.data("idx"),d=j>c?c:j,e=j<c?c:j,f=b.hasClass("on");if(a.shiftKey){if(j===c)return!1;n.getAllRows().filter(function(a){return d<=a&&e>=a&&$(this).hasClass("ready")}).addClass("on")}else{if(a.ctrlKey||a.metaKey||(n.cleanSelected(!1),n.setSelectedRowCounter()),!b.hasClass("ready"))return!1;b.toggleClass("on",!f)}return j=c,n.makeDragImage(n.getSelectedRowsCount()),n.setSelectedRowCounter(),n},cleanSelected:function(a){return n.getSelectedRows().removeClass("on"),a&&(j=0),n},setSelectedRowCounter:function(){return n},deleteSelectedRow:function(a){panda.stopEvent(a),n.getSelectedRows().find(".delete-row").trigger("click",!0),n.fireFileDeleteEvent()},formatFileSize:function(a){if("number"!=typeof a)return"";var b,c="kb";return a>=1e9?(b=(a/1e9).toFixed(1),c="gb"):a>=1e6?(b=(a/1e6).toFixed(1),c="mb"):b=(a/1e3).toFixed(0),b+'<span class="size-format">'+c+"</span>"},uploadFiles:function(a){if(i)return!1;n.markUploading(),n.cleanSelected(!0);var b=a[0];r=1,b.files?(panda.preUploadingHook(b.files,function(a){r=a.length,$.each(a,function(){n.__uploadFile(this,!0)})}),panda.cleanUpFileInput(a)):n.__uploadFile(b,!1)},addFiles:function(a){return $.each(a,function(c,e){n.setTotalCount(1);var f=e.file,g=panda.templateCompile("file-row",{idx:c,order:c+1,fileName:f.filename,fileSize:""}).data("id",e.id).data("file",f).data("pile.id",e["pile.id"]).replaceClass("ing","ready");g.find(".order").data("val",c).next().data("val",f.filename).next().html(n.formatFileSize(f.size)),d.append(g),b.trigger("file.uploaded",[f]),a.length-1===c&&k&&(panda.callback(k),b.trigger("file.upload.end"))}),n},__uploadFile:function(a,c){var e,f,g,h={},i="Uploading..",j=p++,k=function(a,c){e.data("tObject")&&clearTimeout(e.data("tObject")),e.replaceClass("ing",a).attr("data-is-new","true").find(".file-size").html(n.formatFileSize(i)).end().find(".error-msg").html(c),0==--r&&(n.markUploading(),n.reorderingRows(),b.trigger("file.upload.end"))},l=function(a){e.find(".progress-wrap").css({width:"100%"}),i=a.size,e.data("file",a),a.order=j,b.trigger("file.uploaded",[a]),k("ready","")},q=function(a){n.setTotalCount(-1),k("failed",a.brief_message||a.message)};n.setTotalCount(1),c?(g=a.name||a.fileName,h.file=a,i=a.size,f=function(a){e.find(".file-size").html(n.formatFileSize(a.loaded)+" / "+n.formatFileSize(i)).end().find(".progress-wrap").css({width:Math.round(100*a.loaded/a.total)+"%"}),a.loaded===a.total&&e.data("tObject",setTimeout(function(){e.find(".error-msg").html('<div class="dotindicator"></div> It may take a minute to complete, please wait.'),e.data("tObject",setTimeout(function(){e.find(".error-msg").html('<div class="dotindicator"></div> It\'s taking longer than expected to process your image.')},6e4))},1e4))}):g=a.value,e=panda.templateCompile("file-row",{idx:o-1,order:o,fileName:g,fileSize:"number"==typeof i?"0 / "+n.formatFileSize(i):i}),e.find(".order").data("val",j).next().data("val",g),d.append(e),n.toggleNoFiles(),o<41?m.uploadToR("CARTOON",{files:a},l,{progressCallback:f,errorCallback:q}):q({message:"You can upload up to 40 images."})},updateContentFileInfos:function(){a&&(a.empty(),n.makeContentFileInfo(function(b){a.appendHiddenField({name:b.name,value:JSON.stringify(b.value)||""})}))},getContentFileInfos:function(){var a=[];return n.makeContentFileInfo(function(b){b.url&&a.push(b.url)}),a},makeContentFileInfo:function(a){$.each(n.getReadyRows(),function(b){var c=$(this);panda.callback(a,{name:"contents["+b+"].id",value:c.data("id")}),panda.callback(a,{name:"contents["+b+"].file",value:c.data("file"),url:c.data("file").s3.url});var d=c.data("pile.id");d&&panda.callback(a,{name:"contents["+b+"].pile.id",value:d})})},reorderingRows:function(a){var b=1;return $.each(n.getAllRows(),function(a){var c=$(this),d="-";c.data("idx",a),c.hasClass("ready")&&(d=b++),c.find(".order").html(d)}),!1!==a&&n.setFileCount(),k&&panda.callback(k),n},setChangedFileCallback:function(a){return k=a,n},hasNewContents:function(){return d.find(".content-row").filter(function(){return!0===$(this).data("isNew")}).isExists()},hasFailedContents:function(){return d.find(".content-row").filter(function(){return $(this).hasClass("failed")}).isExists()},toggleNoFiles:function(){f.toggleClass("hidden",n.getAllRows().length>0)}}},panda.fn.sort=function(){var a,b,c,d={};return d={init:function(b,c){return a=b,c.on("click",d.sort),d},setSortCallback:function(a){b=a},sort:function(e){panda.stopEvent(e),c=$(a);var f=$(this),g=f.data("orderby"),h=f.data("sortBy")||"asc",i="asc"===h?"desc":"asc";f.data("sortBy",i).replaceClass(h,i);for(var j=c.length-1;j>0;j--)for(var k=0;k<j;k++){var l=c.eq(k),m=c.eq(k+1);d.sortBy(l.find("."+g).data("val"),m.find("."+g).data("val"),h)&&(m.after(l),c=$(a))}panda.callback(b,f)},sortBy:function(a,b,c){return"asc"===c?a>b:a<b}}},panda.fn.calendar=function(){var a,b,c,d,e,f,g,h,j,k={},l=["january","february","march","april","may","june","july","august","september","october","november","december"];return k={init:function(a){return k.setYYYMMDD(a),g=+new Date(d,e-1,f),k},setYYYMMDD:function(a){a&&(d=a.year(),e=a.month()+1,f=a.date())},load:function(d){return d&&(k.setYYYMMDD(d),h=d.format("YYYY/M/D")),a=$("#calendar"),b=a.find(".body"),c=a.find(".cal-label"),a.find(".btn-month").on("click",k.changeMonth),k.render(),k},selectDay:function(a){panda.stopEvent(a);var c,f=$(this);if(!f.hasClass("on")&&f.hasClass("can")){c=b.find(".on"),c.replaceClass("on",c.data("isToday")),f.hasClass("today")&&f.data("isToday","today"),f.replaceClass("today","on");var g=moment([d,e-1,f.data("day")]);h=g.format("YYYY/M/D"),panda.callback(j,g)}},changeMonth:function(a){panda.stopEvent(a),e+=$(this).data("idx"),13===e?(e=1,d+=1):0===e&&(d-=1,e=12),k.render()},render:function(){c.html(l[e-1]+" "+d),b.empty();var a=(d+(d-d%4)/4-(d-d%100)/100+(d-d%400)/400+2*e+(5*e-5*e%9)/9-(e<3?d%4||d%100==0&&d%400?2:3:4))%7;for(i=0;i<42;i++)if(i<a||i>=a+(9*e-9*e%8)/8%2+(2===e?d%4||d%100==0&&d%400?28:29:30))b.append('<li class="nil"></li>');else{var f,g=i+1-a,j=k.compareDates(d,e,g);f=0===j?"today can":1===j?"can":"post",h===d+"/"+e+"/"+g&&(f+=" on"),b.append('<li class="'+f+'" data-day="'+g+'">'+g+"</li>")}return b.find(".can").on("click",k.selectDay),k},compareDates:function(a,b,c){var d=+new Date(a,b-1,c);return g===d?0:g>d?-1:1},setOnSelected:function(a){j=a}}},panda.fn.soundCloud=function(){var a={},b={};return a={init:function(){return SC.initialize({client_id:panda.getEnvs("soundCloudKey")}),a},clear:function(){return a.pauseAll(),b={},a},play:function(a){b[a]?(b[a].seek(0),b[a].play()):SC.stream("/tracks/"+a).then(function(c){c.setVolume(.4),c.play(),b[a]=c})},pauseAll:function(){for(var c in b)Object.prototype.hasOwnProperty.call(b,c)&&a.pause(c)},pause:function(a){b[a]&&b[a].pause()}}},panda.fn.timepicker=function(){var a,b,c={},d="YYYY-MM-DD",e=!0,f=!0;return c={init:function(d,g){var h=d||$(".pikaday");return g&&(e=void 0===g.allowToday?e:g.allowToday,f=g.allowPast,a=g.onDraw,b=g.onSelect),h.each(function(){var a=$(this);c.render(a.get(0))}),c},render:function(c){new Pikaday({field:c,format:d,allowPast:f,allowToday:e,firstDay:0,onDraw:function(){var b=$(".pika-title .pika-label:eq(0)");b.find("select").remove();var c=Number(moment(b.text(),"MMM").format("M")),d=$(".pika-title .pika-label:eq(1)");d.find("select").remove();var e=Number(d.text());a&&a.apply(this,[e,c])},onSelect:function(){if(b){var a=this.getMoment(),d=Number(a.format("YYYY")),e=Number(a.format("M")),f=Number(a.format("D"));b.apply(this,[d,e,f,c])}}})}}},panda.fn.elObserver=function(){var a,b,c={},d=0,e=0;return c={init:function(a){return b=a,b.data("beforeElHtml",b.html()),c.listen(),c},listen:function(){return a=setInterval(function(){e++;var a=b.html();b.data("beforeElHtml")!==a&&(d++,b.data("beforeElHtml",a),b.trigger("change.el"),c.release()),60===e&&c.release()},500),c},changedCount:function(){return d},release:function(){return clearInterval(a),c}}},panda.fn.tinyscrollbar=function(){var a,b;return a={init:function(c,d){return b=c,b.on("reach.scroll",d.reachFn||a.ctrScroll).tinyscrollbar(d),$("a.shadow",b).on("click",a.moveScroll),a},getScrollbar:function(){return b},moveTo:function(a){b.tinyscrollbar_move(a)},moveScroll:function(b){panda.stopEvent(b);var c=$(this);c.hasClass("none")||a.moveTo(c.data("way"))},ctrScroll:function(a,b){var c=$(this),d=$(".shadow",c);c.data("hasScrollbar")?(d.removeClass("none"),"none"!==b&&d.filter("."+b).addClass("none")):d.addClass("none")},update:function(a){b.tinyscrollbar_update(a||"")}}},panda.fn.cookie=function(){var a;return a={init:function(){return a},setCookie:function(a,b,c){var d=new Date;d.setTime(d.getTime()+1e3*c),b=escape(b)+(void 0===c?"":"; expires="+d.toUTCString()),document.cookie=a+"="+b+";domain=.tapas.io;path=/;"},getCookie:function(a){var b,c,d,e=document.cookie.split(";");for(b=0;b<e.length;b++)if(c=e[b].substr(0,e[b].indexOf("=")),d=e[b].substr(e[b].indexOf("=")+1),(c=c.replace(/^\s+|\s+$/g,""))===a)return unescape(d);return null}}},panda.fn.dateUtils=function(){var a={init:function(){return a},range:function(a,b,c){c=c&&"month"===c.toLowerCase()?"months":"days";var d=moment(a),e=moment(b),f=e.diff(d,c),g=[],h="months"===c?"YYYY-MM-01":"YYYY-MM-DD";g.push(d.format(h));for(var i=0;i<f;i++)g.push(d.add(1,c).format(h));return g},getTime:function(a,b,c,d){return 0===a?0===b?0===c?d+"s":c+"m "+d+"s":b+"h "+c+"m "+d+"s":a+"d "+b+"h "+c+"m "+d+"s"},getShortTime:function(a,b,c,d){return 0===a?0===b?0===c?d+"s":c+"m "+d+"s":b+"h "+c+"m":a+"d "+b+"h"}};return a},panda.fn.carousel=function(){var a,b,c,d,e,f;return a={init:function(b){d=b.$el,c=b.delay||400,f=d.find(".tp-carousel-item"),e=d.find(".js-nav-btn"),d.on("click",".js-nav-btn",a.turnOver)},turnOver:function(d){panda.stopEvent(d);var e,g,h=$(this),i=h.data("direction"),j="prev"===i?"right":"left";h.hasClass("hidden")||b||(b=!0,e=f.filter(".active").addClass(j),g=e[i]().addClass(i),g.offset(),g.addClass(j),setTimeout(function(){e.removeClass(["active",j].join(" ")),g.addClass("active").removeClass([i,j].join(" ")),a.afterTurnOver(g)},c))},afterTurnOver:function(a){b=!1,e.filter(function(){var b=$(this);b.toggleClass("hidden",!a[b.data("direction")]().isExists())})}}},panda.fn.deleteAccount=function(){var a,b={};return b={init:function(c){a=c,a.on("click",b.showModal)},showModal:function(a){panda.stopEvent(a);var c=panda.templateCompile("tpDeleteAccount");panda.showOverlay(c,!0),$(".close-btn",c).on("click",panda.hideOverlay),$(".delete-btn",c).on("click",b.deleteAccount)},deleteAccount:function(a){panda.stopEvent(a);var b=$(this);$.postJSON(b.getHref(),{},function(a){if(200===a.code)panda.goPage("/account/signout");else if(406===a.code){panda.hideOverlay();var b=panda.templateCompile(a.data.template);panda.showOverlay(b,!0)}})}}},panda.fn.fileUploadToS3=function(){var a,b={},c=function(a){return $("<form />").attr({method:"post",action:a,enctype:"multipart/form-data"}).hide().appendTo("body")},d=function(){return c(panda.getEnvs("rTapasIoHost")+"/file/resize-novel-asset")},e=function(b,c,d,e){panda.isFileUploadSupport()?$.ajaxFileUpload(b.getHref(),b[0],c,function(a){b.remove(),panda.callback(d,a)},e):(b.attr({target:"hidden-iframe"}),a=setTimeout(function(){window.iframeCallback=void 0},2e4),window.iframeCallback=function(b){a&&clearTimeout(a),panda.callback(d,b),window.iframeCallback=void 0},b.submit())};return b={init:function(){return b},createForm:function(a){return c(panda.getEnvs("rTapasIoHost")+"/file/upload/"+a)},uploadToR:function(a,c,d,f){var g=b.createForm(a);e(g,c,d,f)},resizeBase64:function(a,b,c){var f=d();e(f,a,b,c)}}},panda.fn.showDoneIt=function(){var a={},b=$("#doneit"),c=function(){b.isExists()||(b=$('<div id="doneit">'),$("body").append(b))};return a={init:function(){return b.isExists()||c(),a},showMessage:function(a){clearTimeout(b.data("tobj")),b.html(a).replaceClass("force pan","on").data("tobj",setTimeout(function(){b.html("").replaceClass("on","force pan")},2e3));var c=document.documentElement.clientHeight,d=b.height(),e=(c-d)/2,f=b.width()+60;b.css({"margin-left":-f/2+"px",top:e+"px"})}}},panda.fn.evCountdown=function(){var a,b,c=!1,d={init:function(e,f){a=new Date(e).getTime(),a>=(new Date).getTime()&&(b=setInterval(d.calculate,1e3)),c=f||!1},calculate:function(){var d,e,f,g,h,i=(new Date).getTime();h=pInt((a-i)/1e3),h>=0?(d=pInt(h/86400),h%=86400,e=pInt(h/3600),h%=3600,f=pInt(h/60),h%=60,g=pInt(h),document.getElementById("days").innerHTML=pInt(d),document.getElementById("hours").innerHTML=("0"+e).slice(-2),document.getElementById("minutes").innerHTML=("0"+f).slice(-2),document.getElementById("seconds").innerHTML=("0"+g).slice(-2)):(clearInterval(b),c&&setTimeout(function(){location.reload()},1e3))}};return d},panda.namespace("smartView"),panda.smartView.main=function(){var a,b,c,d,e,f,g,h,i,j,k,l={},m=_data,n=0,o=0,p=20,q=!1,r=$.browser().msie,s=m.isSeriesView,t=!s,u=!1,v=!0,w=!1,x=$("#series-description"),y=$(".shadow",x),z=$("#smart-view"),A=$("#left-side-bar"),B=$("#side-bar-holder",A),C=$(window),D=$("#episodes-section"),E=$(".episode-index",D),F=$(".first",$("#ep-first-nav")),G=$("#ep-nav"),H=$(".prev",G),I=$(".next",G),J=!1,K=$("#episodes"),L=$("#episode-list"),M=$("#episode-nav"),N=$("#subscribe-btn"),O=$("#loading-indicator"),P=M.prev(),Q=$("html , body"),R=$(".js-nav-login"),S=$(".ad-block"),T=$(".js-pick-btn"),U=B.height(),V=K.prev()[0],W={},X=[],Y=[],Z={},_=[],aa={},ba={},ca=0,da=m.seriesId,ea=m.seriesTitle,fa="hidden"===S.css("visibility")||"none"===S.css("display"),ga=8,ha=5;return l={init:function(){return h=panda.require("smartView.episode",m,N),l.initPage(),0===m.episodeList.length?(m.isHero&&l.handleHeroTagMenu(),l):(j=panda.require("smartView.impression",da),l.initEpisode(),l)},initPage:function(){C.unload(function(){l.pauseScroll(),document.body.scrollTop=0}),panda.addGATrackEvent({category:"read_open",action:"episode_opened"}),document.documentElement.scrollTop=0,_data=void 0;try{g="function"==typeof window.history.pushState&&"function"==typeof window.history.replaceState,f=void 0===window.localStorage?null:window.localStorage}catch(b){}h.showUsersTooltip();var a=$(".viewport",x).height();a>72&&(y.removeClass("off"),a<180&&x.addClass("one")),panda.require("fn.tinyscrollbar",x,{axis:"y",reachFn:l.onReachSeriesDescription}),m.openTip&&(i=panda.require("tip.main",{seriesId:da,seriesTitle:ea})),$("#series-desc-body").autoLink(!0),l.resumeScroll(),l.reset(),C.on("scroll",l.onScroll),$(document).keydown(l.shortCuts).on("dragstart",".art-image",function(a){a.preventDefault()}),$(".series .open-share").on("click",h.openShare),$(".collapse-bar").on("click",l.collapseSideBar),$("#smart-view .subscribe-btn").on("click",h.subscribe),$(".common-tooltip").tooltip(),$(".custom-tooltip").on("click",function(){panda.goPage($(this).getHref())}),$(".js-keys-btn").on("click",l.showFreekeyPopup),L.on("click",".episode-box",l.delegateLoadEpisode),F.on("click",l.goToFirstEpisode).tooltip(),H.on("click",l.goToPrevEpisode).tooltip(),I.on("click",l.goToNext).tooltip(),$(".js-tooltip").tooltip(),m.isAutoSubscription&&N.click()},initEpisode:function(){var a=window.location.hash;a&&C.load(function(){try{var b=$(a.replace("!",""));b.isExists()&&panda.goToTop(null,b.offset().top-60)}catch(c){}});var b=m.episodeId;if(l.setEpisodeOrder(),n=$.inArray(b,X),l.loadEndOfSeriesSections(b),Y.push(b),l.chunkLoadEpisodeList(n),c=panda.require("fn.tinyscrollbar",M,{axis:"y",reachFn:l.loadMoreEpisodeList}),K.on("click",".thumb-btn",h.like).on("click",".js-nsfw-continue",h.readContinueMature).on("click",".go-to-soundcloud",h.openSCPage).on("click",".open-embed",h.openEmbedPopup).on("click",".more-link",h.toggleDesc).on("click",".send-report",h.openReportPopup).on("click",".play-pause-btn",h.toggleSC).on("click",".autoplay-onoff-btn",h.toggleAutoPlay).on("click",".open-share",h.openShare).on("contextmenu",".ep-contents",h.banRightClick).on("click",".subscribe-btn",h.subscribe).on("click",".js-unlock-btn",h.unlock).on("click",".js-copy-link",h.copyLink),m.isPreLoad){var e=K.children(":first");l.turnOnTrunkEpisodeStory(e,!1,b),l.updateShareCount(e),l.selectEpisode(b),l.showLikedUsersTooltip(e),m.unlockEpisode&&panda.require("fn.showDoneIt").showMessage("Episode unlocked"),m.blockedUser&&""!==m.blockedUser&&panda.require("fn.showDoneIt").showMessage("Blocked "+m.blockedUser)}l.initComment(b),C.on("resize",l.reset).trigger("scroll").on("popstate",l.recoverHistory),d=panda.require("fn.lazyLoadVertical",M),l.setSubscribeBtnTooltipState(),l.setFirstEpNavThumbAndTooltip(),l.moveToComment(),m.isHero&&(l.handleHeroTagMenu(),l.initPickControl(),$(".js-episode-id").text("Ep: "+b),T.data("episode",b)),l.showEpNavInstruction(),l.loadAD(b),l.loadHiveAD(b,!0)},handleHeroTagMenu:function(){l.initInternalTags(),$("#blocked, #unblocked").click(l.toggleBlock),$("#buried, #unburied").click(l.toggleBury),$("#merch-update-form").on("submit",l.updateMerchUrl),$(".js-staff-pick").on("click",l.toggleStaffPick)},initPickControl:function(){T.on("mouseenter",function(){var a=$(this).find("i"),b=$(this).find("p");a.replaceClass(a.data("class"),a.data("exClass")),b.text(b.data("exText"))}).on("mouseleave",function(){var a=$(this).find("i"),b=$(this).find("p");a.replaceClass(a.data("exClass"),a.data("class")),b.text(b.data("text"))}).on("click",function(a){panda.stopEvent(a);var b=$(this),c=b.data("episode"),d=b.data("pickId"),e=b.getHref()+c,f=b.hasClass("undo"),g=b.hasClass("editable");g&&d>0&&!f?panda.goPage(b.data("editUrl")+d):f?$.postJSON(e,{isPlain:!0,isSkipCommonAlert:!0},function(a){l.updatePickTool(a.data)}):g||f||(b.addClass("undo"),$.postJSON(e,{isPlain:!0,isSkipCommonAlert:!0},function(a){l.updatePickTool(a.data)}))})},showEpNavInstruction:function(){var a="has-seen-ep-nav-instruction";if(null!==f&&!f.getItem(a)&&!l.isLastEpisode()){var b,c=$("#ep-nav-instruction"),d=function(){c.click(panda.hideOverlay),F.one("click",panda.hideOverlay),H.one("click",panda.hideOverlay),I.one("click",panda.hideOverlay),panda.showOverlay(c.removeClass("hidden").animate({bottom:"29px"},2e3,"easeOutElastic"),!0,function(){G.removeClass("on-instruction")}),G.addClass("on-instruction"),$(".modal-backdrop").addClass("no-scroll"),$("body").removeClass("overlay"),setTimeout(function(){C.one("scroll",function(){panda.hideOverlay()})},3e3)},e=$(".ep-footer"),g=function(){var c=C.height()+C.scrollTop();e.offset()&&c>e.offset().top-100&&(d(),C.unbind("scroll.ep-nav"),clearTimeout(b),f.setItem(a,!0))};b=setTimeout(g,5e3),C.bind("scroll.ep-nav",g)}},initInternalTags:function(){var a=$("#internal-tags"),b=a.find(".input"),c=a.find(".add"),d=a.find(".list"),e={},f=function(a){d.append(panda.templateCompile("tp-internal-tag",a)),e[h(a.name)]=a.id},g=function(a){a.parent().remove(),delete e[h(a.prev().text())]},h=function(a){return a.toLowerCase()};$.get("/internal-tag/list",{series_id:da},function(a){$.each(a,function(a,b){f(b)})}),$.get("/internal-tag/list",{},function(b){$.each(b,function(b,c){a.find(".available-list").append('<li><a href="#" class="add-tag">'+c.name+"</a></li>")})}),b.keydown(function(a){13===a.which&&c.click()}),a.find(".js-edit-tag").click(function(a){panda.stopEvent(a);var b=$(this);b.find("span").toggle(),b.next().toggle()}),a.on("click",".add-tag",function(a){panda.stopEvent(a),b.val($(this).text()),c.click()}),a.on("click",".remove",function(a){panda.stopEvent(a);var b=$(this),c=b.parent().data("tagId"),d={tag_id:c,series_id:da};$.post(b.getHref(),d,function(){g(b)})}),c.click(function(a){panda.stopEvent(a);var c=$(this),d=$.trim(b.val()),g={tag_name:d,series_id:da},i=function(a){return e[h(a)]};if(0!==d.length)return i(d)?void alert(d+" is already exist."):void $.post(c.getHref(),g,function(a){f(a),b.val("")})})},toggleBlock:function(a){panda.stopEvent(a);var b=$(this);$.postJSON(b.getHref(),{},function(a){if(200===a.code){var b=a.data.blocked_by_hero;$("#blocked").toggleClass("hidden",b),$("#unblocked").toggleClass("hidden",!b)}})},toggleBury:function(a){panda.stopEvent(a);var b=$(this);$.postJSON(b.getHref(),{},function(a){if(200===a.code){var b=a.data.buried_by_hero;$("#buried").toggleClass("hidden",b),$("#unburied").toggleClass("hidden",!b)}})},toggleStaffPick:function(a){panda.stopEvent(a);var b=$(this),c=b.data("status"),d=b.parent().find(".pick-status"),e=b.getHref();$.postJSON(e,{isPlain:!0,visible:!c},function(a){if(200===a.code){var c=a.data.is_picked,e=c?"Remove":"Add",f=c?"Yes":"No";b.data("status",c).text(e),d.text(f)}})},setSubscribeBtnTooltipState:function(){var a=z.hasClass("collapsed"),b=N.data("isSubscribed");a||b?N.tooltip("enable"):N.tooltip("disable"),N.data("bs.tooltip").options.placement=a?"right":"top"},loadEndOfSeriesSections:function(a){if(l.isLastEpisode(a)){var b=l.findEpisodeById(a),c=b.find(".coming-soon").isExists(),d=function(){c||b.find(".subscribe-prompt").html(panda.templateCompile("tpSubscribePrompt"))},e=function(){var a=b.find(".read-next");$.trim(a.html())||a.html(panda.templateCompile("tpReadNext"))};d(),e()}},isLastEpisode:function(a){return(a?$.inArray(a,X):n)===X.length-1},goToFirstEpisode:function(a,b){if(panda.stopEvent(a),!J){J=!0;var c=X[0];l.moveToEpisode(c,function(){J=!1,l.selectEpisode(c),panda.callback(b)})}},goToPrevEpisode:function(a){if(panda.stopEvent(a),!J){J=!0;var b=X[n-1];l.moveToEpisode(b,function(){J=!1})}},goToNext:function(a){panda.stopEvent(a),J||(J=!0,l.isLastEpisode()?l.goToNextSeries():l.goToNextEpisode())},goToNextSeries:function(){panda.goPage(l.getNextSeriesCard().find(".title a").prop("href"))},goToNextEpisode:function(){var a=X[n+1];l.loadEpisode(a,!0,function(){l.moveToEpisode(a,function(){J=!1})})},chunkLoadEpisodeList:function(a){for(var b=l.pagingEpisodeList(),c=Math.ceil(++a/p),d=0;;){if(d++,a<=20||c<=o||d>1e4)break;$.merge(b,l.pagingEpisodeList())}l.loadEpisodeList(b)},updateEpisodeNavHeight:function(){if(r){var a=W.winHeight;e||(e=$(".ttr")),e.each(function(){a-=$(this).height()}),a=a>0?a:0,M.parent().css({height:a}).parent().css({height:a})}},setEpisodeOrder:function(){return X=[],$.each(m.episodeList,function(a,b){X.push(b.id)}),h.initEpisodeOrder(X),l},setOnLoadEpFn:function(b){return a=b,l},onLoadEpFn:function(){return panda.callback(a),a=!1,l},pauseScroll:function(){return v=!0,l},resumeScroll:function(){return v=!1,l},canRunScrollEvent:function(){return v},imBusy:function(){return u=!0,l},imOkay:function(){return u=!1,l},ruBusy:function(){return u},delegateLoadEpisode:function(a,b){panda.stopEvent(a);var c=$(this).parent(),d=c.data("eid");if(t=!0,c.hasClass("on"))return l.selectEpisode(d),l.moveToEpisode(d),!1;l.reloadEpisode(d,!0,b),l.selectEpisode(d)},moveToEpisode:function(a,b){var c,d=l.findEpisodeById(a);d.isExists()?(l.pauseScroll(),c=d.offset().top-(U-30),panda.goToTop(null,c,function(){l.resumeScroll(),panda.callback(b)})):(l.reloadEpisode(a,!0,b),l.selectEpisode(a))},clearEpisodes:function(){return K.removeAttr("style").css({minHeight:1200}).find(">.episode").each(function(){l.addEpisodeToCacheStorage($(this))}).remove(),Y=[],panda.isInViewPort(V,0)||Q.scrollTop(W.episodesTop-(U-30)),l},pagingEpisodeList:function(){return o*p<=m.episodeList.length&&m.episodeList.slice(o++*p,p*o)},loadMoreEpisodeList:function(a,b){if("bottom"!==b)return!1;l.loadEpisodeList(l.pagingEpisodeList())&&(c.update("relative"),d&&d.updateImages().loadImage())},reset:function(a){if(W={rootTop:z.offset().top,episodeListBarHeight:P.outerHeight(!0),winHeight:C.height(),winWidth:C.width(),episodeSectionTop:D.offset().top,episodesTop:K.offset().top},c&&c.update("relative"),!a){var b=z.hasClass("collapsed")&&z.data("isFromAuto");W.winWidth<=830&&!b?l.collapseSideBar(null,"collapsed"):b&&W.winWidth>830&&l.collapseSideBar(null,"expand")}l.updateEpisodeNavHeight()},makeEpisodeUrlHistory:function(a,b){var c=ea+" :: "+$("#ep-"+a+" .title",L).attr("title")+m.suffix,d="/episode/"+a;g&&history[b?"replaceState":"pushState"]({episodeId:a,url:d,title:c},c,d),document.title=c,R.data("permalink",panda.getEnvs("appDomain")+d),panda.pushGAPageView("/episode/"+a)},recoverHistory:function(a){a.originalEvent&&a.originalEvent.state&&(panda.stopEvent(a),b=a.originalEvent.state.episodeId,h.updateLastEpisodeId(b),l.moveToEpisode(b,a.originalEvent.state.url))},selectEpisode:function(a,d){if(void 0===a)return!1;var e,f=$(".episode.on",L).addClass("off-effect").removeClass("on unread"),g=$("#ep-"+a).addClass("off-effect").addClass("on"),i=$.inArray(a,X);l.inViewPortByEpisodeList(g[0])||(L.addClass("smooth"),c.moveTo(51*i),setTimeout(function(){L.removeClass("smooth"),M.trigger("on.scroll")},400)),b&&b!==a&&l.makeEpisodeUrlHistory(a,d),b=a,n=i,e=l.findEpisodeById(a),h.updateLastEpisodeId(b),e.isExists()?(h.triggerSCPlay(i),l.changeAutoPlayBtnClass(e)):l.setOnLoadEpFn(function(){h.triggerSCPlay(i)}),m.isHero&&l.setPickTool(),H.toggleClass("hidden",0===i),E.text(i+1),setTimeout(function(){f.removeClass("off-effect"),g.removeClass("off-effect")},100),l.setEpNavThumbAndTooltip(),$(".autoplay-onoff-btn",e).tooltip()},setPickTool:function(){var a=l.getEpisodeByDistance(0);$(".js-episode-id").text("Ep: "+a.id),T.data("episode",a.id),$.getJSON("/manage-episode-trending/daily-pick/"+a.id,{},function(a){l.updatePickTool(a.data)})},updatePickTool:function(a){var b=a.in_bucket,c=a.can_delete_daily_pick;T.data("pickId",a.pick_id).toggleClass("editable",b),b?c?T.hasClass("undo")?T.empty().append($("<i>").addClass("sp-ico-snack-pending").data("class","sp-ico-snack-pending").data("exClass","sp-ico-snack-remove")).append($("<p>").text("Pending").data("text","Pending").data("exText","Remove")):T.removeClass("undo").empty().append($("<i>").addClass("sp-ico-snack-pending").data("class","sp-ico-snack-pending").data("exClass","sp-ico-snack-edit")).append($("<p>").text("Pending").data("text","Pending").data("exText","Edit")):T.removeClass("undo").empty().append($("<i>").addClass("sp-ico-snack-live").data("class","sp-ico-snack-live").data("exClass","sp-ico-snack-edit")).append($("<p>").text("In Snack").data("text","In Snack").data("exText","Edit")):T.removeClass("undo").empty().append($("<i>").addClass("sp-ico-snack-add")).append($("<p>").text("Add"))},reloadEpisode:function(a,b,c){h.turnOffSC(),l.clearEpisodes().loadEpisode(a,b,c)},showLoadingIndicator:function(){return O.removeClass("hidden"),l},turnOnTrunkEpisodeStory:function(a,b,c){var d=$(".episode-story .text",a);b||(aa[c]=d.autoLink(!0).html()),d.trunk8({tooltip:!1,lines:3}),b&&d.trunk8("update",aa[c])},loadEpisode:function(a,b,c){b&&z.addClass("loading");var d=function(d,e){K[0].appendChild(d[0]),b&&z.removeClass("loading"),l.showLikedUsersTooltip(d),l.initComment(a),l.turnOnTrunkEpisodeStory(d,e,a),e||(l.updateShareCount(d),l.loadAD(a)),l.loadHiveAD(a,!1),l.onLoadEpFn(),O.addClass("hidden"),Y.push(a),l.deleteEpisodeFromView(),panda.callback(c,a),l.imOkay(),C.trigger("scroll"),l.loadEndOfSeriesSections(a),i&&i.setDefault(d.find(".js-support-btn"),da,ea)};if(!a)return panda.alert({title:"oops!",body:"Uh oh, something went wrong. Please try it again.",cb:panda.goPage}),!1;$("#episode-"+a).isExists()?(panda.callback(c,a),l.imOkay()):Z[a]?d($(Z[a]),!0):$.getJSON("/episode/view/"+a,{},function(a){d($(a.data.html))}),setTimeout(function(){panda.addGATrackEvent({category:"read_open",action:"episode_read"})},5e3)},setFirstEpNavThumbAndTooltip:function(){var a=m.episodeList[0];F.find("img").prop("src",a.thumbUrl),panda.updateTooltipTitle(F,a.title,"first")},setEpNavThumbAndTooltip:function(){var a,b,c,d=l.getEpisodeThumbUrlByDistance(-1);if(l.isLastEpisode()){var e=l.getNextSeriesCard();a=e.find("img").prop("src"),b=e.find(".title").text(),c=e.attr("data-came-from")}else a=l.getEpisodeThumbUrlByDistance(1),b=l.getEpisodeByDistance(1).title,c="next";d&&(H.find("img").prop("src",d),panda.updateTooltipTitle(H,l.getEpisodeByDistance(-1).title,"previous")),a&&(I.find("img").prop("src",a),panda.updateTooltipTitle(I,b,c)),I.toggleClass("hidden",!a)},getNextSeriesCard:function(){return $("#read-next-series-card")},getEpisodeThumbUrlByDistance:function(a){var b=l.getEpisodeByDistance(a);if(!$.isEmptyObject(b))return b.thumbUrl},getEpisodeByDistance:function(a){return m.episodeList[n+a]||{}},changeAutoPlayBtnClass:function(a){$("a.autoplay-onoff-btn",a).removeClass("selected").filter(m.isAutoSoundPlay?".turn-on":".turn-off").addClass("selected")},loadAD:function(a){if(!m.isNoAD){var b=l.findEpisodeById(a);if(b.isExists()){var c=$(".da-zone",b);c[0].innerHTML=panda.templateCompile("tpAdvertise",{__pure:!0}),fa&&c.find(".da-placeholder").removeClass("hidden")}}},loadHiveAD:function(a,b){if(m.isNoAD||fa)j.disconnect(k);else{window.top.__vm_add=window.top.__vm_add||[];var c='.vm-placement.vm-top[data-episode-id="'+a+'"]',d='.vm-placement.vm-right[data-episode-id="'+a+'"]',e=document.querySelector(c),f=document.querySelector(d);b||(window.top.__vm_add.push(e),window.top.__vm_add.push(f)),void 0===k&&(k=j.getObserver()),j.register(k,e),j.register(k,f)}},loadTooltip:function(a){a.find(".thumb-filter").tooltip({container:"#page-wrap"}).not(".always-show").tooltip(z.hasClass("collapsed")?"enable":"disable"),a.find(".ep-edit-btn").tooltip({container:"#page-wrap"})},loadEpisodeList:function(a){return!(!a||$.isEmptyObject(a))&&($.each(a,function(a,b){var c,d=moment().utc(),e=panda.getEnvs("PSTOffsetTime"),f=moment.utc(b.publishDate),g=moment.utc(b.publishDate).add(e,"minutes"),h=d.isAfter(f),i=!h||b.locked;b.tooltipTitle=b.title,b.publishDateInPST=g.format("YYYY-MM-DD HH:mm:ss")+" PST",b.nsfw="ON"===b.nsfwKind?'<p class="nsfw-label">m</p>':"",b.bgm=b.bgmId?'<span class="note-wrap"><i class="sp-soundcloud-note"></i></span>':"",b.unreadClass=b.read?"":"unread",b.newClass=b.isNew?"new":"",b.new=b.isNew?'<p class="new-label">new</p>':"",b.lockIcon=b.locked?'<i class="ico-lock sp-ico-lock"></i><i class="ico-lock sp-ico-lock-on"></i>':"",i&&(b.unreadClass="force-unread",h||(b.filterType="on",b.iconClass="sp-btn-schedule",b.timeDescClass="on")),c=panda.templateCompile("tpEpisodeList",b),l.loadTooltip(c),L.append(c)}),l)},onScroll:function(){var a=panda.scrollTop();if(!q&&W.rootTop<=a?(A.addClass("docked"),q=!0,setTimeout(function(){l.updateEpisodeNavHeight(),c&&c.update("relative"),d&&d.loadImage()},300)):q&&W.rootTop>a&&(A.removeClass("docked"),q=!1,setTimeout(function(){l.updateEpisodeNavHeight(),c&&c.update("relative")},300)),l.canRunScrollEvent())return!1;d&&!d.isInit()&&d.loadImage(),l.trackCurrentEpisode(a)},trackCurrentEpisode:function(a){if(l.ruBusy())return!1;var b=X[n];if($.inArray(b,Y)<0)return!1;var c,d=document.getElementById("episode-"+b);if(t||a>=W.episodeSectionTop&&(l.makeEpisodeUrlHistory(b,!0),t=!0),c=d.getBoundingClientRect(),c.top<200&&X.length>n+1){var e=c.bottom-W.winHeight,f=X[n+1];(e<400&&c.top<0||a>c.bottom)&&($.inArray(f,Y)<0?(l.imBusy(),l.showLoadingIndicator(),l.loadEpisode(f)):e<0&&(-1*e<1.5*c.height?(ca=0,l.selectEpisode(f,!0)):ca++>2&&panda.goPage()))}else 0!==n&&c.bottom>0&&c.top-W.winHeight>0&&l.selectEpisode(X[n-1],!0)},inViewPortByEpisodeList:function(a){if(!a)return!1;var b=M[0].getBoundingClientRect(),c=a.getBoundingClientRect(),d=c.top+c.height;return d<b.bottom+20&&d>b.top+20},updateShareCount:function(a){var b=a.data("eid"),c=panda.getEnvs("appDomain")+"/episode/"+b;$.get("https://graph.facebook.com?id="+c,function(a){a&&a.share&&$.putJSON("/share/update-count",{id:b,type:"episode",count:a.share.share_count})})},shortCuts:function(a){if(!(a&&(a.ctrlKey||a.shiftKey||a.altKey||a.metaKey)||w||panda.isStopShortCutEvent()||$(a.target).is("input, textarea"))){var b=39===a.which||76===a.which,c=function(){w=!1};switch(w=!0,a.which){case 37:case 72:case 39:case 76:l.navigateEpisodes(b?1:-1,c);break;case 70:l.collapseSideBar(null),c();break;case 71:l.goToFirstEpisode(null,c);break;case 74:case 75:Q.animate({scrollTop:panda.scrollTop()+W.winHeight*(74===a.which?1:-1)},200).promise().done(c);break;case 82:l.readingMode(c);break;default:w=!1}}},navigateEpisodes:function(a,b){var c=X[n+a];c?$("#ep-"+c+" > a").trigger("click",[b]):panda.callback(b)},onReachSeriesDescription:function(a,b){"none"===b?y.removeClass("off"):y.filter("."+b).addClass("off")},collapseSideBar:function(a,b){if(panda.stopEvent(a),!z.data("toggling")&&!z.hasClass(b||"x")){A.css({overflow:"hidden"}),z.data("toggling",!0),b?z.toggleClass("collapsed","collapsed"===b).data("isFromAuto",!0):z.toggleClass("collapsed").data("isFromAuto",!1);var e=z.hasClass("collapsed");Q.filter("body").toggleClass("collapsed",e),N.data("isCollapsed",e),l.setSubscribeBtnTooltipState(),l.updateSeriesThumbnail(),$(".thumb-filter",L).not(".always-show").tooltip(e?"enable":"disable"),setTimeout(function(){l.updateEpisodeNavHeight(),c&&c.update("relative"),d&&d.loadImage(),z.data("toggling",!1),A.removeAttr("style")},300)}},updateSeriesThumbnail:function(){$(".author-collapse").toggleClass("on"),$(".series-thumb-collapse").toggleClass("on"),$(".episode-list-bar").toggleClass("off"),$(".series-info-wrap").toggleClass("off"),$("#series-thumb").isExists()&&$("#series-thumb").toggleClass("off")},removeSiteNoticeBar:function(){$(".global-nav").removeClass("tall"),A.removeClass("with-switcher"),U=B.height(),l.reset(!0)},readingMode:function(a){var b=Q.filter("body").toggleClass("reading-mode").hasClass("reading-mode");l.collapseSideBar(null,b?"collapsed":"expanded"),l.reset(),panda.callback(a)},initComment:function(a){var b=$("#episode-comment-"+a);ba[a]?ba[a].setEvents(b):ba[a]=(new panda.comment.main).init(b)},moveToComment:function(){if(m.commentId){var a=$("#comment-"+m.commentId);a.isExists()&&panda.goToTop(!1,a.offset().top-150,function(){a.css({backgroundColor:"#FFFFDD"}).animate({backgroundColor:"#FFFFFF"},1e3)})}},showLikedUsersTooltip:function(a){$(".liked-user-thumb",a).tooltip({placement:"bottom",trigger:"hover"})},addEpisodeToCacheStorage:function(a){if(!a.hasClass("cached")){var b=a.data("eid");l.deleteEpisodeFromCacheStorage(),a.addClass("cached"),Z[b]=a[0].outerHTML,_.push(b)}return l},deleteEpisodeFromCacheStorage:function(){if(_.length>ga){var a=_.shift();delete Z[a],delete ba[a]}return l},deleteEpisodeFromView:function(){if(Y.length>ha){var a=Y.shift(),b=l.findEpisodeById(a),c=b.outerHeight(),d=panda.scrollTop();l.addEpisodeToCacheStorage(b),l.pauseScroll(),b.remove(),d-c<panda.scrollTop()&&C.scrollTop(d-c),l.resumeScroll(),delete ba[a]}return l},findEpisodeById:function(a){return $("#episode-"+a)},updateMerchUrl:function(a){panda.stopEvent(a);var b=$(this);$.postJSON(b.getHref(),{isPlain:!0,merchUrl:b.find("input").val()},function(){panda.showGlobalMessage("Updated!")})},showFreekeyPopup:function(){if(m.unlockSeries)return void panda.showOverlay(panda.templateCompile("tpClearFreekey"),!0);var a=$(this);parseInt(a.data("keyCnt"),10)>0?panda.showOverlay(panda.templateCompile("tpFreekey"),!0):panda.showOverlay(panda.templateCompile("tpNoneFreekey"),!0)}}},panda.smartView.episode=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o={},p=!1,q=function(a,b){var c="play"===b;a.data("status",b).attr({"data-status":b});var d,e=c?"sp-soundcloud-play":"sp-soundcloud-pause",f=c?"sp-soundcloud-pause":"sp-soundcloud-play";"stop"===b&&(d=e,e=f,f=d),a.find(".js-icon").replaceClass(e,f)},r=function(a,b){p||(p=!0,$(".js-loading-wrap").removeClass("hidden"),$.postJSON(j,{isPlain:!0,fingerprint:a,keyCnt:b,isSkipCommonAlert:!0},function(a){$(".js-loading-wrap").addClass("hidden"),200===a.code?panda.goPage():(panda.hideOverlay(),setTimeout(function(){m.setCoinSuccessCallback(o.openKeyTiers).drawPopup("/coins/popup","episode_unlock")},100))}))};return o={init:function(b,e){return a=b,c=a.seriesId,d=a.seriesTitle,k=e,i="/series/"+c+"/key-tiers",j="/series/"+c+"/keys",m=panda.require("coins.shop"),l=panda.require("fn.dateUtils"),n=panda.require("fn.showDoneIt"),o},initEpisodeOrder:function(a){return f=a,o},updateLastEpisodeId:function(a){return g=a,o},banRightClick:function(a){return panda.stopEvent(a),!1},like:function(a){panda.stopEvent(a);var b=$(this);return!b.data("doing")&&(b.hasClass("have-to-sign")?(panda.account.signin.load.call(b),!1):(b.data("doing",!0),void $.postJSON(b.getHref(),{},function(a){if(200===a.code){var c=a.data,e="UP"===c.thumbs_kind,f=b.siblings(".liked-users"),g=b.data("likedCount");e?(f.children(":first").removeClass("hidden"),b.addClass("voted"),g++):(b.removeClass("voted"),f.children(".me").addClass("hidden"),g--),b.data("likedCount",g),$(".like.num",b.closest(".ep-footer")).html(panda.shortFormat(g)),b.data("isLiked")&&b.data("isUnLiked")||(panda.addGATrackEvent({category:"new-episode-page",action:"clicked",label:e?"like-btn":"unlike-btn"}),panda.addAmplitudeEvent(e?"likes":"unlikes",{episodeId:c.episode_id,seriesTitle:d,at:"new page"}),b.data(e?"isLiked":"isUnLiked",!0))}else b.toggleClass("voted"),panda.alert({body:a.msg});b.data("doing",!1)})))},subscribe:function(a){panda.stopEvent(a);var b=$(".subscribe-btn"),c=b.data("isSubscribed"),e=$("li[data-type=subscriber]"),f=$(".js-cnt",e);if(!k.data("doing")){if(b.hasClass("have-to-sign"))return panda.account.signin.load.call($(this)),!1;k.data("doing",!0),$.postJSON(b.getHref().replace("action",c?"delete":"create"),{},function(a){if(200===a.code){var c=b.find(">i"),g=a.data,h="create"===g.kind,i=f.data("cnt");"delete"===g.kind?(c.replaceClass("sp-btn-bookmarked","sp-btn-bookmark"),panda.updateTooltipTitle(k,"Subscribe"),b.removeClass("subscribed"),n.showMessage("Removed from Library"),i--):(b.addClass("subscribed"),c.replaceClass("sp-btn-bookmark","sp-btn-bookmarked"),n.showMessage("Added to Library"),panda.updateTooltipTitle(k,"Remove from Library"),i++),b.data("isSubscribed",h),f.data("cnt",i),f.text(panda.shortFormat(i)),0===i?($(".custom-tooltip").tooltip("destroy"),e.removeClass("custom-tooltip")):e.addClass("custom-tooltip"),o.showUsersTooltip({count:i}),$(".coming-soon.filter-wrap .js-subscribe-txt").toggleClass("hidden"),b.data(g.kind)||(panda.addAmplitudeEvent(h?"subscribe":"unsubscribe",{seriesId:g.series_id,seriesTitle:d,at:"new page"}),panda.addGATrackEvent({category:"new-series-page",action:"clicked",label:(h?"":"un-")+"subscribe-btn"}),b.data(g.kind,!0)),h&&!$(".js-activate-bar").isExists()&&panda.require("pushMessage.main",!0)}else panda.alert({title:"oops!",body:"You have already subscribed."});k.data("doing",!1)})}},openEmbedPopup:function(a){panda.stopEvent(a);var b,c,d=$(this),e=620,f=d.data("eid"),g=d.data("episodeTitle"),h=d.data("width"),i=d.data("height"),j=d.data("jsUrl"),k=d.data("closeBtnUrl"),l=90,m={id:f,episodeTitle:g,width:e,height:Math.ceil(Math.min(i,1e3)*e/h)+l},n='<div class="tapas-iframe-wrap" data-width="{{width}}"><div class="tapas-full-btn" data-close-btn-url="{{closeBtnUrl}}" data-id="{{id}}" data-url="{{url}}?color=white&overlay=true" data-width="{{width}}"></div><iframe class="tapas-iframe-{{id}} tapas-iframe" height="500" data-is-cropped="{{isCropped}}" scrolling="no" src="{{url}}?color={{color}}&cropped={{isCropped}}" frameborder="0"></iframe></div><script async src="{{jsUrl}}"><\/script>',o=panda.getEnvs("appDomain")+"/embed/v2/"+f,p={id:f,width:h,url:o,jsUrl:j,closeBtnUrl:k,color:"white",isCropped:!0};b=panda.showOverlay(panda.templateCompile("tpEmbed",m),!0),c=$("#embed-code",b).select(),c.val(panda.format(n,p)),panda.require("fn.radio",$(".js-radio"),function(){var a=function(a){p.isCropped=a?"true":"",c.val(panda.format(n,p))},d=function(a){b.find(".js-full-mode").toggleClass("hidden",a),b.find(".js-cropped-mode").toggleClass("hidden",!a),$(".js-sample-img").toggleClass("full",!a)},e="cropped"===$(this).val();a(e),d(e)}),b.on("click",".js-color-opt:not(.on)",function(){var a=$(this),d=a.hasClass("mod-white");b.find(".embed-color-option").toggleClass("on"),b.find(".episode-top-v2").toggleClass("white",d),p.color=d?"white":"black",c.val(panda.format(n,p))})},openReportPopup:function(a){panda.stopEvent(a);var b,c=$(this),d={id:c.data("eid")};b=panda.showOverlay(panda.templateCompile("tpReport",d),!0),$(".p-radio",b).on("click",function(){$("#reporting",b).removeClass("disabled")}),$("#reporting",b).on("click",function(a){if(panda.stopEvent(a),!$(this).hasClass("disabled")){var c=$("#reportForm",b),d={isPlain:!0};if($.each(c.serializeArray(),function(a,b){d[b.name]=b.value}),!new RegExp(/[@]+.*[\.]+/).test(d.email))return $(".js-reporter",b).focus(),!1;$(this).addClass("loading"),$.postJSON(c.getHref(),d,function(){panda.hideOverlay(null,function(){n.showMessage("Thank you for the reporting.")})})}})},openShare:function(a){panda.stopEvent(a);var b=$(this),c=b.data("where"),e=b.attr("href"),f=function(){"facebook"!==c&&"twitter"!==c||$.postJSON("/episode/share/"+g,{},function(){})};panda.addAmplitudeEvent("share",{episodeId:g,snsType:c,seriesTitle:d,at:"new page"}),panda.openSharePopup(c,e,f)},copyLink:function(a){panda.stopEvent(a);var b=$(this),c=b.data("copyUrl");try{var d=$(document.createElement("input")).attr({type:"text",readonly:"readonly",value:c}).css({left:"-9999px",top:"0",position:"absolute"});b.append(d),d.select();document.execCommand("copy")&&(n.showMessage("Copied link"),d.remove())}catch(e){}},openSCPage:function(){panda.getActionFormSubmit().attr({target:"sc",method:"get"});var a;SC.get("/tracks/"+$(this).parent().data("id")).then(function(b){return a=b.permalink,SC.get("/users/"+b.user_id)}).then(function(b){panda.actionFormSubmit("https://soundcloud.com/"+b.permalink+"/"+a)})},openKeyTiers:function(a){a=a||e,p=!1,$.getJSON(i,{isPlain:!0,episode_id:a},function(b){var c=panda.templateCompile("tpKeyPopup",{html:b.data.html});h=b.data.fingerprint,e=a,c.find(".js-key-tier").on("click",function(){var a=$(this).data("count"),b=1===a;panda.addGATrackEvent({category:"episode_unlock",action:"episode_series",label:b?"episode":"series"}),r(h,a)}),c.find(".js-buy-coins-btn").on("click",function(a){panda.stopEvent(a),panda.hideOverlay(),setTimeout(function(){m.setCoinSuccessCallback(o.openKeyTiers).drawPopup("/coins/popup","episode_unlock")},100)}),panda.showOverlay(c,!0,function(){p=!1,panda.addGATrackEvent({category:"episode_unlock",action:"episode_series",label:"exit"})}),$('[data-toggle="tooltip"]').tooltip()})},readContinueMature:function(a){panda.stopEvent(a);var b=$(this),c=$(this).closest(".episode").data("eid"),d=$.inArray(c,f);b.closest(".filter-wrap").next().removeClass("hidden").end().remove(),$(".bgm-wrap").removeClass("hidden"),o.triggerSCPlay(d)},unlock:function(a){panda.stopEvent(a);var b=$(this),c=$(this).closest(".episode").data("eid");return b.hasClass("have-to-sign")?(panda.account.signin.load.call(b),!1):!b.hasClass("loading")&&(panda.addGATrackEvent({category:"episode_unlock",action:"unlock_button",label:"unlock_button"}),b.addClass("loading"),void $.postJSON(b.getHref(),{},function(a){b.removeClass("loading");var d=a.data.unlocked_episode,e=a.data.need_more_key;d?panda.goPage():e?o.openKeyTiers(c):panda.goPage()}))},triggerSCPlay:function(c){if(a.isAutoSoundPlay){var d=a.episodeList[c];d.bgmId?$(".play-pause-btn:visible","#episode-"+d.id).trigger("click",[!0]).data("played",!0):b&&o.turnOffSC()}else o.turnOffSC()},turnOffSC:function(){return b&&(b.sc.pause(),q(b.el,"stop"),b.el.data("isInit",!1),b=!1),o},toggleSC:function(a,c){panda.stopEvent(a);var d=$(this),e=d.data("isInit")||!1,f=d.data("status"),g=!d.data("notAutoPlay"),h=d.data("uuid"),i="play",j=function(){q(d,"stop")};if((b||"stop"===f)&&(b&&b.uuid!==h&&o.turnOffSC(),!d.data("played")||!c)){if("play"===f)b.sc.pause(),i="pause";else if("stop"===f){if(!e)return d.data("isInit",!0),void SC.stream("/tracks/"+d.parent().data("id")).then(function(a){g&&a.play(),a.setVolume(.4),a.on("finish",j),b={sc:a,el:d,uuid:h},q(d,g?"play":"stop")});b&&e&&(b.sc.seek(0),b.sc.play())}else b.sc.play();q(d,i)}},toggleAutoPlay:function(b){panda.stopEvent(b);var c=$(this);return!c.data("doing")&&!c.hasClass("selected")&&(c.hasClass("have-to-sign")?(panda.account.signin.load.call(c),!1):(c.data("doing",!0),$.putJSON(c.getHref(),function(b){c.addClass("selected").data("doing",!1),c.siblings("a").removeClass("selected"),a.isAutoSoundPlay=b.data.is_auto_play}),!1))},toggleDesc:function(a){panda.stopEvent(a);var b=$(this);b.hasClass("less")?b.removeClass("less").prev().removeClass("expend").trunk8({tooltip:!1,lines:3}):b.addClass("less").prev().addClass("expend").trunk8("revert")},showUsersTooltip:function(b){var c=void 0!==b,d={subscriber:{count:c?b.count:a.subscribersCount},supporter:{count:a.tippersCount}};$(".custom-tooltip").each(function(){var a=d[$(this).data("type")],b="number"==typeof a.count?a.count:pInt(a.count),c=panda.formattedString(b);$(this).attr("title",c+" "+panda.makePlural($(this).data("type"),a.count))}),$(".custom-tooltip").tooltip("destroy").tooltip({placement:"right",trigger:"hover",container:$("#smart-view")})}}},panda.smartView.impression=function(){var a,b,c={},d={attributes:!1,childList:!0,subtree:!1},e="/series/__sid__/episodes/__eid__/impressions/HIVEWORKS",f=function(b){var c=[],d=0;if(b.forEach(function(a){if("childList"===a.type){var b=$(a.target),e=b.data("id");d=b.data("episodeId"),a.addedNodes.length>0&&!b.data("sent")&&(b.data("sent",!0),c.push(e))}}),c.length>0){var f=e.replace("__sid__",a).replace("__eid__",d),g=c.join(",");$.postJSON(f,{isSkipCommonAlert:!0,placementIds:g},function(){})}};return c={init:function(d){if(a=d,void 0===b||null===b)try{b=new MutationObserver(f)}catch(e){}return c},getObserver:function(){return b},register:function(a,b){a&&a.observe(b,d)},disconnect:function(a){a&&a.disconnect()}}},panda.namespace("comment"),panda.comment.main=function(){var a,b,c,d,e,f,g,h,i,j={},k=3,l=50,m=!1,n=panda.getEnvs("isNormalView");return j={init:function(c,e){return d=c,a=d.data("baseUrl"),b=d.data("episodeId"),e&&$(document).on("click tap",".has-link",function(a){panda.stopEvent(a)}),j.setEvents(d).updateSinceId().clear(),j},updateSinceId:function(){return c=f.children(":last-child").data("commentId")||0,j},setEvents:function(a){return d=a,n||d.on("tap",".have-to-sign",function(a){panda.stopEvent(a),panda.account.signin.load.call(this)}),i=panda.require("wall.reporting"),j.showUpvoter(),f=$(".comment-streams",d),e=$(".comment-body",d),d.on("focus",".comment-body",j.enableWriteBox).on("click tap",".send-post",j.postComment).on("click tap",".open-reply",j.openReplyBox).on("click tap",".manage-option > a",j.toggleFilterOption).on("click tap",".manage-option a[data-action]",j.manageComment).on("click tap",".holder.act",j.enableWriteBox).on("click tap",".close",j.disableWriteBox).on("click tap",".load-more-comment",j.loadMoreComment).on("click tap",".vote-btn",j.voteComment).on("click tap",".js-block-user",i.openBlockPopup),n&&(h=panda.require("fn.dropdown"),d.on("click",".js-dropdown",h.toggleDropdown).on("click",".js-options > li > a",j.sortComments)),window.Android&&d.on("click tap",".has-link, .link, .awesome",function(a){panda.stopEvent(a),Android.dispatch&&Android.dispatch($(this).attr("href"))}),j},enableWriteBox:function(a){panda.stopEvent(a);var b=$(this);if(b.hasClass("have-to-sign"))return!1;b.closest(".write-box").addClass("on"),e.data("$shadow")||e.autogrow({notAllowEnter:!0,enterFn:j.post}),b.hasClass("holder")&&e[0].focus(),b.on("input",function(){$(".send-post").isExists()&&$(".send-post").toggleClass("on",""!==b.val().trim())})},disableWriteBox:function(a){panda.stopEvent(a),$(this).closest(".write-box").removeClass("on"),j.clear(),e.data("$shadow")&&(e.data("$shadow").remove(),e.data("$shadow",!1)),e.blur()},clear:function(){e.val("").trigger("keydown"),$(".send-post").isExists()&&$(".send-post").removeClass("on")},postComment:function(a){panda.stopEvent(a);var b=$(this);j.post(null,b.parent().find("textarea")),b.removeClass("on")},post:function(c,d){panda.stopEvent(c);var g=d||$(this),h=$.trim(g.val()),i=g.data("type"),k={isPlain:!0};if(0!==h.length){if(h.length>2e3)return void panda.alert({body:"Please use up to 2000 characters."});k.body=h,"reply"===i&&(k.parentId=g.data("pId")),$.postJSON(a,k,function(a){if("reply"===i){var c=g.closest(".comment-stream"),d=c.find(".reply-streams"),h=$(a.data.html).addClass("new");0===d.children().length?d.append(h).end().find(".reply-write").remove():d.children(":last-child").after(h).end().find(".reply-write").remove(),g.removeWithAutogrow()}else f.prepend($(a.data.html).addClass("new")),j.clear();window.Android&&Android.writeCommentCallback?Android.writeCommentCallback():(panda.addAmplitudeEvent("comment",{episodeId:b,commentType:i}),panda.addGATrackEvent({category:"episode-page",action:"added",label:"comment"+("reply"===i?"(reply)":"")})),n||e.blur()})}},openReplyBox:function(a){panda.stopEvent(a);var c=$(this),d=panda.templateCompile("tpReply-"+b,{body:""}),e=$(".reply-body",d);e.data("pId",c.data("pId")),$(".cancel-reply",d).on("click tap",function(a){panda.stopEvent(a),e.removeWithAutogrow(),c.hasClass("reply-to-reply")?c.removeClass("hidden").closest(".body-wrap").siblings(".reply-write").remove():c.removeClass("hidden").next().remove()}),$(".post-reply",d).on("click tap",function(a){panda.stopEvent(a),j.post(null,e)});var f=c.addClass("hidden").parent();c.hasClass("reply-to-reply")?f.closest(".reply-stream").append(d.removeClass("hidden")):f.append(d.removeClass("hidden")),e.focus().autogrow({notAllowEnter:!0,enterFn:j.post})},toggleLoadingIndicator:function(a,b){a.closest("div").toggleClass("hidden",b).next().toggleClass("hidden",!b)},loadMoreComment:function(b){panda.stopEvent(b);var c=$(this),e=c.data("lastId"),f=c.data("lastReplyId"),g=d.data("orderBy"),h="best"===g,i={descending:"desc"===g,lastReplyId:f,orderByBest:h,offset:c.data("offset")||0,sinceDate:c.data("sinceDate")};j.toggleLoadingIndicator(c,!0),$.getJSON(a+"/"+e,i,function(a){var b=a.data,e=b.params,f=e.left_comment_count,g=e.episode_id,h=e.last_id,i=e.last_reply_id,k=e.offset,l=$("#episode-comment-"+g),n=$(".comment-streams",l),o=$("<div/>").html(b.html),p=o.find(">div.reply-stream"),q=p.isExists(),r=!q||n.find(".comment-stream:last");if(m=!0,q){var s=$(".reply-streams",r),t=s.children(".reply-stream"),u=t.filter(".new:first");$.each(p,function(){var a=$(this);0!==t.length&&u.isExists()?u.before(a):s.append(a)}),r.find(".parent-body-wrap >.vote-wrap").addClass("has-reply")}n.append(o.find(">div.comment-stream")),j.toggleLoadingIndicator(c,!1),c.data("lastId",h).data("lastReplyId",i).data("offset",k),j.showUpvoter(),f<1&&d.removeClass("more"),c.data("changedLabel")||c.data("changedLabel",!0).find(">span").toggleClass("hidden")})},toggleFilterOption:function(a){var b=$(this),c=b.parent();c.toggleClass("on"),panda.stopEvent(a),c.hasClass("on")?$(window).one("click.closed",function(){c.removeClass("on")}):$(window).off("click.closed")},sortComments:function(b){panda.stopEvent(b),h.select($(this));var c=$(this),e=$(".load-more-comment",d),g=c.parent().data("type"),i="best"===g,n="desc"===g,o=k,p={lastReplyId:0,limit:o};if(m&&(p.limit+=l),d.data("orderBy")===g)return!1;d.data("orderBy",g),p.descending=n,p.orderByBest=i,$.getJSON(a+"/0",p,function(a){var b=a.data,c=b.params,g=c.left_comment_count;f.empty(),f.html(b.html),e.data("lastPosition",c.last_position).data("lastId",c.last_id).data("lastReplyId",c.last_reply_id).data("sinceDate",c.since_date).data("offset",c.offset),j.showUpvoter(),g>0&&(e.data("changedLabel")&&(e.find(">span").filter(function(a){$(this).toggleClass("hidden",0!==a)}),e.data("changedLabel",!1)),d.addClass("more"),e.find(".num").text(g))})},manageComment:function(a){panda.stopEvent(a);var c=$(this),d=c.data("action"),e=c.closest(".comment-filters"),f=e.data("type"),g=e.data("commentId");if("delete"===d)panda.alert({title:"confirmation",body:"Are you sure you want to delete this comment?",isConfirm:!0,cb:function(){"parent"===f&&j.updateSinceId(),$.postJSON(c.getHref(),{},function(){var a=c.closest(".stream"),b=a.parent();"reply"===f&&1===b.children().length&&(b.next().find(">a.open-reply").removeClass("depth"),b.next().find("span, a.vote-btn").removeClass("hidden"),b.prev().find(".vote-wrap").addClass("hidden")),a.remove()})}});else{var h,i,k,l=e.closest(".body-header").next();if(l.hasClass("hidden"))return!1;h={commentId:g,type:f,holder:"parent"===f?"note":f,body:$.trim(l.text())},i=panda.templateCompile("tpEditBody-"+b,h),l.addClass("hidden").after(i),k=i.find(".edit-body").autogrow({notAllowEnter:!0,enterFn:j.edit}).focus(),$(".cancel-edit",i).on("click tap",function(a){panda.stopEvent(a),l.removeClass("hidden"),k.removeWithAutogrow(),i.remove()}),$(".save-comment",i).on("click tap",function(a){panda.stopEvent(a),j.edit.call(k)})}},edit:function(a){panda.stopEvent(a);var b=$(this),c=$.trim(b.val()),d={isPlain:!0};if(0!==c.length){if(c.length>2e3)return void panda.alert({body:"Please use up to 2000 characters."});d.body=c,$.postJSON("/comment/update/"+b.data("commentId"),d,function(a){var c=b.parent().prev().html(a.data.body).removeClass("hidden").end();b.removeWithAutogrow(),c.remove()})}},voteComment:function(a){var b=$(this),c=b.getHref(),d=b.data("commentId"),e=b.data("constant"),f=b.parent().find(".up-count"),g=b.parent().hasClass("vote-reply"),h=1===e||!1,i=function(a,c){a&&j._updatePopover(b,c),b.data("prevCnt",-1)};if(b.hasClass("have-to-sign"))return!0;panda.stopEvent(a),b.hasClass("on")?$.postJSON("/comment/cancel-vote/"+d,{isPlain:!0},function(a){var c=a.data.up_count,d=b.siblings(".up-count");d.text(c).toggleClass("hidden",c<1),j.updateVoteCount(d,!1,c),b.removeClass("on");var e=b.children("i").attr("class").replace("-on","");b.children("i").attr("class",e),i()}):$.postJSON(c,{up:h,isPlain:!0},function(a){var c=a.data.up_count;g?(j.updateVoteCount(f,h,c),b.addClass("on").siblings("a").removeClass("on")):$("#"+b.data("streamId")).find(".vote-comment").each(function(){var a=$(this);j.updateVoteCount(a.find(".up-count"),h,c),$("a[data-constant="+e+"]",a).addClass("on").siblings("a").removeClass("on")});var d=b.children("i").attr("class").replace("vote","vote-on");b.children("i").attr("class",d),d=b.siblings("a").children("i").attr("class").replace("-on",""),b.siblings("a").children("i").attr("class",d),i(h,c)})},updateVoteCount:function(a,b,c){a.text(c),a.toggleClass("hidden",0===c).toggleClass("on",b)},showUpvoter:function(){n&&$('[data-toggle="popover"]',d).each(function(){var a=$(this);a.off("mouseenter").on("mouseenter",function(){var b=parseInt(a.siblings(".up-count").text(),10);if(a.addClass("enter"),a.data("prevCnt")===b)return void a.popover("show");a.data("prevCnt",b),b>0&&($(".popover",d).remove(),j._showPopover(a))}).off("mouseleave").on("mouseleave",function(){var b=$(this);g=setTimeout(function(){b.popover("hide")},300),a.removeClass("enter")})})},_showPopover:function(a){$.getJSON("/comment/upvoters/"+a.data("commentId"),function(b){var c=b.data.html;a.popover("destroy").popover({placement:"top",trigger:"manual",content:function(){return c}}).popover("show").siblings(".popover").on("mouseenter",function(){clearTimeout(g)}).on("mouseleave",function(){a.popover("hide")})})},_updatePopover:function(a,b){n&&(0===b?a.siblings(".popover").remove():j._showPopover(a))}}},panda.namespace("episodeFeed"),panda.episodeFeed.main=function(){var a,b,c,d,e={},f=$("aside.feed-right"),g=$("#feed-fragment"),h=!1,i=0,j=0,k={},l={},m=$(window),n=panda.getEnvs("isMobileView")||!1;return e={init:function(){return panda.require("episodeFeed.subscription"),panda.require("episodeFeed.buttonWrap"),$("html , body").scrollTop(0),a=$(".feed-episode"),j=a.width(),a.isExists()&&$(".reload-btn").removeClass("hidden"),e.setEvents(),e.setWindowEvents(),e},setEvents:function(){e.setUpFeeds(),g.on("click tap",".continue-btn",e.showMoreContents),n||(c=f.offset().top-20),$(".js-ad-section").on("click tap",function(a){panda.stopEvent(a)})},setWindowEvents:function(){a.isExists()&&(e.refreshPositions(),m.on("scroll",e.tracking),m.on("scroll",e.infiniteScroll),n||(m.on("scroll",e.dockedSideBar),m.on("scroll",e.dockedFeedHeader),m.on("resize",function(){e.refreshPositions(),e.dockedFeedHeader(),e.dockedSideBar()})),m.trigger("scroll"),$(".reload-btn").on("click tap",e.reloadContents))},showMoreContents:function(a){panda.stopEvent(a);var c=$(this),d=c.data("index")-1,e=c.parent().prev(),f=e.data("height"),g=f-600;e.find(".art-image").each(function(a,b){var c=$(b);c.data("src")&&!0!==c.data("loaded")&&c.attr("src",c.data("src"))}),e.css({height:f+"px"}),c.parent().remove(),b.filter(function(a){return a>d}).each(function(){var a=$(this);a.data("top",a.data("top")+g)})},reloadContents:function(b){panda.stopEvent(b);var c=$(this).find("> img, > i").addClass("spin");g.addClass("ready-to-fade-out"),setTimeout(function(){$.get("/feeds/fragment",function(b){g.addClass("fade-out"),setTimeout(function(){var d=$(b);g.replaceWith(d),$("html, body").scrollTop(0),g=d,a=$(".feed-episode"),e.setEvents(),c.removeClass("spin")},1)})},100)},infiniteScroll:function(){var b=a.last();if(!b.data("loaded")&&b.offset().top<panda.scrollTop()+d){var c=b.data("loaded",!0).next();c.isExists()?(b.after(c.remove().html()),a=$(".feed-episode"),e.setUpFeeds()):e.addGATrackEvent("reached","the-end")}},tracking:function(){$.each(k,function(a,b){var c=b.data("episodeId");return c&&0!==l[c]&&!0!==b.data("isTracked")&&panda.isInViewPort(b[0],1)&&(l[c]=0,b.data("isTracked",!0),panda.pushGAPageView(b.data("href")),$.put("/feeds/read/"+c,{},function(){b.data("alreadyRead",!0)}),delete k[c]),!1})},refreshPositions:function(){d=m.height()},addGATrackEvent:function(a,b){panda.addGATrackEvent({category:n?"m-best-new-webcomics":"best-new-webcomics",action:a,label:b})},setUpFeeds:function(){a.each(function(){var a=$(this);if(!a.data("set")){a.data("isTracked")||(k[a.data("episodeId")]=a);var b=a.find("article > a"),c=b.find(".art-image"),d=0;c.each(function(a,b){var c=$(b);a>0&&d<600&&c.attr("src",c.data("src")).data("loaded",!0);var e=c.data("height");c.data("width")>j&&(e=e/c.data("width")*j),d+=e}),d>600?b.addClass("has-continue-reading").next().removeClass("hidden"):b.css({height:d+"px"}),b.data("height",d),a.data("set",!0)}}),b=a.find(">header").each(function(){var a=$(this);a.data("set")||a.data("top",a.offset().top).data("set",!0)}),i=b.outerHeight()},dockedFeedHeader:function(){var a=panda.scrollTop();b.each(function(c){var d=$(this),e=0;!d.data("isDocked")&&d.data("top")-a<0?d.addClass("docked").data("isDocked",!0).data("hasDocked",!0):!0===d.data("isDocked")&&(e=b.eq(c+1).data("top"),a<=d.data("top")?d.removeClass("docked").data("isDocked",!1).data("hasDocked",!1).removeAttr("style"):d.data("hasDocked")&&e<=a+i?d.css({top:e-i}).removeClass("docked").data("hasDocked",!1):!d.data("hasDocked")&&a-d.offset().top<0&&d.addClass("docked").removeAttr("style").data("hasDocked",!0))})},dockedSideBar:function(){var a=panda.scrollTop();return!h&&a>c?(f.addClass("docked"),h=!0):h&&a<=c&&(f.removeClass("docked"),h=!1),e}}},panda.episodeFeed.buttonWrap=function(){var a={},b=panda.getEnvs("isMobileView");return a={init:function(){return $("body").on("click tap",".like-btn",a.likeEpisode).on("click tap",".share-btn",a.openShare).on("click tap",".open-share",a.goShare).on("click tap",".js-disable-comment",a.showWarning),a},showWarning:function(a){panda.stopEvent(a),panda.require("fn.showDoneIt").showMessage("Commenting has been disabled for this episode.")},likeEpisode:function(a){panda.stopEvent(a);var c=$(this);$.postJSON(c.getHref(),{},function(a){if(200===a.code){var d=a.data,e="UP"===d.thumbs_kind;c.toggleClass("voted",e),b&&c.find("i").addClass(e?"sp-m-ico-liked":"sp-m-ico-like").removeClass(e?"sp-m-ico-like":"sp-m-ico-liked"),c.data("liked")&&c.data("unLiked")||(panda.addGATrackEvent({category:c.data("gaCategory"),action:"clicked",label:e?"like-btn":"unlike-btn"}),panda.addAmplitudeEvent(e?"likes":"unlikes",{episodeId:c.data("episodeId"),seriesTitle:c.data("seriesTitle"),at:c.data("amplitudeAt")}),c.data(e?"liked":"unLiked",!0))}else panda.alert({body:a.msg})})},openShare:function(a){b&&panda.stopEvent(a);var c=$(this),d=function(a){a.removeClass("on").parent().removeClass("clicked")};"hover"!==c.data("action")&&(c.toggleClass("on").parent().toggleClass("clicked"),c.parent().hasClass("clicked")?$(window).one("click.closed",function(){d(c)}):$(window).off("click.closed"))},goShare:function(a){var c=$(this),d=c.data("where"),e=c.attr("href"),f=c.data("episodeId"),g=c.data("seriesTitle"),h=c.data("amplitudeAt");panda.addAmplitudeEvent("share",{episodeId:f,snsType:d,seriesTitle:g,at:h}),b||(panda.stopEvent(a),panda.openSharePopup(d,e),$(window).trigger("click"))}}},panda.episodeFeed.subscription=function(){var a={},b=panda.getEnvs("isMobileView"),c=function(a,c){var d="create"===a.data.kind,e=c.data("seriesId");if(panda.addAmplitudeEvent(d?"subscribe":"unsubscribe",{seriesId:e,seriesTitle:c.data("seriesTitle"),at:c.data("amplitudeAt")}),panda.addGATrackEvent({category:c.data("gaCategory"),action:"clicked",label:(d?"":"un-")+"subscribe-btn"}),c.attr("href",d?"#!/subscription/delete/"+e:"#!/subscription/create/"+e).data("gaLabel",d?"un-subscribe-btn":"subscribe-btn").toggleClass("voted"),b){var f=c.data("where");if("series"===f)c.toggleClass("subscribed").find("i").replaceClass(d?"sp-btn-bookmark":"sp-btn-bookmarked",d?"sp-btn-bookmarked":"sp-btn-bookmark"),d&&!$(".js-activate-bar").isExists()&&panda.require("pushMessage.main");else if("comingsoon-filter"===f)c.toggleClass("subscribed"),$(".coming-soon.filter-wrap .js-subscribe-txt").toggleClass("hidden");else{var g="sp-m-ico-bookmarked";c.find("i").addClass(d?g:"sp-m-ico-bookmark").removeClass(d?"sp-m-ico-bookmark":g)}}else c.find("i").addClass(d?"sp-btn-bookmarked":"sp-btn-bookmark").removeClass(d?"sp-btn-bookmark":"sp-btn-bookmarked")};return a={init:function(){return $(document).on("click",".subscribe-btn",a.save),$(document).on("tap",".js-subscribe-btn",a.save),a},save:function(a){panda.stopEvent(a);var b=$(this);$.postJSON(b.getHref(),function(a){if(200===a.code){var d=a.data.kind,e="create"===d,f=e?"Added to Library":"Removed from Library";panda.require("fn.showDoneIt").showMessage(f),c(a,b)}else panda.alert({title:"oops!",body:a.msg})},b)}}},panda.namespace("fn"),panda.fn.croppingTool=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=!1,w=$(document),x=$(window),y=$("body"),z=0,A=[],B=0,C=!1,D=[],E=[],F=100,G=panda.getEnvs("rTapasIoHost")+"/s3/";return a={init:function(e){r=e,j=r.ratio||1.91,k=r.minImageWidth||-1,q=Math.ceil(F/1.91),t=r.imagePath,b=$("#"+r.canvasId),c=$("#full-"+r.canvasId),d=$("#"+r.wrapperId);var f=r.minWidth||600,g=Math.ceil(f/j);return a.setEvents(),s=panda.require("fn.croppingCommon",{minHeight:g,minWidth:f,ratio:j}),a},setEvents:function(){$(".js-reset-to-default").on("click",a.resetToDefault),b.parent().on("click",a.openCroppingTool)},resetImageInfos:function(){return A=[],B=0,z=0,p=!1,a},addImageInfo:function(a){A.push(a),A.sort(function(a,b){return a.order-b.order})},setDefaultImage:function(){v||(v=!0,z=0,a.resetToDefault(),a.toggleCroppingToolWrapper())},resetToDefault:function(b){panda.stopEvent(b),t?(u=!1,a.displayImage(t)):a.render()},render:function(b,c){if(z!==b){if(0===A.length)return void(v=!1);u=!0,z=b||0;var d=A[z],e=d.s3.url;a.displayImage(e,c)}},displayImage:function(a,d){var e=b[0],f=c[0],g=e.getContext("2d"),h=f.getContext("2d"),i=a.split("/").slice(3).join("/");i=-1!==a.indexOf("cloudfront")?G+"r.tapas.io/"+i:G+i,s.loadImage(i,function(a){var b=d||s.calculateCenteredCropping(a.width,a.height);g.drawImage(a,b.left,b.top,b.width,b.height,0,0,e.width,e.height),h.drawImage(a,b.left,b.top,b.width,b.height,0,0,f.width,f.height)})},updateContents:function(b){if(a.resetImageInfos(),b&&b.length>0){var c;$.each(b,function(b,d){m===d.s3.url&&(c=b),a.addImageInfo(d)}),void 0===c&&(o=!1),a.render(c)}else v=!1;a.toggleCroppingToolWrapper()},toggleCroppingToolWrapper:function(){d.toggleClass("hidden",!a.hasThumb())},hasThumb:function(){return A.length>0},openCroppingTool:function(b){panda.stopEvent(b);var c={images:""};$.each(A,function(a,b){c.images+=panda.format('<img class="target-img" src="{{src}}" data-width="{{width}}" data-height="{{height}}">',{src:b.s3.url,width:b.width,height:b.height})}),f=panda.templateCompile("tpCroppingTool",c),e=f.find(".cropping-tool-box"),g=f.find(".footer"),i=f.find(".cropping-area"),h=f.find(".nav .btn").on("click",a.turnOverImage),a.setDnDEvents().setResizeEvents(),a.toggleNavBtns(),f.on("click",".use-this",a.useThis),f.on("rendered",function(){a.updateHeights().updateImagesHeight().showPreviewImage()}),panda.showOverlay(f,!0,function(){C||(o=!1),p=!1,B=z}).addClass("scroll")},setResizeEvents:function(){i.find(".edge").on("mousedown.resizing",function(b){panda.stopEvent(b),a.setInitMouseXY(b);var c=$(this),d=$(this).data("cursor"),e=c.data("direction");y.addClass(d),w.on("mousemove.resizing",function(b){a.resizeCroppingArea(b,e)}).one("mouseup",function(){w.off("mousemove.resizing"),y.removeClass(d)})})},setDnDEvents:function(){return i.on("mousedown.cropping",function(b){panda.stopEvent(b),a.setInitMouseXY(b),w.on("mousemove.cropping",a.moveCroppingArea).one("mouseup",function(){w.off("mousemove.cropping")})}),a},resizeCroppingArea:function(b,c){var d,e,f,g,h=b.pageX-D[0],k=b.pageY-D[1],l=p.left,m=p.top,n=m,o=l,r=m,s=l,t=p.width,u=p.height,v=t+h,w=u+k,x=c.split(" "),y=i[0];a.setInitMouseXY(b),"w"===x[0]&&(o+=h,v=t-h,o<1&&(v=t+l,o=0)),"n"===x[1]&&(n+=k,w=u-k,n<1&&(w=u+m,n=0)),g=Math.max(E[0]-o,0),f=Math.max(E[1]-n,0),v=Math.max(Math.min(g,v),F),w=Math.max(Math.min(f,w),q),d=Math.abs(v-t),e=Math.abs(w-u),d<e?(v=Math.ceil(w*j),v>g&&(v=g),w=Math.ceil(v/j)):(w=Math.ceil(v/j),w>f&&(w=f),v=Math.ceil(w*j)),v=Math.min(g,v),w=Math.min(f,w),"w n"===c?(o=l-(v-t),n=m-(w-u)):"e n"===c?(n=m-(w-u),o=l):"w s"===c&&(o=l-(v-t),n=m),v>F&&(p.width=v,y.style.width=v+"px",s=a.moveLeftPos(o,v,y)),w>q&&(p.height=w,y.style.height=w+"px",r=a.moveTopPos(n,w,y)),a.moveBGPos(s,r,y)},moveTopPos:function(a,b,c){return a=Math.max(a,0),a=b+a>E[1]?E[1]-b:a,c.style.top=a+"px",p.top=a,a},moveLeftPos:function(a,b,c){return a=Math.max(a,0),a=b+a>E[0]?E[0]-b:a,c.style.left=a+"px",p.left=a,a},moveBGPos:function(a,b,c){c.style.backgroundPosition=-1*a+"px "+-1*b+"px"},setInitMouseXY:function(a){D[0]=a.pageX,D[1]=a.pageY},moveCroppingArea:function(b){var c,d,e=b.pageX-D[0],f=b.pageY-D[1],g=p.left,h=p.top,j=i[0];a.setInitMouseXY(b),c=a.moveLeftPos(g+e,p.width,j),d=a.moveTopPos(h+f,p.height,j),a.moveBGPos(c,d,j)},updateHeights:function(){return n=x.height()-60,f.css({lineHeight:n+"px"}),a},updateImagesHeight:function(){return l=g.outerHeight(),a.getTargetImages().each(function(a,b){var c=$(b),d=c.data("width"),e=c.data("height"),f=Math.min(e,n-l),g=Math.ceil(d/e*f);k>0&&g<k&&(g=k,f=Math.ceil(e/d*g)),c.css({height:f,width:g}).data("resizedHeight",f).data("resizedWidth",g)}),a},getTargetImages:function(){return e.find(".target-img")},turnOverImage:function(b){panda.stopEvent(b),a.showPreviewImage($(this).data("way")),a.toggleNavBtns()},toggleNavBtns:function(){h.filter(".prev").toggleClass("hidden",0===B),h.filter(".next").toggleClass("hidden",A.length-1===B)},showPreviewImage:function(b){b=b||0;var c=B+b;if(!(A.length-1<c||c<0))return B=c,a.getTargetImages().each(function(b,c){var d=b===B,e=$(c);e.toggleClass("hidden",!d),d&&a.drawCropArea(e,b)}),a},drawCropArea:function(a,b){var c,d=a.data("resizedWidth"),e=a.data("resizedHeight"),f=a.data("width"),g=a.data("height");c=b===z&&o?o:s.calculateCenteredCropping(d,e),c.backgroundImage=panda.format("url({{src}})",a.attr("src")),c.backgroundPosition=panda.format("-{{left}}px -{{top}}px",c),c.backgroundSize=panda.format("{{width}}px {{height}}px",{width:d,height:e}),i.css(c),c.ratioX=f/d,c.ratioY=g/e,c.orgWidth=f,c.orgHeight=g,p=c,E[0]=d,E[1]=e},useThis:function(b){panda.stopEvent(b);var c=p.ratioX,d=p.ratioY;o=p,z=-1,a.render(B,{width:Math.min(Math.ceil(p.width*c),p.orgWidth),height:Math.min(Math.ceil(p.height*d),p.orgHeight),left:Math.ceil(p.left*c),top:Math.ceil(p.top*d)}),C=!0,panda.hideOverlay(b)},getImageData:function(){return a.hasThumb()&&u?c[0].toDataURL():""}}},panda.fn.croppingCommon=function(){var a,b,c,d={},e={minWidth:600,minHeight:315,ratio:1.91};return d={init:function(f){return f=f||e,a=f.minHeight,b=f.minWidth,c=f.ratio,d},loadImage:function(a,b){var c=new Image;return c.crossOrigin="Anonymous",$(c).one("load",function(){panda.callback(b,c)}),c.src=a,d},calculateCenteredCropping:function(d,e){var f,g,h,i,j=d;return e<a&&(j=Math.ceil(d/e*a)),j<b&&(j=b),g=Math.ceil(j/c),f=j,g>e&&(g=e,f=Math.ceil(e*c)),f>d&&(f=d,g=Math.ceil(d/c)),h=d>f?Math.ceil((d-f)/2):0,i=e>g?Math.ceil((e-g)/2):0,{left:h,top:i,width:f,height:g}}}},panda.fn.croppingThumbnail=function(){var a,b,c,d,e,f={};return f={init:function(g){return c=g.$image,a=g.width||c.attr("width")||c.width(),b=g.height||c.attr("height")||c.height(),d=a/b,e=panda.require("fn.croppingCommon",{minWidth:a,minHeight:b,ratio:d}),f},render:function(d){var f=document.createElement("canvas"),g=f.getContext("2d");f.width=a,f.height=b,e.loadImage(d,function(d){var h,i=e.calculateCenteredCropping(d.width,d.height);g.drawImage(d,i.left,i.top,i.width,i.height,0,0,a,b),h=f.toDataURL(),c.attr("src",h).trigger("loaded",[h])})},renderFailed:function(){c.attr("src",blankImgSrc)}}},panda.namespace("hero"),panda.hero.common=function(){var a={},b="heroHistories",c={},d="closedMenu",e={};return a={init:function(f){c=JSON.parse(localStorage.getItem(b))||{},e=JSON.parse(localStorage.getItem(d))||{},$('[data-toggle="tooltip"]').tooltip(),$("body").on("click",".js-remove-parent",a.removeParent).on("click",".js-close-modal",function(a){panda.stopEvent(a),panda.hideOverlay()}).on("click",".js-hero-menu",a.handleMenu).on("click",".js-nav-title",a.handleNav).on("click",".js-confirm",a.confirm).on("click",".js-dropdown",a.handleDropdown),f&&""!==f&&panda.alert({title:"oops!",body:f});var g=$(".recent-menu");if(g.isExists()){var h=JSON.parse(localStorage.getItem(b));h&&$.each(h,function(a,b){var c=$("<li></li>").append($('<a href="'+b+'">'+a+"</a>"));0===g.find("li").length?g.append(c):g.find("li:first-child").before(c)})}if(e){Object.values(e).forEach(function(a){$('[data-idx="'+a+'"]').addClass("closed")})}return a},handleDropdown:function(a){panda.stopEvent(a),$(this).parent().toggleClass("on")},handleMenu:function(a){var d=$(this);d.hasClass("mod-drop")&&(panda.stopEvent(a),d.toggleClass("clicked")),delete c[d.text()],c[d.text()]=d.getHref(),localStorage.setItem(b,JSON.stringify(c))},handleNav:function(){var a=$(this),b=a.data("idx");if(a.toggleClass("closed"),a.hasClass("closed"))e[b]=b,localStorage.setItem(d,JSON.stringify(e));else{var c=JSON.parse(localStorage.getItem(d));delete c[b],localStorage.setItem(d,JSON.stringify(c))}},removeParent:function(a){panda.stopEvent(a),$(this).parent().remove()},confirm:function(a){panda.stopEvent(a);var b=$(this),c=b.hasClass("disabled")||b.attr("disabled"),d=b.hasClass("warn"),e=b.hasClass("post"),f=b.data("confirmMsg")||"",g=d?"oops!":"are you sure?",h=$.noop;c||(d||(h=function(){var a=b.closest("form");a.isExists()?a.submit():e?panda.actionFormSubmit(b.getHref()):panda.goPage(b.getHref())}),panda.alert({title:g,body:f,isConfirm:!d,cb:h}))}}},panda.hero.users=function(){var a={},b=$(".resend-email"),c=$(".js-all-guests");return a={init:function(){return b.click(a.resendEmail),c.click(a.showAllGuests),panda.require("fn.timepicker",$(".pikaday")),a},resendEmail:function(a){panda.stopEvent(a);var b=$(this),c=b.data("email"),d=b.data("uname");panda.alert({title:"are you sure?",body:"Sending email to "+c,isConfirm:!0,cb:function(){$.postJSON(b.getHref(),{isPlain:!0,uname:d},function(a){200===a.code&&panda.alert({title:"yay!",body:"Email sent successfully."})})}})},showAllGuests:function(a){panda.stopEvent(a);var b=$(this),c={};$.getJSON(b.getHref(),{},function(a){c.html=a.data.html;var b=panda.templateCompile("tp-all-guests",c);panda.showOverlay(b,!0)})}}},panda.hero.series=function(){var a={},b=$(".blocked"),c=$(".unblocked"),d=$(".buried"),e=$(".unburied"),f=$(".js-ad-btn");return a={init:function(g,h){return a.setSeriesTagFiltering(g,h),b.click(a.updateBlock),c.click(a.updateBlock),d.click(a.updateBury),e.click(a.updateBury),f.on("click",a.openAdModal),$(".js-filter-ctrl").on("click",a.toggleFilter),a},openAdModal:function(a){panda.stopEvent(a);var b=panda.templateCompile($(this).data("modalId"));panda.showOverlay(b,!0)},toggleFilter:function(){var a=$(".js-tag-form");a.toggleClass("hidden",!a.hasClass("hidden"))},setSeriesTagFiltering:function(a,b){var c=$("#series-tag-filter");if(c.find("[type=submit]").click(function(a){0===c.find(":checkbox:checked").size()&&(panda.stopEvent(a),panda.showGlobalMessage("Please choose more checkboxes."))}),""===a||b===[])return void c.find(":radio").first().attr("checked","checked");c.find(":radio").each(function(b,c){$(c).val()===a&&$(c).attr("checked","checked")}).end().find(":checkbox").each(function(a,c){var d=parseInt($(c).val(),10);-1!==b.indexOf(d)&&$(c).attr("checked","checked")})},updateBlock:function(a){panda.stopEvent(a);var b=$(this);$.postJSON(b.getHref(),{},function(a){if(200===a.code){var c=a.data.blocked_by_hero,d=b.data("seriesId");$("#blocked-"+d).toggleClass("hidden",c),$("#unblocked-"+d).toggleClass("hidden",!c)}})},updateBury:function(a){panda.stopEvent(a);var b=$(this);$.postJSON(b.getHref(),{},function(a){if(200===a.code){var c=a.data.buried_by_hero,d=b.data("seriesId");$("#buried-"+d).toggleClass("hidden",c),$("#unburied-"+d).toggleClass("hidden",!c)}})}}},panda.hero.statisticsSeries=function(){var a,b={},c="savedSearch",d=$(".saved-list");return b={init:function(){return $(".chart-menu a").click(b.changeChartTab),$(".saveSearchBtn").click(b.saveSearch),a=JSON.parse(localStorage.getItem(c))||{},b.showSavedSearchList(),$("body").on("click",".saved-use-btn",b.useSavedSearchQuery).on("click",".saved-delete-btn",b.deleteSaveSearchQuery),b},deleteSaveSearchQuery:function(d){panda.stopEvent(d);var e=$(this),f=e.data("tag");panda.alert({title:"are you sure?",body:"Deleting tag",isConfirm:!0,cb:function(){delete a[f],localStorage.setItem(c,JSON.stringify(a)),b.showSavedSearchList()}})},useSavedSearchQuery:function(a){panda.stopEvent(a);var b=$(this),c=b.data("query");$("#query").val(c),$("#query").parent().submit()},showSavedSearchList:function(){d.empty(),$.each(a,function(a,b){var c=panda.templateCompile("saved-list-row",{tag:a,query:b});d.append(c)})},saveSearch:function(d){panda.stopEvent(d);var e=$(this),f=e.closest("form"),g=f.find(".tag"),h=f.find(".query");if(""===g.val()||""===h.val())return void panda.alert({body:"Every field should be filled."});a[g.val()]=h.val(),localStorage.setItem(c,JSON.stringify(a)),b.showSavedSearchList()},changeChartTab:function(a){panda.stopEvent(a);var b=$(this),c=b.data("target-div-id"),d=b.data("target-callback"),e=b.data("chart-class");b.closest(".chart-menu").find("li a:not(#"+b.attr("id")+")").parents("li").removeClass("selected"),b.parents("li").toggleClass("selected"),$("."+e+":not(#"+c+")").addClass("hidden"),$("#"+c).toggleClass("hidden"),null!==window[d]&&(window[d](),window[d]=null)}}},panda.hero.tapasticPick=function(){var a={},b="Series";return a={init:function(c){"series"===c?($("a.add-series").on("click",a.add),$("a.update-order").on("click",a.updateOrder)):"creator"===c?(b="Creator",$(".js-add-creator").on("click",a.add),$(".js-update-order").on("click",a.updateOrder)):(b="Episode",$("a.add-episode").on("click",a.add)),$("a.update-status").on("click",a.updateStatus)},add:function(a){panda.stopEvent(a);var c,d=$(this);c=prompt(b+" id/ids. (ex: 10 or 123,110,220)"),$.trim(c)&&$.postJSON(d.getHref(),{isPlain:!0,params:c},function(){panda.goPage()})},updateOrder:function(a){panda.stopEvent(a);var b,c=$(this);(b=prompt("["+c.data("id")+" : "+c.data("title")+"] - order number."))&&!isNaN(b)&&$.postJSON(c.getHref(),{isPlain:!0,display_order:b},function(){panda.goPage()})},updateStatus:function(a){panda.stopEvent(a);var b=$(this),c=b.data("visible");$.postJSON(b.getHref(),{isPlain:!0,visible:!c},function(){panda.goPage()})}}},panda.hero.collection=function(){var a,b={},c="/hero/import/series-of",d=$(".js-ajax-table"),e=$(".js-title-input"),f=$(".js-url-input"),g=$(".js-add-series"),h=$(".js-series-input"),i=$(".js-add-tag"),j=$(".js-tag-input"),k=$(".js-available-tag"),l=$(".js-series-list"),m=$(".js-tag-list"),n=[],o=function(a){var b=pInt(a.find(".js-update-name").val());$.inArray(b,n)<0&&(n.push(b),l.append(a)),u()},p=function(a){var b=panda.templateCompile("tpTag",{name:a});m.find(".js-tag").filter('[value="'+a+'"]').length>0||m.append(b)},q=function(){var a=$(this),b=a.val();b=b.toLowerCase().replace(/[^\w\d\-]/g,"-"),f.val(b),v.apply(f)},r=function(a){panda.stopEvent(a),$(".js-file-section").find("input").val(""),$(".js-file-img").empty(),$(".js-file-name").val(""),$("#fileRemoved").val(!0)},s=function(a){panda.enter2submit(a,{fn:b.addSeries,scope:g})},t=function(a){panda.enter2submit(a,{fn:b.addTag,scope:i})},u=function(){n.length>2?h.removeAttr("required"):h.attr("required","required")},v=function(){var a=$(this),b=a.val();""!==b&&$.getJSON("/hero/collection/url",{isPlain:!0,url:b},function(b){a.val(b.data.url)})},w=function(a){panda.stopEvent(a);var b=pInt($(this).next().val());$(this).parent().remove(),n=n.filter(function(a){return b!==a}),u()},x=function(a){panda.stopEvent(a);var b=$(this).next().val();$(this).parent().remove(),$(".js-remove-btn").filter('[data-tag="'+b+'"]').each(function(){w.apply($(this))})},y=function(a){panda.stopEvent(a),j.val($(this).text().replace("#","")),i.click()},z=function(){l.find(".js-update-name").each(function(){n.push(pInt($(this).val()))})},A=function(a){panda.stopEvent(a);var b=prompt("Current order is "+$(this).data("order")+". Please enter a new order.");if(null!==b&&panda.isNumber(b)&&!(b<0)){var c=panda.getActionFormSubmit();c.attr({method:"post"}),c.append($('<input type="hidden" name="order">').val(b)),panda.actionFormSubmit($(this).getHref())}},B=function(a){panda.stopEvent(a);var b=$(this),c=b.data("modalId"),d=panda.templateCompile(c);panda.showOverlay(d,!0)};return b={init:function(c){if(c)$(".js-status-checkbox").on("change",b.toggleAllCheckbox),$(".js-collection-checkbox").on("change",b.toggleCheckbox),$(".js-app-only-btn").on("click",b.applyAppOnly),$(".js-order-btn").on("click",A),b.loadSeriesDetail(),panda.require("fn.ajaxPaging",d,20,10,0,!0,b.loadSeriesDetail,!1);else{panda.require("heroFn.checkTextLength"),a=panda.require("heroFn.importTarget",{addBlurEvent:!1}),z(),e.on("input",q),f.on("input",q).on("input",v),h.on("keydown",s),j.on("keydown",t),g.on("click",b.addSeries),i.on("click",b.addTag),k.on("click",y),$("body").on("click",".js-remove-btn",w).on("click",".js-remove-tag",x).on("click",".js-clear-banner",r),$("#collection").on("submit",b.submitForm);var l=$("#js-sortable");l.isExists()&&Sortable.create(l[0])}},applyAppOnly:function(){var a=$(".js-collection-checkbox:checked").length,b=[];if(a>0){$(".js-collection-checkbox:checked").each(function(){b.push($(this).data("id"))});var c=panda.getActionFormSubmit();c.attr({method:"post"}),c.append($('<input name="ids">').val(b.join(","))),panda.actionFormSubmit("/hero/collection/apply-app-only")}},loadSeriesDetail:function(){$(".js-series-btn").on("click",B)},toggleCheckbox:function(){$(this).prop("checked")||$(".js-status-checkbox").prop("checked",!1)},toggleAllCheckbox:function(){$(".js-collection-checkbox").prop("checked",$(this).prop("checked"))},addTag:function(a){panda.stopEvent(a);var b=j.val().trim();""!==b&&$.getJSON(c,{isPlain:!0,tag:b},function(a){var c=a.data.html;$(c).each(function(){o($(this))}),j.val(""),p(b)})},addSeries:function(a){panda.stopEvent(a);var b=h.val().trim(),d=/^\d*(,\d*)*$/;""!==b&&d.test(b)?$.getJSON(c,{isPlain:!0,ids:b},function(a){var b=a.data.html;$(b).each(function(){o($(this))}),h.val("")}):panda.alert({body:"Please check Series Ids. Comma separated numbers only"})},submitForm:function(){var a=function(a,b){a.find(".js-update-name").each(function(){var a=$(this),c=a.data("field"),d=c.replace("__idx__",b);a.attr("name",d),a.hasClass("js-order")&&a.val(b)})};l.find("li").each(function(b){a($(this),b)}),m.find("li").each(function(b){a($(this),b)})}}},panda.hero.genre=function(){var a,b=$(".js-premium");return{init:function(){panda.require("heroFn.uploadEvent"),a=panda.require("heroFn.importTarget",{addBlurEvent:!1}),$(".js-ugc-check").on("change",function(){var a=$(this).prop("checked");b.toggleClass("hidden",a),a&&(b.find(".js-file-name").val(""),b.find(".js-file-img").empty(),$("#artworkFile").val(""),b.find(".js-series-id").val(""),b.find(".js-preview-content").empty())}),$(".js-series-id").each(function(){a.bindBlurEvent($(this)),""!==$(this).val()&&$(this).blur()})}}},panda.hero.help_resource=function(){var a,b={},c=$("#answer"),d=$("#answer-html"),e=$("#answer-preview");return b={init:function(){b.setEvents()},setEvents:function(){c.on("keydown",b.parseAnswer),marked.setOptions({sanitize:!0}),c.val().length>0&&b.parseAnswer(),$(".js-save-btn").on("click",b.save)},save:function(a){if(panda.stopEvent(a),"true"===c.attr("isParsing"))return panda.alert({title:"warn",body:"Markdown is now parsing. Please wait a second and retry."}),!1;this.form.submit()},parseAnswer:function(){setTimeout(function(){a&&clearTimeout(a),c.attr("isParsing",!0);var b=c.val();b!==c.data("prevVal")&&(a=setTimeout(function(){marked(b,function(a,b){if(a)return e.addClass("error"),e.html("Parsing error...<br>"+a),void d.val("");b=b.replace(/!\{:youtube (\d+)x(\d+)\}\(([^\)]+)\)/g,'<iframe width="$1" height="$2" src="//www.youtube.com/embed/$3" frameborder="0" allowfullscreen></iframe>'),e.html(b),d.val(b),c.attr("isParsing",!1)}),c.data("prevVal",b)},300))},1)}}},panda.hero.otherRevenueBalance=function(){var a={},b=$("#uname"),c=$("#ownerId"),d=$(".btn-save"),e=$(".clear-user"),f=$("#user-details-holder");return a={init:function(){return a.setEvents(),a},setEvents:function(){b.on("keydown",function(b){return!panda.enter2submit(b,{fn:a.lookupUser,scope:this})}),$("#revenue-balance-form").submit(a.submit),$(".lookup-user").on("click",a.lookupUser),e.on("click",a.clearUserInfo),f.on("click",".paging-prevnext",a.paging)},submit:function(){if(d.hasClass("disabled"))return!1;var a=$(this),c=$("#amount"),e=$("#description"),f=$("#feeRate"),g=c.val();return a.find("#ownerId").val()?g?0===e.val().length?(panda.alert({body:"Please enter description."}),e.focus(),!1):(f.val()||f.val(0),confirm(panda.format("[{{uname}}/ amount: ${{amount}} / feeRate : {{feeRate}}%] Is this correct??",{uname:b.val(),amount:g,feeRate:f.val()}))):(c.focus(),!1):(panda.alert({body:"Please enter Creator."}),!1)},lookupUser:function(){f.empty(),c.val("");var a=b.val();return a&&$.getJSON("/hero/other-revenue-balance/lookup-user?unameOrEmail="+a,function(a){c.val(a.data.id),e.removeClass("hidden"),d.removeClass("disabled");var b={otherRevenueId:a.data.revenue_id,period:"",heroView:!0},g=a.data,h={profileImageSrc:g.profile_image_src,uname:g.uname,totalBalance:g.total_balance,availableBalance:g.available_balance};$.getJSON("/dashboard/revenue/history/hero-view",b,function(a){h.history=a.data.html,h.__pure=!0,f[0].innerHTML=panda.templateCompile("tpRevenueHistory",h)})}),!0},paging:function(a){panda.stopEvent(a);var b=$(this).getHref();$.getJSON("/dashboard/revenue/history/hero-view"+b,function(a){f.find(".history-body-holder")[0].innerHTML=a.data.html})},clearUserInfo:function(){b.val(""),f.empty(),c.val(""),e.addClass("hidden"),d.addClass("disabled")}}},panda.hero.dailyFeeds=function(){var a,b={};return b={init:function(c){a=c.from,b.setEvents()},setEvents:function(){$(".create-btn, .update-btn").on("click",b.createFeed),$(".delete-btn").on("click",b.deleteFeed)},createFeed:function(a){panda.stopEvent(a);var b,c,d=$(this);if(b=prompt("New Daily Feed. \nDate and episode ids with commas. (ex: 20141225,123,110,220)\nRequires 5 episodes at least.")){c=$.trim(b).split(",");var e=[];if($.trim(b)&&c.length>5)for(var f=0;f<c.length;f++)""!==$.trim(c[f])&&panda.isNumber(c[f])&&e.push($.trim(c[f]));if(!(e.length>5))return void panda.alert({title:"something's wrong",body:"Needs date and episode ids more than 4."});var g={displayDate:e[0],episodeIds:e.slice(1).toString()};$.post(d.getHref(),g,function(){panda.goPage()})}},deleteFeed:function(a){panda.stopEvent(a);var b=$(this);confirm("Really?")&&$.post(b.getHref(),{},function(){panda.goPage()})}}},panda.hero.announcement=function(){var a={};return a={init:function(){return $(".preview-btn").on("click",a.preview),$(".save-btn").on("click",a.send),a},preview:function(){var b=$("#message").val().trim(),c=$("#link").val().trim(),d={content:b,link:""===c?"/":c},e=panda.templateCompile("tpAnnouncementPreview",d);if(""===b||""===c)return void panda.alert({body:"Message/Link are required."});e.find(".send-btn").on("click",a.send).siblings(".edit-btn").on("click",function(){panda.hideOverlay()}),panda.showOverlay(e,!0)},send:function(){var a=$("#message").val().trim(),b=$("#link").val().trim(),c={isPlain:!0};if(""===a||""===b)return void panda.alert({body:"Message/Link are required."});$.each($("#announcement").serializeArray(),function(a,b){c[b.name]=b.value}),$.postJSON("/hero/announce/send",c,function(a){200===a.code&&panda.goPage("/hero/announce/list")})}}},panda.hero.revive=function(){var a={};return a={init:function(){return $(".dataTable").on("click",".update-btn",a.updateStatus).DataTable({iDisplayLength:25}),a},updateStatus:function(a){panda.stopEvent(a);var b=$(this);panda.getActionFormSubmit().appendHiddenField({name:"userId",value:b.data("userId")}),panda.actionFormSubmit(b.getHref())}}},panda.hero.banner=function(){var a,b={},c=$(".js-link-section");return b={init:function(){return panda.require("heroFn.uploadEvent"),a=panda.require("heroFn.importTarget"),$(".js-link-opt").on("change",b.toggleLinkType),$(".js-client-type").on("change",b.toggleClientType),b},toggleLinkType:function(){var b=$(this),d=b.data("section");c.addClass("hidden").filter(d).removeClass("hidden"),c.find("input").removeAttr("required").val(""),a.clearPreview($(".js-preview-content")),$(d).find("input").attr("required","required")},toggleClientType:function(){var a=$(this);$(".js-link-opt").filter("[value=collection]").attr("disabled","disabled").prop("checked",!1),$(".js-collection-section").addClass("hidden"),"APP"===a.val()&&$(".js-link-opt").filter("[value=collection]").removeAttr("disabled")}}},panda.hero.appAnnouncement=function(){var a="/hero/import/ad-campaign/__id__?position=ANNOUNCEMENT",b={init:function(){return panda.require("heroFn.manageCountries"),panda.require("heroFn.uploadEvent"),$(".js-platform-type").on("click",function(){$(".js-platform").toggleClass("hidden",!$(this).is(":checked"))}),$(".js-os-type").on("change",b.togglePlatforms),$(".js-special").on("change",b.toggleSpecialStatus),$(".js-ad-campaign-id").on("blur",b.checkAdCampaign),$("#actionLink").on("input",function(){var a=this.value.replace(/^\/(episode|collection|genre)\//,"/$1s/");this.value=a.trim()}),""!==$(".js-ad-campaign-id").val()&&$(".js-ad-campaign-id").blur(),b},checkAdCampaign:function(){var b=$(this).val().trim(),c=a.replace("__id__",b);""!==b&&panda.isNumber(b)?$.getJSON(c,{isPlain:!0},function(a){var b=a.data;$(".js-preview-content").empty().append(b.html),$("#title").val(b.title)}):panda.alert({body:"Number only"})},toggleSpecialStatus:function(){var a=$(this).prop("checked"),b=$(".js-ad-section");b.toggleClass("hidden",!a),$(".js-label-section").toggleClass("hidden",!a),$(".js-country-section, .js-platform-section").toggleClass("hidden",a),$(".js-action-link").toggleClass("hidden",a),a?(b.find("input").attr("required","required"),$("#type").val("SPONSORED_OFFER"),$("#actionLink").removeAttr("required").val("")):(b.find("input").removeAttr("required"),$(".js-ad-campaign-id").val("").next().empty(),$(".js-label-section").find("input").val(""),$("#type").val("NONE"),$("#actionLink").attr("required","required"))},togglePlatforms:function(){var a=$(this),b=a.val(),c=""===b,d="IOS"===b?$(".js-android"):$(".js-ios"),e="IOS"===b?$(".js-ios"):$(".js-android");c?($(".js-android").removeClass("hidden"),$(".js-ios").removeClass("hidden")):(d.addClass("hidden"),e.removeClass("hidden"))}};return b},panda.hero.role=function(){return{init:function(){return $(".js-update-btn").on("click",function(a){panda.stopEvent(a);var b=$(this),c=b.data("tpId"),d=panda.templateCompile(c);d.find(".js-check").on("click",function(){return!1}),panda.showOverlay(d,!0)}),this}}},panda.hero.feed=function(){var a,b={},c=$(".js-source-input");return b={init:function(c){return c?$(".js-preview-btn").on("click",b.preview):(a=$(".js-type").val(),panda.require("heroFn.checkTextLength"),panda.require("heroFn.uploadEvent"),$(".js-type").on("change",b.loadSetting),$("#sourceId").on("blur",b.loadReference),$(".js-url-input").on("blur",b.validateUrl)),b},loadSetting:function(){var d=$(this),e=d.val(),f="LINK"===e,g=f?".js-url":".js-link",h="SPONSORED_OFFER"!==e;a=e,b.cleanValues(),c.addClass("hidden").filter(g).removeClass("hidden"),h?$(".js-file-name").attr("required","required"):$(".js-file-name").removeAttr("required"),f?$("#sourceId").removeAttr("required"):$("#sourceId").attr("required","required");var i=e.substring(0,1)+e.toLowerCase().substring(1);$(".js-source-label").text(i)},loadReference:function(){var b=$("#sourceId").val().trim();if(""!==b){if(isNaN(pInt(b)))return panda.alert({body:"Please enter number"}),void $("#sourceId").val("");var c="/hero/import/check/"+a+"/"+b;$.getJSON(c,{isSkipCommonAlert:!0},function(a){var b=a.data;200===a.code?($("#label").val(b.label),$("#headline").val(b.headline),$("#description").val(b.description)):(panda.alert({body:a.msg}),$("#sourceId").val(""),$("#label").val(""),$("#headline").val(""),$("#description").val(""))})}},cleanValues:function(){$(".js-input").val(""),$(".js-file-name").val("").removeAttr("readonly"),$(".js-file-section").find("input").val(""),$(".js-file-img").empty(),$(".js-file-input").val("")},preview:function(a){panda.stopEvent(a),$.getJSON("/hero/feed/preview",{},function(a){var b=a.data,c=panda.templateCompile("tpFeedPreview",{html:b.html});panda.showOverlay(c,!0)})},validateUrl:function(){var a=$(this),b=a.val().trim();""!==b&&$.postJSON("/hero/feed/validate-link",{isPlain:!0,link:b},function(){})}}},panda.hero.notice=function(){var a,b,c={},d=$(".js-editor");return c={init:function(){return a=panda.require("fn.fileUploadToS3"),b=panda.require("heroFn.editor",d),b.loadContent($(".js-html").text()),$(".js-submit-btn").on("click",c.preprocessSubmit),c},preprocessSubmit:function(){if(b.isEmpty())return panda.alert({body:"Editor content is empty"}),!1;panda.showLoading();var c=$(this),d=c.data("toCreate"),e=b.getMarkup();a.uploadToR("HERO_HTML_ASSET",{html:e},function(a){var b=a.s3;d&&($("#descKey").val(b.desc_keys[0]),$("#bucket").val(b.desc_bucket_name)),$("#srcKey").val(b.src_keys[0]),$("#srcBucket").val(b.bucket_name),$("#notice").submit()})}}},panda.hero.eventCode=function(){var a={},b=$(".js-code"),c=$(".js-code-error");return a={init:function(){return panda.require("heroFn.importTarget"),$(".js-gen-code-btn").on("click",a.generateCode),b.on("blur",a.checkUnique).on("input",a.removeSpace),a},hideError:function(){c.addClass("hidden"),$(".js-length-error").addClass("hidden")},removeSpace:function(){var b=$(this).val().replace(/[^\w\d]+/g,"");b=b.toUpperCase(),$(this).val(b),a.hideError()},generateCode:function(c){panda.stopEvent(c);for(var d=11,e=5,f=Math.floor(Math.random()*(d-e)+e),g=function(){var a=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];return a[Math.floor(Math.random()*a.length)]},h="",i=0;i<f;i++)h+=g();b.val(h),a.checkUnique.apply(b),a.hideError()},checkUnique:function(){var a=$(this),b=a.val().trim(),d=a.data("id")||"";if(b.length<5)return void $(".js-length-error").removeClass("hidden");$.getJSON("/hero/event-codes/check",{code:b,id:d},function(a){a.data.exist&&c.removeClass("hidden")})}}},panda.hero.visualAsset=function(){var a,b={},c=$(".js-file-input"),d=$(".js-object-id"),e=$(".js-object-type");return b={init:function(){a=panda.require("heroFn.importTarget"),panda.require("heroFn.uploadEvent"),e.on("change",b.changeObjectType),$(".js-type").on("change",b.changeType),$("#visualAsset").on("submit",b.submitForm),$(".hero-content").on("click",".js-remove-content",b.removeItem);var c=$("#js-sortable");c.isExists()&&Sortable.create(c[0]);var f=e.filter(":checked");return""!==d.val()&&a.callBlurEvent(d,"SERIES"===f.val()),a.bindBlurEvent(d,"SERIES"===f.val()),b},changeType:function(){var a=$(this),b=a.data("pileType"),d="CAROUSEL"===a.val();c.data("type",b).data("multiple",d),$(".js-contents").empty(),$(".js-file-img").empty(),$(".js-single-file").val(""),d?c.attr("multiple","multiple"):c.removeAttr("multiple")},changeObjectType:function(){var b=$(this),c=b.val(),e="SERIES"===c;$(".js-object-id").val("").data("prevId","0"),a.bindBlurEvent(d,e),a.clearPreview($(".js-preview-content")),$(".js-episode-only").toggleClass("hidden",e),$(".js-series-only").toggleClass("hidden",!e)},rearrangeItems:function(){$(".js-contents").find("li").length>0?($(".js-contents").children(".preview-file").each(function(a){$(this).find(".js-update-name").each(function(){var b=$(this),c=b.data("field"),d=c.replace("__idx__",a);b.attr("name",d),b.hasClass("js-file-idx")&&b.val(a)})}),$(".js-single-file").remove()):""===$(".js-single-file").val()&&$(".js-single-file").remove()},removeItem:function(a){panda.stopEvent(a),$(this).parent().parent().remove()},submitForm:function(){return $(".js-contents").find("li").length>0||$(".js-file-img").children().length>0?(b.rearrangeItems(),!0):(panda.alert({body:"Please upload images"}),!1)}}},panda.hero.weeklySchedule=function(){var a={};return a={init:function(){return panda.require("heroFn.handleSeriesImporting"),$("#weeklySchedule").on("submit",a.submitForm),a},submitForm:function(){$(".js-series-list").find("li").each(function(a){$(this).find(".js-update-name").each(function(){var b=$(this),c=b.data("field"),d=c.replace("__idx__",a);b.attr("name",d)})})}}},panda.hero.marketingWelcomePlan=function(){var a,b=function(b){var c=$(this),d=c.parent();panda.stopEvent(b),d.hasClass("active")||($(".js-day-wrap").removeClass("active").filter(d).addClass("active"),$.getJSON(c.getHref(),{day:c.data("day")},function(b){$(".js-plan-section").empty().html(b.data.html),a.update($("body").find(".js-ajax-table"))}))};return{init:function(){a=panda.require("fn.ajaxPaging",$(".js-ajax-table"),20,10,0,!0,null,!1),$(".js-day-tab").on("click",b)}}},panda.hero.marketingPlanRecommendation=function(){return{init:function(){var a=panda.require("heroFn.largerImage");panda.require("fn.ajaxPaging",$(".js-active-table"),25,10,0,!0,a.adjust,!1),panda.require("fn.ajaxPaging",$(".js-inactive-table"),25,10,0,!0,a.adjust,!1)}}},panda.hero.marketingPlan=function(){var a,b,c,d={},e="/hero/marketing-plans/preview",f="/hero/import/collection/__id__",g="/hero/import/ad-campaign/__id__?position=MARKETING_PLAN",h=$("#type"),i=$(".js-series-id"),j=$(".js-required-txt"),k=$(".js-promotion-opt"),l=$(".js-promotion-id"),m=$(".js-import-asset-btn"),n=$(".js-preview-btn"),o=$(".js-start-date"),p=$(".js-end-date"),q=$(".js-start-hour"),r=$(".js-end-hour"),s=$(".js-target-specific"),t=$(".js-create-condition"),u=$(".js-condition-form"),v=$(".js-asset-section"),w="TODAY_SERIES"===h.val(),x="PROMOTION"===h.val(),y="WELCOME_PLAN"===$("#subType").val(),z="RECOMMENDATION"===$("#subType").val(),A=function(){$(".js-cancel-condition").click()},B=function(){var a=l.val().trim(),b=g.replace("__id__",a);""!==a&&panda.isNumber(a)?$.getJSON(b,{isPlain:!0},function(a){var b=a.data;$(".js-preview-content").empty().append(b.html)}):panda.alert({body:"Number only"})},C=function(){var a=l.val().trim(),b=f.replace("__id__",a);""!==a&&panda.isNumber(a)?$.getJSON(b,{isPlain:!0,c_type:"APP"},function(a){var b=a.data;$(".js-preview-content").empty().append($("<p>").text(b.title))}):panda.alert({body:"Number only"})},D=function(){if(!y&&!z)if(void 0!==o.attr("required")&&""===o.val()||void 0!==p.attr("required")&&""===p.val())panda.alert({body:"Please set the date."});else{var a=q.val()||"00",b=r.val()||"23",c=moment(o.val()+" "+a+":00","YYYY-MM-DD HH:mm"),d=moment(p.val()+" "+b+":00","YYYY-MM-DD HH:mm");if(c.isAfter(d)||c.isSame(d))var e=setTimeout(function(){panda.alert({body:"End date must be later than start date"}),clearTimeout(e),p.val("")},100)}},E=function(a){var b=["Series ID e.g., 40430","Episode ID e.g., 8182","Collection ID e.g., 10","External URL e.g., https://tapas.io","Sponsored Offer ID e.g., 10"],c=a.data("idx"),d=3===c?"ctaTargetLink":"ctaTargetId";l.attr("placeholder",b[c]).attr("name",d).data("prevId",0).toggleClass("js-series-id",0===c).toggleClass("js-episode-id",1===c).toggleClass("js-ad-campaign-id",4===c)},F=function(){$(".js-error").addClass("hidden")},G=function(a){panda.stopEvent(a);var b=w?"":"BANNER_A",d="SERIES",e=i.val();x&&!y&&(d=k.filter(":checked").val()),c.load({oType:d,aType:b,id:e,is_marketing:!0})},H=function(a){var b=$(".js-headline"),c=$(".js-blurb");""!==b.val()&&b.data("pVal")!==b.val()||(b.val(a.data.dto.title.substr(0,100)),b.data("pVal",b.val())),""!==c.val()&&c.data("pVal")!==c.val()||(c.val(a.data.dto.blurb),c.val(c.val().slice(0,140)),c.data("pVal",c.val()))};return d={init:function(){return a=panda.require("heroFn.importTarget",{cbForSeries:H}),b=panda.require("heroFn.importUser",{cbBeforeImporting:A}),c=panda.require("heroFn.importAsset",{type:"SERIES"}),panda.require("fn.timepicker",$(".pikaday"),{allowPast:!1,allowToday:!w,onSelect:d.checkValidDate}),panda.require("heroFn.manageCountries"),panda.require("heroFn.uploadEvent"),v.hasClass("empty")&&v.removeClass("empty").empty(),k.on("change",d.handlePromotionType),j.on("input",F),n.on("click",d.preview),r.on("change",D),s.on("change",d.toggleTargetSpecific),t.on("click",d.buildConditions),m.on("click",G),x&&E(k.filter(":checked")),$(".js-url-converter").on("click",function(a){panda.stopEvent(a);try{var b=new URL(l.val());"tapas.io"===b.host&&(b.host="m.tapas.io"),""===b.search?b.search="no_promo=":-1===b.search.indexOf("no_promo")&&b.searchParams.append("no_promo","true"),l.val(b.toString())}catch(c){}}),d},handlePromotionType:function(){var b=$(this),c=b.data("idx"),d=0===c||1===c,e=2===c||3===c,f=4===c,g=$(".js-file-name");E(b),$(".js-preview-content").empty(),$(".js-asset-field").toggleClass("hidden",!d),$(".js-pile-field").toggleClass("hidden",d),$("#uploadFile").val(""),g.val(""),$(".js-file-img").empty(),l.val("").off("blur"),F(),d?0===c?a.bindBlurEvent(i,!0):a.bindBlurEvent($(".js-episode-id"),!1):2===c?l.on("blur",C):f&&l.on("blur",B),e||f?g.attr("required","required"):g.removeAttr("required"),e||d||f?l.attr("required","required").removeClass("hidden"):(g.attr("required","required"),l.removeAttr("required").addClass("hidden")),f?$(".js-target-row, .js-country-row, .js-push-row").addClass("hidden"):$(".js-target-row, .js-country-row, .js-push-row").removeClass("hidden"),$(".js-link-helper").toggleClass("hidden",3!==c)},buildConditions:function(a){panda.stopEvent(a),u.addClass("on"),u.on("click",".js-cancel-condition",function(){u.removeClass("on"),u.find("input").val("")}).on("click",".js-look-up",d.lookUp)},checkValidDate:function(a,b,c,d){if(!y&&!z){var e=$(d),f="startDate"===e.attr("name");if(b=b<10?"0"+b:b,c=c<10?"0"+c:c,w&&f){var g=a+"-"+b+"-"+c;$.getJSON("/hero/marketing-plans/exist/"+g,{isPlain:!0},function(a){if(a.data.is_exist)var b=setTimeout(function(){panda.alert({body:"The date has already been taken. Please choose another date."}),clearTimeout(b),e.val("")},100);else{var c=moment(o.val()+"00:00","YYYY-MM-DD HH:mm");p.val(c.add(6,"d").format("YYYY-MM-DD"))}})}f||D()}},lookUp:function(a){panda.stopEvent(a);var b=$(".js-condition"),c=$(".js-redis-key"),d=/^\d*(,\d*)*$/,e=b.val().trim();""!==e&&d.test(e)?(panda.showLoading(),$.getJSON("/hero/import/subscribers",{isPlain:!0,series_ids:e},function(a){var d=panda.templateCompile("tpTarget",{targetCnt:a.data.target_cnt});$(".js-target-list").empty().append(d),u.removeClass("on"),c.val(a.data.target_index_key),b.val("")})):panda.alert({body:"Please check Series IDs. Comma separated numbers only"})},preview:function(a){panda.stopEvent(a);var b=!1,c=v.children().length>0,d=""!==($("#uploadFile").val()||"")||$(".js-file-img").children().length>0,f=x?k.filter(":checked").val():"NONE";if(j.each(function(){""===$(this).val()&&(b=!0)}),!x||"COLLECTION"!==f&&"LINK"!==f&&"SPONSORED_OFFER"!==f?!x||"FREE_COIN_SHOP"!==f&&"COIN_SHOP"!==f?b||!c:!d:b||!d)$(this).prev().removeClass("hidden");else{var g={isPlain:!0};if(d){var h=new URL($(".js-file-img").find("img").attr("src"));g["pile.filePath"]=h.pathname,g["pile.s3.cdnHost"]=h.origin}$.each($("#marketingPlan").serializeArray(),function(a,b){g[b.name]=b.value}),$.getJSON(e,g,function(a){var b=panda.templateCompile("tpMarketingPlanPreview",{html:a.data.html});panda.showOverlay(b,!0),b.find(".carousel").carousel({interval:3e3})})}},toggleTargetSpecific:function(){var a=$(this).prop("checked");$(".js-target-specific-section").toggleClass("hidden",!a)}}},panda.hero.hashTag=function(){var a={},b=$(".js-series-list");return a={init:function(){panda.require("heroFn.handleSeriesImporting"),$(".js-tag-name").on("input",a.parseInput),$("#hashTag").on("submit",a.submitForm),$(".js-internal-tag").on("click",a.addSeries),$(".js-toggle-series").on("change",a.toggleSeries)},addSeries:function(a){panda.stopEvent(a);var c=$(this).data("tag");$.getJSON("/hero/internal-tag/premium-series-list",{tag_name:c},function(a){if(0===a.length)return void panda.alert({title:"oops!",body:"There are no series in "+c});$.each(a,function(a,c){$(".js-series").filter('[value="'+c.id+'"]').length>0||b.append(panda.templateCompile("tpSeriesList",{title:c.title,id:c.id,imgUrl:c.imgUrl}))})})},parseInput:function(){var a=$(this),b=$(this).val().replace(/[^\s\w\d]+/g,"");b=b.replace(/\s+/g,"_"),a.val(b)},toggleSeries:function(){"series"===$(this).val()?($(".js-series").removeClass("hidden"),$(".js-genre").addClass("hidden"),$(".js-none").prop("checked",!0)):($(".js-series").addClass("hidden"),$(".js-genre").removeClass("hidden"),$(".js-series-list").empty())},submitForm:function(){if($(".js-series-list").find("li").each(function(a){$(this).find(".js-update-name").each(function(){var b=$(this),c=b.data("field"),d=c.replace("__idx__",a);b.attr("name",d)})}),"genre"===$(".js-toggle-series").filter(":checked").val()){if($(".js-none").filter(":checked").length>1)return panda.alert({body:"Please select genre"}),!1}else $(".js-genre").prop("disabled",!0)}}},panda.hero.payout=function(){return{init:function(a){$(".js-export-btn").on("click",function(a){panda.stopEvent(a);var b=$(this),c=$(".js-user-id").val(),d=b.getHref()+c;b.hasClass("disabled")||(b.addClass("disabled"),panda.goPage(d),setTimeout(function(){b.removeClass("disabled")},300))}),$(".js-block-paypal").on("click",function(b){panda.stopEvent(b);var c=prompt("Paypal email address");if($.trim(c)){var d=panda.getActionFormSubmit();d.attr({method:"post"}),d.append($('<input type="hidden" name="email">').val(c)),d.append($('<input type="hidden" name="page">').val(a)),panda.actionFormSubmit($(this).getHref())}})}}},panda.namespace("heroFn"),panda.heroFn.sort=function(){var a={},b=$(".sort-list"),c=function(a,b,c){return"asc"===c?a>b:a<b};return a={init:function(){return $(".sort-btn").on("click",a.sort),a},sort:function(a){panda.stopEvent(a);var d=$(this),e=d.data("orderby"),f=d.data("sortBy")||"asc";d.data("sortBy","asc"===f?"desc":"asc");for(var g=b.length-1;g>0;g--)for(var h=0;h<g;h++){var i=b.eq(h),j=b.eq(h+1);c(i.find("."+e).data("val"),j.find("."+e).data("val"),f)&&(j.after(i),b=$(".sort-list"))}}}},panda.heroFn.checkTextLength=function(){return{init:function(){$(".js-txt-valid").on("input",function(){var a=$(this),b=a.val().length,c=a.data("limit");a.siblings(".js-txt-length").text(b).siblings(".js-length-error").toggleClass("hidden",b<c)}),$(".js-txt-length").each(function(){var a=$(this);a.text(a.parent().find(".js-txt-valid").val().length)})}}},panda.heroFn.toggleGift=function(){var a,b={};return b={init:function(){return $(".js-gift-type-condition").on("change",b.toggleType),b},setCallback:function(c){return a=c,b},toggleType:function(){var b=$(this),c=b.children(":checked"),d=c.data("class"),e=!!c.val().match("PAID"),f="INK_PLUS"===b.val(),g=f||"COIN"===b.val();$(".js-option").addClass("hidden").filter(d).removeClass("hidden"),$(".js-option.hidden").find("input").removeAttr("required").val(""),$(d).find("input").attr("required","required"),$(".js-series-id").data("prevId","0").toggleClass("js-require-paid-series",e),$(".js-add-target").toggleClass("js-need-check-series",!g),$(".js-expiration-date").toggleClass("hidden",f),f?$(".js-optional-amount").removeAttr("required").attr("min","0"):$(".js-optional-amount").attr("required","required").attr("min","1"),panda.callback(a)}}},panda.heroFn.importTarget=function(){var a,b,c,d={},e=!0,f=$(".js-object-id"),g=$("body").find(".js-series-id"),h=$("body").find(".js-episode-id"),i=!1,j=!1,k=!0,l=0,m=0,n="/hero/import/episode/",o="/hero/import/series/",p="/hero/import/check-series-key/",q=function(a){k&&(g.isExists()&&d.bindBlurEvent(g,!0,(a||{}).cbForSeries),h.isExists()&&d.bindBlurEvent(h,!1,(a||{}).cbForSeries),f.isExists()&&d.bindBlurEvent(f),g.isExists()&&""!==g.val()&&g.blur(),h.isExists()&&""!==h.val()&&h.blur())},r=function(d){a=d||{},b=a.cb||null,j=a.withCheckingKey||!1,k=void 0===a.addBlurEvent||a.addBlurEvent,j&&(c=p)},s=function(a){var b=a,c=b.val().trim(),d=b.hasClass("js-require-paid-series")||!1,e=b.hasClass("js-require-series-type")||!1,f=b.hasClass("js-require-premium-series")||!1,g=b.hasClass("js-require-ugc-series")||!1,h=b.hasClass("js-require-check-key")||j,k={isPlain:!0};if(""===c||!panda.isNumber(c))return{};if(k.id=c,k.shouldPaid=d,k.premiumOnly=f,k.ugcOnly=g,e){var l=$(".js-display-location").val()||"";k.seriesType="HOME"===l||"MAIN"===l||"CREATORS"===l?"":l.toUpperCase()}if(h){if(""!==c&&$(".js-gift-amount").val()<1)return panda.alert({title:"hey!",body:"Amount or free episode cnt must be greater than 0."}),b.next().empty(),b.data("prevId",0),{};k.amount=$(".js-gift-amount").val(),k.free="FREE_KEY"===$(".js-gift-type-condition").val()}if(i){if(""!==c&&$(".js-series-id[value="+c+"]").length-1>0)return panda.alert({title:"hey!",body:"Already added.",cb:function(){b.val("")}}),{}}return k},t=function(a,e,f,g,h){var i=e.id;c=g?c:n,setTimeout(function(){a.data("prevId")!==i&&(e.alertCB=function(){a.val(""),f&&d.clearPreview(f)},$.getJSON(c+i,e,function(c){a.data("prevId",i),g?l=i:m=i,f&&f.html(c.data.html),panda.callback(h,c),null!==b&&panda.callback(b,c)}))},1)},u=function(a,b,d){e=a;var f=b||!1;c=e?f?o:d||j?p:o:n},v=function(){var a=$(this),b=s(a),c=a.siblings(".js-preview-content");if($.isEmptyObject(b))return void a.val("");t(a,b,c,!1)},w=function(a){var b=$(this),c=b.data("toUpdate")||!1,d=b.hasClass("js-require-check-key")||j,e=b.siblings(".js-preview-content"),f=s(b);if($.isEmptyObject(f))return void b.val("");u(!0,c,d),t(b,f,e,!0,a)};return d={init:function(a){return r(a),q(a),d},bindBlurEvent:function(a,b,c){var f=void 0===b?e:b;return u(f),f?a.on("blur",function(){w.call(a,c)}):a.on("blur",function(){v.call(a,c)}),d},callBlurEvent:function(a,b){u(void 0===b?e:b),a.isExists()&&""!==a.val()&&a.blur()},adjustSeriesInputs:function(){i=$(".js-series-id").length>1},clearPreview:function(a){l=0,m=0,a.html("")},importSeries:function(a,b,c){var d=a,e=d.data("toUpdate")||!1,f=d.hasClass("js-require-check-key")||j,g=s(d),h=b?a.next():null;if($.isEmptyObject(g))return void d.val("");u(!0,e,f),t(d,g,h,!0,c)}}},panda.heroFn.importUser=function(){var a,b,c,d={},e="/hero/import/user/",f=!1,g=$(".js-target-input"),h=$(".js-import-target"),i=$(".js-add-target"),j=$(".js-target-list"),k=$("#csvFileUploadForm"),l=$("#targetIndexKey"),m=$(".js-redis-key"),n=$("#targetCnt"),o="targets[]",p=function(a){return $(".js-added-target[value="+a+"]").isExists()},q=function(a){var b=o.indexOf("[");return o.substring(0,b+1)+a+o.substring(b+1)},r=function(a){var b=a,c=b.hasClass("js-need-check-series")||!1,d={};if(c){var e=[];$(".js-series-id").each(function(){var a=$(this).val();""!==a&&e.push(a)}),d.for_free_key="FREE_KEY"===$(".js-gift-type-condition").val(),d.series_ids=e.join(",")}return d},s=function(a){panda.stopEvent(a),$(this).parent().remove(),j.find(".js-added-target").each(function(a){$(this).attr("name",b+"["+a+"]"+c)})},t=function(d){d&&(o=d.format||"",b=o.substring(0,o.indexOf("[")),c=o.substring(o.indexOf("]")+1),a=d.cbBeforeImporting)},u=function(b){panda.stopEvent(b),panda.callback(a),$(this).hasClass("disabled")||setTimeout(function(){$(".js-file").click()},5)};return d={init:function(a){return t(a),f=l.isExists()||m.isExists(),h.on("click",u),i.on("click",d.addTarget),k.children(".js-file").on("change",d.importTarget),$("body").on("click",".js-remove-target",s),d},addTarget:function(a){panda.stopEvent(a);var b=$(this),c=g.val().trim(),d=""!==c,h=r(b);b.hasClass("disabled")||(f&&d&&(l.isExists()&&""!==l.val().trim()&&(j.children().remove(),l.val("")),m.isExists()&&""!==m[0].val().trim&&(j.children().remove(),m.val(""))),d&&!p(c)&&(j.find("span.error").remove(),$.getJSON(e+c,h,function(a){var b=a.data.user_name,d=a.data.uname,e=j.children().length,f=d===b?"":b,h={id:c,inputName:q(e),idx:e,name:b,uname:d,displayName:f},i=panda.templateCompile("tpUser",h);j.append(i),g.val("")})))},importTarget:function(){$(".js-target-btn").addClass("disabled"),panda.uploadFile(k,{},function(a){j.children().remove();var b=panda.templateCompile("tpTarget",{targetCnt:a.data.target_cnt});j.append(b),l.val(a.data.target_index_key),m.val(a.data.target_index_key),$(".js-target-btn").removeClass("disabled"),n.isExists()&&n.val(a.data.target_cnt)})},clearTarget:function(){j.children().remove(),l.val(""),n.val(0)},injectTempIndexKey:function(){$("#targetIndexKey").val("CAMPAIGN_USERS_TEMP")}}},panda.heroFn.importAsset=function(){var a,b,c,d={},e="/hero/import/assets/",f=$(".js-asset-list"),g=function(){f.hasClass("loaded")?$(window).one("click.closed",function(){f.removeClass("loaded").empty()}):$(window).off("click.closed")},h=function(c){var h=c||{},i=h.id,j=""!==i&&void 0!==a,k=h.oType||a;return j?f.hasClass("loaded")?void d.close():(h.isPlain=!0,h.type=h.aType||b,void $.getJSON(e+k+"/"+i,h,function(a){f.removeClass("loaded").empty().append(a.data.html).addClass("loaded"),g(),$(".js-error").addClass("hidden")})):void panda.alert({body:"Please check object type, series id, or episode id."})},i=function(d){d&&(a=d.type,b=d.aType,c=d.cb)},j=function(a){if(panda.stopEvent(a),c)panda.callback(c,$(this).parent());else{var b=$(this).parent().clone();b.find(".js-select-btn").remove(),$(".js-asset-section").empty().append(b),f.empty().removeClass("loaded")}};return d={init:function(a){return i(a),$("body").on("click",".js-select-btn",j),d},load:function(a){h(a)},close:function(){f.removeClass("loaded").empty()}}},panda.heroFn.handleFile=function(){var a,b,c,d,e,f,g,h={};return h={init:function(){return h},render:function(i){return a=i,b=a.closest(".js-file-wrap"),c=b.find(".js-file-name"),d=b.find(".js-file-upload"),e=b.find(".js-file-section"),f=b.find(".js-file-img"),g=panda.escapeCssNotation(a.data("objName")),e.isExists()||(e=$(".js-file-result-wrap").find(".js-file-section")),f.isExists()||(f=$(".js-file-result-wrap").find(".js-file-img")),h},setResult:function(b){var h=b,i=$(g),j=i.isExists()?i:e.children(":first-child"),k=a.data("type"),l=a.data("multiple"),m=function(a){e.append(panda.templateCompile("tp-multi-file",{value:JSON.stringify(a),filename:a.filename,uuid:panda.uid(),url:a.s3.url}))};d.removeClass("disabled"),panda.showGlobalMessage("Upload completed!"),l?h.length>1?$.each(h,function(a,b){m(b)}):m(h):(j.val(JSON.stringify(h)),c.val(h.filename).attr("readonly","readonly"),$("#fileRemoved").val(!1),"EPUB"!==k&&f.empty().append($("<img />").attr("src",h.s3.url).attr("height","50")))}}},panda.heroFn.uploadEvent=function(){var a,b,c={},d=10;return c={init:function(){return a=panda.require("fn.fileUploadToS3"),b=panda.require("heroFn.handleFile"),$("body").on("click",".js-file-upload",function(a){panda.stopEvent(a);var b=$(this);b.hasClass("disabled")||b.closest(".js-file-wrap").find(".js-file-input").click()}),$("body").on("change",".js-file-input",function(){var c=$(this),e=c.data("type"),f=c.closest(".js-file-wrap").find(".js-file-upload");if(""===e)return panda.alert({body:"Please check asset type"}),void f.removeClass("disabled");if(""!==e&&""!==c.val().trim()){f.addClass("disabled"),panda.showGlobalMessage("Uploading...",!1,!1,-1);var g=this.files,h=Math.min(g.length,d),i=[];if("VISUAL_SQUARE_ASSET"===e)for(var j=0;j<h;j++)i.push(g.item(j));else i=g;var k={files:i};"EPUB"===e&&(k.dev=!0),a.uploadToR(e,k,b.render(c).setResult,{errorCallback:function(){panda.hideGlobalMessage(),f.removeClass("disabled")}})}}),c}}},panda.heroFn.manageCountries=function(){var a={},b=$(".js-all-countries"),c=$(".js-countries"),d=$(".js-country-code-section");return a={init:function(){$(".js-manage-country").on("click",a.toggleCountryCode),b.on("change",a.toggleCountryCodeAll),c.change(a.toggleAllCountries)},toggleAllCountries:function(){!$(this).prop("checked")&&b.prop("checked")&&b.prop("checked",!1),0===c.filter(":not(:checked)").length&&b.prop("checked",!0)},toggleCountryCodeAll:function(){c.prop("checked",$(this).prop("checked")),d.toggleClass("closed",$(this).prop("checked"))},toggleCountryCode:function(a){panda.stopEvent(a),d.toggleClass("closed",!d.hasClass("closed"))}}},panda.heroFn.markdown=function(){var a,b={};return b={init:function(){return marked.setOptions({sanitize:!0}),b},loadMarkdown:function(a,b,c){void 0===c&&(c=a.val()),marked(c,function(c,d){if(c)return b.addClass("error"),void b.html("Parsing error...<br>"+c);b.html(d),a.attr("isParsing",!1)}),a.data("prevVal",c)},parseMarkdown:function(c,d){setTimeout(function(){a&&clearTimeout(a),c.attr("isParsing",!0);var e=c.val();e!==c.data("prevVal")&&(a=setTimeout(function(){b.loadMarkdown(c,d,e)},300))},1)}}},panda.heroFn.handleSeriesImporting=function(){var a,b={},c=$(".js-series-id"),d=function(b){panda.stopEvent(b);var d=c.val();if($(".js-series").filter('[value="'+d+'"]').length>0)return void c.val("");a.importSeries(c,!1,function(a){var b=panda.templateCompile("tpSeries",{html:a.data.html,id:d});$(".js-series-list").append(b),c.val("")})},e=function(a){panda.stopEvent(a),$(this).parent().remove(),c.data("prevId",0)};return b={init:function(){return a=panda.require("heroFn.importTarget",{addBlurEvent:!1}),$(".js-add-btn").on("click",d),$(".hero-content").on("click",".js-remove-btn",e),b}}},panda.heroFn.largerImage=function(){var a={};return a={init:function(){return a.adjust(),a},adjust:function(){$(".js-larger-img").each(function(){$(this).on("mouseover",function(){var a=($(this).width()-30)/2;$(this).find(".js-larger-btn").css({left:a+"px"})})}),a.show()},show:function(){$(".js-larger-btn").on("click",function(a){panda.stopEvent(a);var b=panda.templateCompile($(this).data("templateId"));panda.showOverlay(b,!0),b.find(".carousel").carousel({interval:3e3}),b.find(".carousel-control.left").on("click",function(a){panda.stopEvent(a),b.find(".carousel").carousel("prev")}),b.find(".carousel-control.right").on("click",function(a){panda.stopEvent(a),b.find(".carousel").carousel("next")})})}}},panda.heroFn.editor=function(){var a,b={},c={},d=[["format",["style"]],["style",["bold","italic","underline","strikethrough","clear"]],["fontsize",["fontsize"]],["color",["color"]],["para",["ul","ol","paragraph"]],["insert",["link","picture","video"]],["hr",["hr"]]],e=1e3,f=!1,g=function(){a&&a.isExists()&&(a.summernote({placeholder:"Write here",tabsize:2,minHeight:300,maxHeight:600,toolbar:d,fontNames:["Lato","Lora"],maxTextLength:15e3,callbacks:c,popover:{image:[["float",["floatLeft","floatRight","floatNone"]],["remove",["removeMedia"]]],link:[["link",["linkDialogShow","unlink"]]],air:[["color",["color"]],["font",["bold","underline","clear"]],["para",["ul","paragraph"]],["table",["table"]],["insert",["link","picture"]]]}}),$(".note-palette:odd").find(".note-palette-title").text("Text Color"))},h=function(a){a&&(a.toolbar&&(d=a.toolbar),a.callbacks&&(c=a.callbacks),a.limit&&a.limit>0&&(e=a.limit))},i=function(){var b=a.next().find(".note-editable").text();return b=b.replace("\\",""),b.length},j=function(){return a.next().find(".note-editable").text().trim().split(/\s+/).length};return b={init:function(c,d){return a=c,h(d),g(),b},clear:function(){a.summernote("reset")},setOverLimit:function(a){return f=a,b},isEmpty:function(){return a.summernote("isEmpty")&&0===i()},isOverLimit:function(){return f},getMarkup:function(){return a.summernote("code")},getTextLength:function(){return i()},getWords:function(){return j()},loadContent:function(c){return a.summernote("code",c),b.setOverLimit(i()>e),b}}},panda.namespace("heroTapas"),panda.heroTapas.user=function(){var a=function(){var a=$(this),b=a.next(),c=a.val(),d=a.data("prevUname");b.isExists()||(a.after($('<span class="error hidden">')),b=a.next()),c=c.replace(/\s+/g,""),c!==d?$.getJSON("/validate-uname",{name:c},function(a){a.data.exist?b.text("Darn! That's already taken. Please try something else.").removeClass("hidden"):b.text("").addClass("hidden")}):b.text("").addClass("hidden"),a.val(c)};return{init:function(){panda.require(["heroFn.uploadEvent","heroFn.checkTextLength"]),$(".js-uname").on("input",a)}}},panda.heroTapas.dailyPickList=function(){var a=$(".js-ajax-table");return{init:function(){var b=panda.require("heroFn.largerImage");panda.require("fn.ajaxPaging",a,25,10,0,!0,b.show,!1)}}},panda.heroTapas.dailyPick=function(){var a,b,c,d,e,f={},g=0,h="/episode/lookup/__id__",i="/hero/import/episode-contents/__id__",j=$("#books"),k=$(".js-episode-id"),l=$(".js-look-up"),m=$(".js-blurb"),n=$(".js-html-preview"),o=$(".js-image-preview"),p=$(".js-import-asset-btn"),q=$("#hasSharingThumb"),r=$("#uploadFile"),s=panda.getEnvs("rTapasIoHost")+"/s3/";return f={init:function(){return d=panda.require("heroFn.importAsset",{type:"EPISODE",cb:f.selectAsset}),a=k.val().trim(),b="true"===j.val(),l.on("click",f.lookup),p.on("click",f.importAsset),m.on("input",f.completePreview),$(".js-change-image").on("click",f.showCropModal),$("#dailyPick").on("submit",f.submitForm),$(".js-blurb-preview").isExists()&&f.adjustPadding($(".js-blurb-preview")),f},selectAsset:function(a){var b=a.find("img").attr("src");$(".js-preview-img").attr("src",b),$("#assetId").val(a.find("input").val()),d.close()},importAsset:function(b){panda.stopEvent(b),d.load({aType:"BANNER_B",id:a})},adjustPadding:function(a){var b=(a.height()-a.find("p").height())/2;a.find("p").css({paddingTop:b+"px"})},completePreview:function(){var a=$(".js-blurb-preview");if(a.isExists()){var b=$(this),c=b.val();b.val(c),a.find("p").text('"'+c+'"'),f.adjustPadding(a)}},lookup:function(c){panda.stopEvent(c);var d=k.val().trim();if(""!==d){a=d;var e=h.replace("__id__",d);$.getJSON(e,{},function(a){var c=a.data;b=c.books,$(".js-image-section").toggleClass("hidden",b),$(".js-blurb-section").toggleClass("hidden",!b),n.empty(),o.empty(),r.val(""),m.val(""),q.val(c.has_sharing_thumb),f.handleProperties(),b?c.has_epub?n.append(c.html):c.has_html&&n.append(c.ugc_html):(o.html(panda.templateCompile("tpImagePreview",{imgUrl:c.sharing_thumb_url})),$("body").find(".js-change-image").on("click",f.showCropModal))})}},handleProperties:function(){j.val(b),b?m.attr("required","required"):m.removeAttr("required")},handleButtons:function(a){var b=(($(window).width()-940)/2-60)/2,c=($(window).height()-60)/2,d=($(window).width()-940)/2+940+b;a.find(".js-dir-left").css({left:b+"px",top:c+"px"}),a.find(".js-dir-right").css({left:d+"px",top:c+"px"}),a.on("click",".js-cancel-btn",function(a){panda.stopEvent(a),$(this).hasClass("disabled")||(g=0,panda.hideOverlay(),f.releaseCropper())}).on("click",".js-reload-btn",function(b){panda.stopEvent(b),$(this).hasClass("disabled")||(g=0,f.releaseCropper(),f.loadCropper(a))}).on("click",".js-save-btn",f.saveImage).on("click",".js-dir-right, .js-dir-left",function(b){if(panda.stopEvent(b),!$(this).hasClass("disabled")){var c=document.getElementById("js-cropping-area"),d=a.find(".js-img"),e=d.length;f.countPaging.call(this,e),f.releaseCropper(),f.loadImage(c,d,Math.min(g+2,e))}})},showCropModal:function(b){if(panda.stopEvent(b),""!==a){var c=i.replace("__id__",a);$.getJSON(c,{isPlain:!0},function(a){var b=panda.templateCompile("tpCropper",{html:a.data.html});f.convertImageUrl(b),panda.showOverlay(b,!1),f.loadCropper(b),f.handleButtons(b)})}},convertImageUrl:function(a){a.find(".js-img").each(function(){var a=$(this).attr("src"),b=a.split("/").slice(3).join("/");b=-1!==a.indexOf("cloudfront")?s+"r.tapas.io/"+b:s+b,$(this).attr("src",b)})},countPaging:function(a){var b=$(this),c=b.hasClass("left");g=c?Math.max(g-1,0):g+1;var d=0===g?"none":"block",e=g===a-1||g===a-2?"none":"block";$(".js-dir-left").css({display:d}),$(".js-dir-right").css({display:e})},loadCropper:function(a){f.convertImage(a.find(".js-img"))},convertImage:function(a){for(var b=document.getElementById("js-cropping-area"),c=a.length,d=0,e=0,h=0;h<c;h++){var i=a[h].width;d=Math.min(Math.max(i,d),940),e+=a[h].height}b.width=d,e<=screen.height?($(".js-dir-right, .js-dir-left").css({display:"none"}),f.loadImage(b,a,a.length)):($(".js-dir-left").css({display:"none"}),f.loadImage(b,a,c<g+2?c:g+2))},loadImage:function(a,b,c){for(var d=0,e=0,h=0,i=0,j=0,k=!1,l=a.getContext("2d"),m=g;m<c;m++){var n=b[m].width,o=b[m].height;k=m===c-1,i=Math.min(Math.max(n,i),940),j+=o,d=Math.max(i-n,0)/2,e=0===h?e:e+b[m-1].height,a.height=j,h++,f.draw(l,b[m],d,e,k,a)}},draw:function(a,b,c,d,e,g){var h=new Image;h.crossOrigin="Anonymous",h.onload=function(){a.drawImage(h,c,d),e&&f.callCropper(g)},h.src=b.src},callCropper:function(a){e=new Cropper(a,{aspectRatio:1.91,viewMode:1,zoomable:!1,movable:!1,rotatable:!1,scalable:!1,minCropBoxWidth:191,minCropBoxHeight:100,data:document.getElementById("js-cropping-area").toDataURL()})},releaseCropper:function(){e&&(e.destroy(),e=null)},saveImage:function(a){if(panda.stopEvent(a),!$(this).hasClass("disabled")&&e){var b=e.getCroppedCanvas();if("1.9"!==(1*b.width/b.height).toFixed(1))return void panda.alert({body:"Please check image ratio. The ratio is 1.91:1"});c=panda.require("fn.fileUploadToS3");var d=b.toDataURL();""!==d&&($(".js-crop-btn").addClass("disabled"),panda.showGlobalMessage("Saving image...",!1,!1,-1),c.uploadToR("VISUAL_RECTANGLE_ASSET",{b64:d},function(a){var b=a.s3.url;$(".js-preview-img").attr("src",b),r.val(JSON.stringify(a)),g=0,panda.hideGlobalMessage(),panda.hideOverlay(),f.releaseCropper(),$(".js-crop-btn").removeClass("disabled")},{errorCallback:function(){$(".js-crop-btn").removeClass("disabled")}}))}},submitForm:function(){if(!b){if(!("true"===q.val()||""!==r.val()||""!==$("#assetId").val()))return panda.alert({body:"Asset is required"}),!1}if(b&&""===m.val().trim())return panda.alert({body:"Blurb is required"}),!1}}},panda.heroTapas.dailySnack=function(){var a={},b=$(".js-add-episode"),c=$(".js-episode-list"),d=$(".js-episode-id");return a={init:function(b){panda.require("heroFn.checkTextLength"),panda.require("heroFn.uploadEvent"),panda.require("fn.timepicker",$(".pikaday"),{allowPast:!1,onDraw:a.markEditedDays,onSelect:a.goToDate});var d=$("#js-sortable");return d.isExists()&&Sortable.create(d[0]),a.setEvents(),b.length>0&&b.forEach(function(a){var b=panda.templateCompile("tp-episode",a);c.append(b)}),a},goToDate:function(a,b,c){var d=moment([a,b-1,c]).format("YYYYMMDD");panda.goPage("/hero/daily-snack/create?date="+d)},markEditedDays:function(a,b){$.getJSON("/hero/daily-snack/days",{year:a,month:b},function(a){a.data.days.forEach(function(a){$(".pika-table td[data-day="+a+"] button").css({"background-color":"teal",color:"white","-webkit-border-radius":"50%","-moz-border-radius":"50%","border-radius":"50%"})})})},setEvents:function(){$("#js-daily-snack-form").submit(a.setPlaceHolderAsDefault).submit(a.trim).submit(a.setEpisodeInputsIndex).submit(a.validateTime).submit(a.validateEpisodeList),b.click(a.addEpisode),d.on("keypress",function(b){panda.isEnter(b)&&a.addEpisode(b)}),$(".js-delete").click(a.delete)},trim:function(){$(".js-trim").val(function(){return $.trim($(this).val())})},delete:function(a){panda.stopEvent(a);var b=$(this).getHref();panda.alert({title:"are you sure?",body:"Do you want to delete this Daily Snack?",isConfirm:!0,cb:function(){$.postJSON(b,function(a){panda.goPage(a.data.url)})}})},validateTime:function(a){var b=$(".js-validate-time");return Number(b.val().split(":")[1])%5==0||(panda.alert({body:"Time should be 5 minutes basis. e.g., 12:00, 12:05, 12:10..."}),panda.stopEvent(a),!1)},validateEpisodeList:function(a){var b=$(".js-get-episode-id").map(function(){return $(this).val()}).get();return 0===b.length?(panda.alert({body:"Episode List should not be empty."}),panda.stopEvent(a),!1):new Set(b).size!==b.length?(panda.alert({body:"Episode List has duplicated episodes."}),panda.stopEvent(a),!1):void 0},addEpisode:function(a){panda.stopEvent(a);var e=d.val();if(e){var f=b.getHref()+e;$.getJSON(f,function(a){var b=panda.convertKeyFromSnakeToCamel(a.data.episode),e=panda.templateCompile("tp-episode",b);c.append(e),d.val("")})}},setEpisodeInputsIndex:function(){$(".js-set-index").each(function(a){$(this).attr("name",$(this).attr("name").replace("__index__",a))})},setPlaceHolderAsDefault:function(){$(".js-default-placeholder").each(function(){if(""!==$.trim($(this).val()))return!0;$(this).val($(this).attr("placeholder"))})}}},panda.heroTapas.tileCollection=function(){var a;return a={init:function(){panda.require("heroFn.uploadEvent"),a.setEvents();var b=$("#js-sortable");return b.isExists()&&Sortable.create(b[0]),a},setEvents:function(){$(".hero-content").on("click",".js-remove-tile",a.removeContent),$(".js-submit").click(a.resetMultiInputNames),$("body").on("change",".js-show-tile-type-info",a.showTileTypeInfo).on("keyup",".js-show-id-info",a.showIdInfo)},showIdInfo:function(){var a=$(this),b=a.closest(".js-tile-item"),c=b.find(".js-id-info"),d=function(){var d=b.find(".js-tile-input:checked").val(),e=a.val(),f=function(a,b){c.text(a),c.toggleClass("error",b)};"URL"!==d&&(panda.isNumber(e)?$.getJSON("/hero/tile-collection/tile/"+d+"/"+e,function(a){f(a.data.message,a.data.not_found)}):e?f("Please enter only numbers",!0):f("",!1))},e=setTimeout(function(){clearTimeout(e),d()},100)},showTileTypeInfo:function(){var a=$(this),b=["Series Id e.g., 40430","Creator Id e.g., 1048194","Collection Id e.g., 10","Genre Id e.g, 1","External URL e.g., https://tapas.io","Episode Id e.g., 8182"],c=a.data("index"),d=a.val(),e=a.closest(".js-tile-item"),f=e.find(".js-set-placeholder"),g=e.find(".js-toggle-hidden");f.attr("placeholder",b[c]),g.toggleClass("hidden","GENRE"!==d),$(".js-id-info",e).text(""),$(".js-show-id-info",e).val("")},removeContent:function(a){panda.stopEvent(a),$(this).parent().remove()},resetMultiInputNames:function(a){var b=!1;$(".js-contents").children(".preview-file").each(function(a){b=!0,$(this).find(".js-update-name").each(function(){var b=$(this).data("field"),c=b.replace("__idx__",a);$(this).attr("name",c)})}),b||panda.stopEvent(a)}}},panda.heroTapas.campaign=function(){var a,b,c={},d=$(".js-gift-list");return c={init:function(d){return d||!1?($(".js-schedule-btn").on("click",c.showScheduleModal),panda.require("fn.timepicker",$(".pikaday"))):(a=panda.require("heroFn.importTarget",{withCheckingKey:!0}),b=panda.require("heroFn.importUser"),panda.require("heroFn.uploadEvent"),panda.require("heroFn.checkTextLength"),panda.require("heroFn.toggleGift"),panda.require("fn.timepicker",$(".pikaday"),{allowPast:!1}),$(".js-add-gift").on("click",c.addGift),$(".js-gift-type-condition").on("change",c.adjustGift),$(".js-all-accounts").on("click",b.injectTempIndexKey),c.setEvents(),c.setGift()),c},setEvents:function(){$(".js-remove-gift").on("click",c.removeGift)},showScheduleModal:function(a){panda.stopEvent(a);var b=$(this),d=panda.templateCompile("tp-schedule",{action:b.getHref()});panda.showOverlay(d,!0),d.find(".js-amount").on("input",function(){var a=$(this),b=pInt(a.attr("maxLength")),c=a.val().trim();c.length>b&&a.val(c.substring(0,b))}),c.submitSchedule(d),panda.require("fn.timepicker",$(".pikaday"),{allowPast:!1})},submitSchedule:function(a){a.find(".js-schedule-submit").on("click",function(){var b=!0;a.find("input").each(function(a,c){""===$(c).val().trim()&&(b=!1,panda.alert({title:"oops!",body:"Start date and expiration should not be empty."}))}),b&&a.find("form").submit()})},setGift:function(){"COIN"!==$(".js-gift-type-condition").val()&&0===d.children(".js-gift-item").length&&c.addGift(null)},adjustGift:function(){var c=$(this),e="COIN"===c.val();e?($(".js-gift-item").remove(),a.clearPreview($(".js-preview-content")),d.append($('<input type="hidden" name="gifts[0].id" class="js-coin-id">'))):($(".js-gift-item.hidden").remove(),$(".js-coin-id").remove(),0===d.children().length&&$(".js-add-gift").click()),$(".js-add-gift").toggleClass("hidden",e),d.toggleClass("closed hidden",e),b.clearTarget()},addGift:function(b){panda.stopEvent(b);var e=d.children(".js-gift-item"),f=e.length,g="COIN"===$(".js-gift-type-condition").val();if(5!==f&&!g){d.find("span.error").remove();var h={idx:f};h.keyStatus=g?"hidden":"",h.requireKey=g?"":'required="required"';var i=panda.templateCompile("tp-gift",h);d.append(i),c.setEvents(),a.bindBlurEvent(i.find(".js-series-id")).adjustSeriesInputs()}},removeGift:function(b){panda.stopEvent(b),$(this).closest(".js-gift-item").remove(),d.children(".js-gift-item").each(function(a){$(this).find(".js-series-id").attr("name","gifts["+a+"].seriesId")}),a.adjustSeriesInputs()}}},panda.heroTapas.waitSchedule=function(){var a={},b=$("#waitSchedule"),c=$(".js-interval-list"),d=$(".js-interval-input").find(".js-amount"),e=function(){var a={};return d.each(function(){var b=$(this),c=b.val();a[b.attr("name")]=""===c?0:pInt(c)}),a};return a={init:function(){return $(".js-add-interval").on("click",a.addInterval),$(".js-create").on("click",a.save),$(".js-delete-interval").on("click",a.deleteInterval),a},addInterval:function(b){panda.stopEvent(b);var f=e();if(0!==f.day+f.hour+f.minute+f.second){f.strIntervals=f.day+","+f.hour+","+f.minute+","+f.second,f.idx=c.find(".js-interval").length;var g=panda.templateCompile("tp-interval",f);g.find(".js-delete-interval").on("click",a.deleteInterval),c.children("span").remove(),c.append(g),d.val(0)}},deleteInterval:function(a){panda.stopEvent(a),$(this).parent().remove();var b=c.find(".js-interval");0===b.length&&c.append($("<span>").text("No data").addClass("no-data")),b.each(function(a,b){$(b).find(".js-str-interval").attr("name","strIntervals["+a+"]")})},save:function(){var a=!0;0===c.find(".js-interval").length&&($(".js-interval-input").parent().addClass("error").find("span.error").removeClass("hidden"),$(".js-interval-input .js-amount").on("focus",function(){$(this).closest(".control-group").removeClass("error").find("span.error").addClass("hidden")}),a=!1),a&&b.submit()}}},panda.heroTapas.reward=function(){var a,b={};return b={init:function(){return a=panda.require("heroFn.importTarget",{withCheckingKey:!0}),panda.require("heroFn.toggleGift").setCallback(b.clearSeries),panda.require("fn.timepicker",$(".pikaday")),b},clearSeries:function(){a.clearPreview($(".js-preview-content"))}}},panda.heroTapas.inbox=function(){var a,b,c={},d=$(".js-gift-box"),e=$(".js-has-gift"),f=$(".js-series-section"),g=$(".js-push-noti-box"),h=$(".js-push-noti");return c={init:function(){return a=panda.require("heroFn.importTarget",{withCheckingKey:!0}),b=panda.require("heroFn.importUser"),panda.require("heroFn.checkTextLength"),panda.require("heroFn.uploadEvent"),panda.require("heroFn.toggleGift").setCallback(c.clearSeries),panda.require("fn.timepicker",$(".pikaday"),{allowPast:!1}),"false"===e.val()&&d.find("input").removeAttr("required"),e.on("change",c.toggleGiftBox),h.on("change",c.togglePushBox),$(".js-add-gift").on("click",c.addSeries),$(".js-all-accounts").on("click",b.injectTempIndexKey),$(".js-series-id").each(function(){""!==$(this).val()&&($(this).next().empty(),a.importSeries($(this),!0,null))}),c},addSeries:function(b){panda.stopEvent(b);var d=f.find(".js-series-element").length,e=panda.templateCompile("tpSeriesElement",{idx:d});5!==d&&(a.bindBlurEvent(e.find(".js-series-id")),e.find(".js-remove-gift").on("click",c.removeSeries),f.append(e))},clearSeries:function(){a.clearPreview($(".js-preview-content")),b.clearTarget()},removeSeries:function(a){panda.stopEvent(a),$(this).parent().remove(),$(".js-series-element").each(function(a){var b="gifts["+a+"].seriesId";$(this).find("input").attr("name",b)})},togglePushBox:function(){var a=$(this),b="true"===a.val();g.toggleClass("hidden",!b),b||$(".js-push-msg").val("")},toggleGiftBox:function(){var a=$(this),e="true"===a.val();if(d.toggleClass("hidden",!e),$(".js-add-target").toggleClass("js-need-check-series",e),e){var f=$(".js-gift-type-condition").children(":checked").data("class");$(f).find("input").attr("required","required"),$(".js-amount").attr("required","required").attr("min","1"),b.clearTarget()}else d.find("input").val("").removeAttr("required").attr("min","0").filter(".js-amount").val(0),c.clearSeries()}}},panda.heroTapas.priceTier=function(){return{init:function(){panda.require("heroFn.uploadEvent"),panda.require("fn.timepicker",$(".pikaday"),{allowPast:!1}),$(".js-offer-type").on("change",function(){$(".js-closing-date").toggleClass("hidden","TIME_LIMIT"!==$(this).val()),$("#offerClosingDate").val("")})}}},panda.heroTapas.appPushNotification=function(){var a=$("#js-history-table"),b=$(".js-notification-form");return{init:function(){panda.require("fn.ajaxPaging",a,40,10,0,!0,null),$(".js-send-btn").on("click",function(){panda.alert({title:"are you sure?",body:"Sending push notification like this.",isConfirm:!0,cb:function(){b.submit()}})}),$.getJSON("/hero/app-notice/list",{},function(b){var c=b.data.body;a.append($(c))})}}},panda.heroTapas.campaignDetails=function(){var a,b={init:function(){return $(".js-more-info").on("click",b.calculate),a=0,b},calculate:function(){var a,b,c,d,e,f,g,h=$(this),i=$("#result"),j=h.data("id"),k="";h.data("ing")||(h.data("ing",!0).text("calculating...."),$.getJSON("/hero/campaign/"+j+"/details",function(h){a=h.data.total_keys_sent,b=h.data.total_keys_claimed,c=h.data.total_keys_used,f=h.data.series,d=a>0?Math.round(b/a*100):0,e=a>0?Math.round(c/a*100):0,g={totalKeys:a,claimedKeys:b,usedKeys:c,claimedPercent:d,usedPercent:e,result4:"N/A"},$.each(f,function(b,c){$.each(c,function(b,c){k+=panda.format("{{name}}: {{percent}}% ({{value}}/{{totalKeys}}),",{name:b,value:c,totalKeys:a,percent:a>0?Math.round(c/a*100):0})})}),g.result4=k.substring(0,k.length-1),i.empty(),i.append(panda.format("<p>1. Total number of Keys sent : {{totalKeys}}</p>",g)),i.append(panda.format("<p>2. % of total keys claimed : {{claimedPercent}}% ({{claimedKeys}}/{{totalKeys}}) </p>",g)),i.append(panda.format("<p>3. % of total keys used : {{usedPercent}}% ({{usedKeys}}/{{totalKeys}}) </p>",g)),i.append(panda.format("<p>4. % keys purchased as a result : {{result4}} </p>",g))}),h.data("ing",!1).text("calculate"))}};return b},panda.heroTapas.report=function(){return{init:function(){panda.require("fn.timepicker",$(".pikaday"),{allowPast:!0});var a=$(".js-by-month"),b=$(".js-by-week"),c=$("#report-form"),d="";$(".js-range").on("change",function(){a.toggleClass("hidden"),b.toggleClass("hidden")}),$(".js-select2").select2(),$(".js-download-btn").on("click",function(a){panda.stopEvent(a);var b,e=$(this),f=e.getHref(),g=c.serializeArray(),h={email:!1,isPlain:!0};g.forEach(function(a){h[a.name]=a.value}),h.user_id=h.userId,(b=JSON.stringify(h))!==d&&(d=b,h.alertCB=function(){e.removeClass("disabled")},e.addClass("disabled"),$.postJSON(f,h,function(){e.removeClass("disabled"),panda.alert({title:"Sent",body:"Please visit the slack channel."})}))})}}},panda.heroTapas.adCampaign=function(){var a,b={};return b={init:function(){return a=panda.require("heroFn.markdown"),panda.require("heroFn.uploadEvent"),panda.require("heroFn.checkTextLength"),panda.require("fn.timepicker",$(".pikaday"),{allowPast:!1}),panda.require("heroFn.manageCountries"),$(".js-os-type").on("change",b.togglePlatforms),$(".js-limit-type").on("change",b.toggleLimitType),$(".js-unlimit").on("change",b.toggleLimit),$(".js-type").on("change",b.changeType),$(".js-markdown").on("keydown",b.preview),$("form").on("submit",b.handleSubmit),b.loadPreview(),b},handleSubmit:function(){var a="true"===$(".js-limit-type:checked").val(),b=$(".js-os-type:checked").val();a?($("#maxAllowCntForAndroid").val("0"),$("#maxAllowCntForIos").val("0"),$(".js-unlimit.android").filter('[value="TOTAL"]').click(),$(".js-unlimit.ios").filter('[value="TOTAL"]').click()):($("#maxAllowCnt").val("0"),$(".js-unlimit.overall").filter('[value="TOTAL"]').click(),"IOS"===b?($("#maxAllowCntForAndroid").val("0"),$(".js-unlimit.android").filter('[value="TOTAL"]').click()):"ANDROID"===b&&($("#maxAllowCntForIos").val("0"),$(".js-unlimit.ios").filter('[value="TOTAL"]').click())),$(".js-target-url").each(function(){""===$(this).val().trim()&&$(this).val("NONE")})},togglePlatforms:function(){var a=$(this),b=a.val(),c=""===b,d="IOS"===b?$(".js-android"):$(".js-ios"),e="IOS"===b?$(".js-ios"):$(".js-android"),f="IOS"===b?$(".js-android-amt"):$(".js-ios-amt"),g="IOS"===b?$(".js-ios-amt"):$(".js-android-amt");if(c)$(".js-android").removeClass("hidden"),$(".js-ios").removeClass("hidden"),$(".js-limit-wrap > label").removeClass("hidden"),$(".js-android-amt").removeClass("hidden").find("input").attr("required","required").attr("min",1),$(".js-ios-amt").removeClass("hidden").find("input").attr("required","required").attr("min",1),$(".js-target-url").attr("required","required");else{d.addClass("hidden").find(".js-target-url").removeAttr("required"),e.removeClass("hidden").find(".js-target-url").attr("required","required");var h=$(".js-limit-wrap").find("label:first-child"),i=h.find("input"),j=$(".js-limit-wrap").find("label:last-child").find("input");h.addClass("hidden"),i.prop("checked",!1),j.click(),f.addClass("hidden").find("input").removeAttr("required").attr("min",0),g.removeClass("hidden").find("input").attr("required","required").attr("min",1)}"true"===$(".js-limit-type:checked").val()&&$(".js-platform").addClass("hidden")},toggleLimitType:function(){var a=$(this),b="true"===a.val(),c=$(".js-os-type:checked").val();$(".js-overall").toggleClass("hidden",!b),$(".js-platform").toggleClass("hidden",b),"IOS"===c?$(".js-platform.js-android").addClass("hidden"):"ANDROID"===c&&$(".js-platform.js-ios").addClass("hidden")},changeType:function(){var a=$(".js-type-option"),c=a.addClass("hidden").filter('[data-type="'+$(this).val()+'"]').removeClass("hidden");a.find("input.form-control:not(.js-target-url)").removeAttr("required"),c.isExists()&&c.find("input.form-control:not(.js-target-url)").attr("required","required"),"ALL"===$(this).val()&&a.removeClass("hidden").find("input.form-control:not(.js-target-url)").attr("required","required"),b.clearInput(a.filter(".hidden"))},toggleLimit:function(){var a=$(this),b=a.parent().parent().prev().find("input");"UNLIMITED"===a.val()?b.val("").attr("disabled","disabled").attr("placeholder","Unlimited").attr("min","0"):b.val("0").removeAttr("disabled").removeAttr("placeholder").attr("min","1")},clearInput:function(a){a.isExists()&&(a.find("input.form-control").val("").removeAttr("readonly"),a.find("textarea").val(""),a.find(".js-preview").empty(),a.find(".js-txt-length").text("0"),a.find('input[type="hidden"]').val(""),a.find(".preview-img").empty())},loadPreview:function(){$(".js-markdown").each(function(){""!==$(this).val()&&a.loadMarkdown($(this),$(this).parent().find(".js-preview"))})},preview:function(){a.parseMarkdown($(this),$(this).parent().find(".js-preview"))}}},panda.heroTapas.adSubCampaign=function(){var a={};return a={init:function(){return $(".js-position").on("change",a.togglePosition),$(".js-os-type").on("change",a.togglePlatforms),$(".js-limit-type").on("change",a.toggleLimitType),$(".js-unlimit").on("change",a.toggleLimit),$("form").on("submit",a.handleSubmit),$(".js-position:checked").length>0&&a.togglePosition.apply($(".js-position:checked")),a},handleSubmit:function(a){if(0===$(".js-position:checked").length&&"true"===$(".js-create-or-not").val())return $(".js-positions-error").removeClass("hidden"),panda.stopEvent(a),!1;var b=!0;if($(".js-section:not(.hidden)").each(function(){$(this).find(".js-overall:not(.hidden), .js-platform:not(.hidden)").each(function(){0===$(this).find(".js-unlimit:checked").length&&(b=!1,$(this).find(".js-unlimit").attr("required","required"))})}),!b)return panda.stopEvent(a),!1;$(".js-section").each(function(a){var b=$(this),c="true"===b.find(".js-limit-type:checked").val(),d=b.find(".js-os-type:checked").val(),e=b.hasClass("hidden");c?($("#maxAllowCntForAndroid"+a).val("0"),$("#maxAllowCntForIos"+a).val("0"),b.find(".js-unlimit.android").filter('[value="TOTAL"]').click(),b.find(".js-unlimit.ios").filter('[value="TOTAL"]').click()):($("#maxAllowCnt"+a).val("0"),b.find(".js-unlimit.overall").filter('[value="TOTAL"]').click(),"IOS"===d?($("#maxAllowCntForAndroid"+a).val("0"),b.find(".js-unlimit.android").filter('[value="TOTAL"]').click()):"ANDROID"===d&&($("#maxAllowCntForIos"+a).val("0"),b.find(".js-unlimit.ios").filter('[value="TOTAL"]').click())),e&&($("#maxAllowCnt"+a).val(0),$("#maxAllowCntForAndroid"+a).val(0),$("#maxAllowCntForIos"+a).val(0),b.find(".js-unlimit.overall").filter('[value="TOTAL"]').click(),b.find(".js-unlimit.android").filter('[value="TOTAL"]').click(),b.find(".js-unlimit.ios").filter('[value="TOTAL"]').click())})},toggleLimit:function(){var a=$(this),b=a.parent().parent().prev().find("input");"UNLIMITED"===a.val()?b.val("").removeAttr("required").attr("disabled","disabled").attr("placeholder","Unlimited").attr("min","0"):b.val(""===b.val()?"0":b.val()).attr("required","required").removeAttr("disabled").removeAttr("placeholder").attr("min","1")},toggleLimitType:function(){var b,c=$(this),d=c.data("area"),e=$(d),f=e.find(".js-overall"),g=e.find(".js-platform"),h="true"===c.val(),i=$(d).find(".js-os-type:checked").val();if(f.toggleClass("hidden",!h),g.toggleClass("hidden",h),"IOS"===i){var j=e.find(".js-platform.js-ios");b=j.find(".js-unlimit:checked"),e.find(".js-platform.js-android").addClass("hidden"),b.isExists()?a.toggleLimit.apply(b):j.find(".js-limit-cnt").attr("required","required")}else if("ANDROID"===i){var k=e.find(".js-platform.js-android");b=k.find(".js-unlimit:checked"),e.find(".js-platform.js-ios").addClass("hidden"),b.isExists()?a.toggleLimit.apply(b):k.find(".js-limit-cnt").attr("required","required")}h?(g.find(".js-limit-cnt").attr("min",0).removeAttr("required"),b=f.find(".js-unlimit:checked"),b.isExists()?a.toggleLimit.apply(b):f.find(".js-limit-cnt").attr("required","required")):(f.find(".js-limit-cnt").attr("min",0).removeAttr("required"),g.filter(".hidden").find(".js-limit-cnt").attr("min","0").removeAttr("required"),g.filter(":not(.hidden)").find(".js-limit-cnt").attr("required","required"))},togglePlatforms:function(){var b=$(this),c=b.val(),d=b.data("area"),e=$(d),f=""===c,g="IOS"===c?e.find(".js-android"):e.find(".js-ios"),h="IOS"===c?e.find(".js-ios"):e.find(".js-android"),i=$(d).find(".js-limit-wrap");if(f)e.find(".js-android").removeClass("hidden"),e.find(".js-ios").removeClass("hidden"),e.find(".js-limit-wrap > label").removeClass("hidden");else{g.addClass("hidden"),h.removeClass("hidden");var j=i.find("label:first-child"),k=j.find("input"),l=i.find("label:last-child").find("input");j.addClass("hidden"),k.prop("checked",!1),l.click()}if(a.toggleLimitType.apply(e.find(".js-limit-type:checked")),"true"===e.find(".js-limit-type:checked").val()){e.find(".js-platform").addClass("hidden");var m=e.find(".js-overall").find(".js-unlimit:checked");m.isExists()?a.toggleLimit.apply(m):e.find(".js-overall").find(".js-limit-cnt").attr("min",1).attr("required","required")}},togglePosition:function(){$(".js-section").addClass("hidden"),$(".js-position:checked").each(function(){var b=$(".js-"+$(this).val());b.removeClass("hidden"),a.togglePlatforms.apply(b.find(".js-os-type:checked"))}),$(".js-position:not(:checked)").each(function(){var a=$(".js-"+$(this).val());a.find("input").removeAttr("required").filter('[type="number"]').attr("min",0).val(""),a.find(".js-unlimit").prop("checked",!1)}),$(".js-positions-error").addClass("hidden")}}},panda.heroTapas.eventReward=function(){var a={},b=$(".js-target-list"),c=$("#startDate"),d=$("#endDate");return a={init:function(b){if(!b&&1&&(panda.require("heroFn.uploadEvent"),panda.require("heroFn.checkTextLength"),panda.require("fn.timepicker",$(".pikaday"),{allowPast:!0}),$(".js-target-btn").on("click",a.searchTarget),""===c.val().trim())){var e=moment(panda.getEnvs("today"),"yyyy/MM/DD HH:mm:ss"),f=e.clone().add(-1,"days").format("YYYY-MM-DD"),g=e.format("YYYY-MM-DD");c.val(f),d.val(g)}return a},searchTarget:function(a){var e=$(this),f={};panda.stopEvent(a),f.startDate=c.val(),f.endDate=d.val(),$.getJSON(e.getHref(),f,function(a){var c=a.data,d={targetCnt:c.target_cnt,targetTip:c.target_tip},e=panda.templateCompile("tp-target",d);b.html(e),$("#targetCnt").val(c.target_cnt),$("#targetIndexKey").val("NONE")})}}},panda.heroTapas.statistics=function(){return{init:function(){var a=$("#from"),b=$("#to");if(panda.require("fn.timepicker",$(".pikaday")),$(".js-date-type").on("change",function(){$(".js-date-range").toggleClass("hidden"),$(".js-date-kind").toggleClass("hidden")}),""===a.val().trim()){var c=moment(panda.getEnvs("today"),"yyyy/MM/DD HH:mm:ss"),d=c.format("YYYY-MM-DD");a.val(d),b.val(d)}}}},panda.namespace("heroLayout"),panda.heroLayout.element=function(){var a,b={},c=$("#screenForm"),d=$("#previewLayout"),e=$("#layoutModules"),f=$(".js-delete-inactive");return b={init:function(){a=panda.require("heroLayout.fn",e,d),panda.require("heroLayout.banner"),$("#previewLayout, #layoutModules").sortable({items:"li:not(.ui-state-disabled)",connectWith:".connectedSortable"}).disableSelection(),$(".js-banner-preview, .js-banner-target").sortable({items:"li",connectWith:".connectedBanner"}).disableSelection(),f.on("click",b.removeInactive),c.on("submit",b.submitForm)},removeInactive:function(a){panda.stopEvent(a),panda.actionFormSubmit($(this).getHref())},submitForm:function(){a.rename($("#previewLayout"),c)}}},panda.heroLayout.item=function(){var a,b,c={},d=[["BIG_ROW","SMALL_ROW"],["BIG_TILE","SMALL_TILE"]],e=[],f=$("#layoutForm"),g=$(".js-add-section"),h=$(".js-add-form"),i=$(".js-title"),j=$(".js-blurb"),k=$(".js-vue"),l=$(".js-toggle"),m=$(".js-more"),n=$(".js-show"),o=$(".js-pre-vue"),p=$(".js-pre-header"),q=$(".js-add-item"),r=$(".js-cancel"),s=$(".js-update-item");return c={init:function(){return a=panda.require("heroLayout.fn",$("#layoutModules"),$("#previewLayout"),c.updateItem),b=panda.require("heroLayout.banner"),$("#previewLayout, #layoutModules").sortable({items:"li:not(.ui-state-disabled)",connectWith:".connectedSortable"}).disableSelection(),$("#previewTopLayout").sortable(),$(".js-banner-preview, .js-banner-target").sortable({items:"li",connectWith:".connectedBanner"}).disableSelection(),i.on("input",c.enterTitle),j.on("input",c.enterBlurb),k.on("change",c.changeVue),l.on("change",c.toggleToggle),m.on("change",c.toggleMore),q.on("click",c.showAdding),r.on("click",c.cancelAdding),s.on("click",c.updateItem),n.on("change",c.validationShow),h.on("submit",c.validationItem),f.on("submit",c.submitForm),c},showAdding:function(a,b){panda.stopEvent(a);var c=$(this);c.hasClass("disabled")||(c.addClass("disabled"),setTimeout(function(){h.css({display:"block"}),g.css({height:g.addClass("on").find(">form").height()+50}),o.toggleClass("on",!b),o.toggleClass("hidden",b||!1)},350))},cancelAdding:function(a){panda.stopEvent(a),g.removeClass("on").css({height:0}),h.css({display:"none"}),o.removeClass("on"),$(".js-non-support").toggleClass("on",!1),$(".js-editable").toggleClass("hidden",!1),c.resetAddingForm(),k.removeAttr("disabled"),q.removeClass("disabled"),n.prop("checked",!0)},resetAddingForm:function(){h.find("input:text").val(""),h.find("input:checkbox").prop("checked",!1).removeAttr("disabled"),h.find("input:radio").filter(".js-v-1").click(),h.find(".js-id").val(""),h.find(".js-response-type").val(""),c.enterTitle.apply(i),c.enterBlurb.apply(j),$(".js-submit-btn").text("add")},changeVue:function(){var a=$(this),b=a.data("allowToggle"),d=a.data("allowMore");b?l.removeAttr("disabled"):(l.attr("disabled","disabled"),l.prop("checked",!1)),d?m.removeAttr("disabled"):(m.attr("disabled","disabled"),m.prop("checked",!1)),c.loadPreview(a)},enterTitle:function(){var a=$(this).val().trim(),b=""===a?"Item title":a;$(".js-prev-title").text(b)},enterBlurb:function(){var a=$(this).val().trim(),b=""===a?"Blurb section":a;$(".js-prev-blurb").text(b).toggleClass("hidden",""===a)},loadPreview:function(a){var b=a.val(),d="BIG_ROW"===b,e="SMALL_ROW"===b||"SMALL_BOTH_ROW"===b||"SMALL_TILE"===b,f="SMALL_BOTH_ROW"===b,g="RANKING"===b,h="BIG_TILE"===b||"SMALL_TILE"===b,i="SPOTLIGHT"===b,j="TOP_SERIES"===b;o.toggleClass("big",d),o.toggleClass("ranking",g||j),o.toggleClass("both",f),$(".js-single-bundle").toggleClass("small",e).toggleClass("hidden",f||g||h||j),$(".js-multiple-bundle").toggleClass("hidden",!f),$(".js-ranking-bundle").toggleClass("hidden",!g),$(".js-top-bundle").toggleClass("hidden",!j),$(".js-toggle-opt").toggleClass("hidden"),$(".js-pre-header, .js-prev-blurb").toggleClass("hidden",h||i),$(".js-tiles").toggleClass("small",e).toggleClass("hidden",!h),c.toggleToggle(),c.toggleMore()},toggleMore:function(){var a=m.prop("checked");$(".js-multiple-bundle").hasClass("hidden")?($(".js-single-see-all").toggleClass("hidden",!a),p.toggleClass("more",a)):($(".js-multiple-see-all").toggleClass("hidden",!a),$(".js-single-see-all").addClass("hidden"),p.removeClass("more")),a&&(l.prop("checked",!1),c.toggleToggle())},toggleToggle:function(){var a=l.prop("checked");$(".js-toggle-opt").toggleClass("hidden",!a),p.toggleClass("toggle",a),a&&(m.prop("checked",!1),c.toggleMore())},updateItem:function(a){if(panda.stopEvent(a),!q.hasClass("disabled")){var f=$(this).parent(),g=f.find(".js-item-type").val(),n="DAILY_SNACK"===g||"PROMOTION"===g||"BANNER"===g||"WEEKLY_SCHEDULE"===g||"HASH_TAG"===g||"SPOTLIGHT"===g,o="TOP_BANNER"===g,p="BIG_ROW"===g||"SMALL_ROW"===g,r="BIG_TILE"===g||"SMALL_TILE"===g;o?(e=[],c.cancelAdding(a),b.showBanner.apply($(this))):(e=p?d[0]:r?d[1]:[],b.hideBanner(a),h.find(".js-id").val(f.find(".js-item-id").val()),i.val(f.find(".js-item-title").val()),c.enterTitle.apply(i),j.val(f.find(".js-item-blurb").val()),c.enterBlurb.apply(j),h.find(".js-api").val(f.find(".js-item-api").val()),h.find(".js-sub-api").val(f.find(".js-item-sub-api").val()),h.find(".js-xref").val(f.find(".js-item-xref").val()),h.find(".js-sub-order").val(f.find(".js-item-sub-order").val()),h.find(".js-show-newbie").prop("checked","true"===f.find(".js-item-show-newbie").val()),h.find(".js-show-non-newbie").prop("checked","true"===f.find(".js-item-show-non-newbie").val()),h.find(".js-response-type").val(f.find(".js-item-response-type").val()),l.prop("checked","true"===f.find(".js-item-toggle").val()),m.prop("checked","true"===f.find(".js-item-hasmore").val()),k.removeAttr("disabled").filter('[value="'+g+'"]').click(),$(".js-submit-btn").text("update"),$(".js-non-support").toggleClass("on",n),$(".js-editable").toggleClass("hidden",n),c.showAdding.apply(q,[a,n]),c.toggleToggle(),c.toggleMore(),e.length>0&&(k.attr("disabled","disabled"),e.forEach(function(a){k.filter('[value="'+a+'"]').removeAttr("disabled")})))}},validationShow:function(){$(this).parents(".checkbox").find(".alert").toggleClass("hidden",$(".js-show:checked").length>0)},validationItem:function(a){if(h.find(".js-error").length>0&&!h.find(".js-error").hasClass("hidden"))return panda.stopEvent(a),!1;""===$(".js-sub-order").val()&&$(".js-sub-order").val(99)},submitForm:function(){a.rename($("#previewTopLayout, #previewLayout"),f)}}},panda.heroLayout.fn=function(){var a,b,c,d,e="/hero/import/__type__",f=$(".js-search-type"),g=$(".js-search-name"),h=$(".js-search-result"),i=function(){g.val(""),h.removeClass("on").empty()},j=function(){var a=$(this),e=a.data("type"),f=a.data("id"),g=e.toLowerCase(),h="COLLECTION"===e?"SMALL_ROW":e,j="COLLECTION"===e,k="BIG_TILE"===e||"SMALL_TILE"===e?"TILE":e,l={type:e,className:g,id:f,title:a.data("title"),link:a.data("href"),api:a.data("api"),xref:a.data("xref"),vueType:h,rType:k,hasMore:j},m=b.find(".js-"+e+f).isExists(),n=c.find(".js-"+e+f).isExists();if(!m&&!n){var o=panda.templateCompile("tpSearchResult",l);b.append(o),o.find(".js-update-item").isExists()&&o.find(".js-update-item").on("click",d)}i()};return a={init:function(e,h,j){return b=e,c=h,d=j,f.on("change",i),g.on("input",a.searchTarget),a},searchTarget:function(){var a=$(this),b=a.val().trim();if(""!==b){var c=$(".js-client-type").val(),d=e.replace("__type__",f.val().toLowerCase());$.getJSON(d,{isPlain:!0,title:b,c_type:c},function(a){var b=a.data.html;h.empty().append($(b)).addClass("on"),h.find("li").on("click",j)})}else i()},rename:function(a,b){a.find("li").each(function(a){$(this).find("input").each(function(){var c=$(this),d=c.attr("name");c.attr("name",d.replace("__idx__",a)),c.hasClass("js-order")&&c.val(a),b.append(c.clone())})})}}},panda.heroLayout.banner=function(){var a,b,c=$(".js-cancel-banner"),d=$(".js-save-banner"),e=$(".js-banner-row"),f=$(".js-banner-preview"),g=$(".js-banner-target");return a={init:function(){return b=panda.require("heroLayout.fn"),e.on("click",a.showBanner),c.on("click",a.hideBanner),d.on("click",a.saveBanner),a},hideBanner:function(a){panda.stopEvent(a),f.empty(),g.empty(),$(".js-banner-wrap").removeClass("on")},saveBanner:function(a){panda.stopEvent(a);var c=$("#bannerForm");b.rename(f,c),c.submit()},showBanner:function(){var a=$(this),b=a.data("clientType"),c=a.data("location");$.getJSON("/hero/import/banners",{isPlain:!0,c_type:b,location:c},function(a){var b=a.data;f.empty(),g.empty(),$.each(b.current_banners,function(){var a=this,b=a.pile.s3.cdn_host+"/"+a.pile.file_path;f.append(panda.templateCompile("tpBanner",{url:b,id:a.id}))}),$.each(b.banners,function(){var a=this,b=a.pile.s3.cdn_host+"/"+a.pile.file_path;g.append(panda.templateCompile("tpBanner",{url:b,id:a.id}))}),setTimeout(function(){$(".js-banner-wrap").addClass("on")},350)})}}},panda.namespace("heroContent"),panda.heroContent.seriesList=function(){var a=function(a){panda.stopEvent(a);var b=$(this),c=b.data("seriesId"),d=b.data("seriesTitle"),e=b.getHref(),f={title:d,id:c};$.getJSON(e,{},function(a){f.table=a.data.html;var b=panda.templateCompile("tpAddGuest",f),c=b.find(".js-input"),d=b.find(".js-alert"),e=b.find(".js-table-wrap"),g=function(a){panda.stopEvent(a),$.postJSON($(this).getHref(),{},function(a){var b=$(a.data.html);b.find(".js-remove-guest").on("click",g),e.html(""),e.append(b)})};c.on("focus",function(){d.addClass("hidden")}),b.find(".js-add-guest").on("click",function(a){panda.stopEvent(a);var b=$(this),f=b.getHref(),h=c.val().trim();if(""===h)return void d.text("Please enter id, email, or user name.").removeClass("hidden");$.postJSON(f,{isPlain:!0,user:h},function(a){if(a.data.has_error)d.text("User not found.").removeClass("hidden");else{var b=$(a.data.html);b.find(".js-remove-guest").on("click",g),e.html(""),e.append(b)}})}),b.find(".js-remove-guest").on("click",g),panda.showOverlay(b,!0)})},b=function(a){panda.stopEvent(a),panda.actionFormSubmit($(this).getHref())};return{init:function(){panda.require("heroContent.chinaLiterature").importSeries(),$(".js-add-guests").on("click",a),$(".js-star-btn").on("click",b)}}},panda.heroContent.series=function(){var a,b,c,d={},e=$(".js-main-genre");return d={init:function(){return a=panda.require("heroFn.importUser",{format:"subUsers[].id"}),panda.require("heroFn.checkTextLength"),panda.require("heroFn.uploadEvent"),panda.require("heroFn.manageCountries"),b=$(".js-bonus-key-cnt").attr("min"),c=$(".js-bonus-key-cnt").attr("max"),$(".js-toggle-wait-interval").change(d.toggleWaitInterval),$(".js-toggle-key-tier-required").change(d.toggleKeyTierRequired).filter(":checked").change(),$(".js-update-max-bonus-key-cnt").change(d.updateMaxBonusKeyCnt),$(".js-auto-gen").on("click",d.generateThumbnail),$(".js-on-sale").on("click",d.toggleOnSale),$(".js-must-pay-mode").on("change",d.toggleMustPay),panda.require("fn.timepicker",$(".pikaday"),{allowPast:!1}),$(".js-on-sale").prop("checked")&&d.appendSaleAttribute(),$(".js-genre-check").on("change",d.updateMainGenre),e.on("change",d.selectMainGenre),$("#series").on("submit",d.submitForm),d},selectMainGenre:function(){var a=0===pInt($(this).val());e.next().toggleClass("hidden",!a)},updateMainGenre:function(){var a=e.val();if($(".js-genre-option-"+this.value).toggleClass("hidden",!this.checked),a!==this.value||this.checked)"0"===a&&this.checked&&e.val(this.value);else{var b=$(".js-genre-check:checked");e.val(b[0]?b[0].value:"0")}},updateMaxBonusKeyCnt:function(){var a=$(this),b=a.val(),c=b-a.data("freeEpisodeCnt");$(".js-bonus-key-cnt").attr("max",c),$(".js-max-bonus-key-cnt").text(c)},toggleMustPay:function(){var a="true"===$(this).val();$(".js-must-pay-amt").toggleClass("hidden",a),$(".js-must-pay-pct").toggleClass("hidden",!a)},toggleWaitInterval:function(){var a="WAIT_OR_MUST_PAY"===$(this).prop("value");$(".js-wait-interval").toggleClass("hidden",!a),a||($(".js-must-pay-cnt").val(0),$(".js-must-pay-percent").val(0))},toggleKeyTierRequired:function(){var a="FREE"===$(this).prop("value"),d="WAIT_OR_MUST_PAY"===$(this).prop("value"),e=$(".js-key-tier"),f=$(".js-key-price"),g=$(".js-bonus-key-cnt"),h=$(".js-must-pay-cnt");$(".js-none-free-series").toggleClass("hidden",a),a?(b=g.attr("min"),c=g.attr("max"),e.removeAttr("required"),f.removeAttr("required"),g.removeAttr("min").removeAttr("max"),h.removeAttr("required")):d?h.attr("required","required"):(e.attr("required","required"),f.attr("required","required"),g.attr("min",b).attr("max",c),h.removeAttr("required"))},generateThumbnail:function(a){panda.stopEvent(a);var b=$(this),c=$(".js-bookcover-img").find("img").attr("src");if(!$.trim(c))return void panda.alert({body:"Add book cover first!"});var d=c.indexOf("tmp")>-1?"tmp/":"sa/",e=d+c.split(d)[1];if(b.hasClass("disabled")||b.data("key")===e)return void b.data("key",!1);b.addClass("disabled").data("key",e);var f=b.closest(".js-file-wrap");panda.showGlobalMessage("Requesting...",!1,!1,-1),$.post(panda.getEnvs("rTapasIoHost")+"/file/auto-gen",{key:e},function(a){panda.showGlobalMessage("Done.",!1,!1),b.removeClass("disabled"),f.find("#thumbFile").val(JSON.stringify(a)),f.find(".js-file-name").val(a.filename).attr("readonly","readonly"),f.find(".js-file-img").empty().append($("<img />").attr("src",a.s3.url).attr("height","50"))}).fail(function(){panda.showGlobalMessage("Error.. Try it again!",!0,!1),b.removeClass("disabled")})},toggleOnSale:function(){var a=$(this);$(".js-on-sale-info").toggleClass("hidden",!a.prop("checked")),a.prop("checked")?d.appendSaleAttribute():($(".js-end-date").val(""),$(".js-start-date").val(""),$(".js-discount-rate").val(0).removeAttr("min").removeAttr("max"),$(".js-sale-input").removeAttr("required"))},appendSaleAttribute:function(){$(".js-sale-input").attr("required","required"),$(".js-discount-rate").attr("min",1).attr("max",99)},submitForm:function(a){if(0===pInt(e.val()))return e.next().removeClass("hidden"),panda.stopEvent(a),!1}}},panda.heroContent.episodeList=function(){return{init:function(){panda.require("heroContent.chinaLiterature").importEpisode(),$(".js-episode-notification-btn").on("click",function(a){panda.stopEvent(a);var b,c,d,e,f=$(this),g=f.data("modalId"),h=panda.templateCompile(g,{});panda.showOverlay(h,!0),e=function(a){panda.stopEvent(a),d.attr("disabled")||panda.alert({title:"are you sure?",body:'"'+c.val()+'"<br>Sending push notification like this.',isConfirm:!0,cb:function(){b.off("submit").submit()}})},b=h.find("#js-episode-notification-form").on("submit",e),d=h.find(".js-send-btn").on("click",e),c=h.find("#msg").on("input",function(){d.attr("disabled",""===$.trim(c.val()))})})}}},panda.heroContent.episode=function(){var a,b,c,d={},e="true"===$("#isBook").val(),f=$("#title"),g=$("#js-sortable"),h=$(".js-editor"),i=$("#publishDate"),j=$(".js-publish-day"),k=$(".js-publish-time"),l=$("#schedule-time");return d={init:function(){return a=panda.require("fn.fileUploadToS3"),panda.require("heroFn.uploadEvent"),panda.require("fn.timepicker",$(".pikaday"),{allowPast:!1}),panda.require("heroFn.checkTextLength"),$("#episode").on("submit",d.submit).on("click",".js-submit-btn",d.validateBook).on("input",f,d.clearError).on("click",".js-publish-now",d.publishNow).on("click",".js-remove-content",d.removeContent).on("change",".js-toggle-schedule",d.toggleSchedule).on("change",".js-publish-time",d.setDate).on("change",".js-ep-status",d.toggleStatus).on("change",".js-content-type",d.toggleBookType).on("click",".js-episode-free-btn",d.showFreeButton).on("click",".js-content-file-name",d.toggleCheckbox).on("click",".js-remove-select",d.removeSelect).on("click",".js-remove-all",d.removeAll),d.setEvents(),g.isExists()&&d.loadSort(),e&&h.isExists()&&(b=panda.require("heroFn.editor",h,{toolbar:[["format",["style"]],["style",["bold","italic","underline","strikethrough","clear"]],["color",["color"]],["insert",["link","picture"]]],callbacks:{onKeyup:d.onKeyup,onImageUpload:d.onImageUpload,onPaste:d.onPaste},limit:15e3}),b.loadContent($(".js-html").text()),d.onKeyup()),d.initScheduledDate(),this},clearError:function(){f.parent().next().addClass("hidden")},onPaste:function(a){var c=a.originalEvent.clipboardData,d=c.getData("text/html"),e=d.indexOf("<body>"),f=e>0,g=$(".note-editable")[0].getElementsByTagName("meta"),h=/font-size:\s+\d+p[t|x][;]+/gi,i=d.replace(h,"");if(f){var j=$(".note-editable")[0].getElementsByTagName("style");setTimeout(function(){$(j).remove(),$(g).remove()},10)}g&&setTimeout(function(){$(g).remove()},10),setTimeout(function(){b.loadContent(i)},10)},onImageUpload:function(b){return b.length>1||0===b.length?(panda.alert({body:"You can upload one image at once"}),!1):$(".note-editable").find("img").length>=5?(panda.alert({body:"You can upload images up to 5"}),!1):void a.resizeBase64({files:b[0]},function(a){var b="data:image/jpeg;base64,"+a.result,c=$("<img>").attr("src",b)[0];h.summernote("insertNode",c)})},onKeyup:function(){var a=b.getTextLength(),c=$(".js-count"),d=c.data("limit"),e=a>d;c.find("span").text(panda.commifyNumbers(a)).toggleClass("error",e),b.setOverLimit(e)},loadSort:function(){var a=0;g.sortable({connectWith:"ul#js-sortable",opacity:.5,revert:!0,items:"> .preview-file",helper:function(a,b){b.hasClass("selected")||b.addClass("selected");var c=$(".selected").not(".ui-sortable-placeholder").clone();return b.siblings(".selected").addClass("hidden"),$("<ul/>").append(c)}}),g.on("sortstart",function(b,c){var d=c.helper.children();c.item.data("items",d),a=c.item.index()}),g.on("sortreceive",function(a,b){b.item.before(b.item.data("items"))}),g.on("sortstop",function(){$(".selected").removeAttr("style").removeClass("selected ui-sortable-placeholder"),$(".js-file-checkbox").prop("checked",!1),d.setEvents(),g.sortable("refresh"),g.sortable("refreshPositions").children().each(function(a){$(this).removeAttr("data-idx").attr("data-idx",a)})}),g.on("sortupdate",function(b,c){if(c.item.siblings(".selected.hidden").remove(),c.item.data("items").length>1){var d=0;c.item.data("items").each(function(b){var e=$(this),f=e.data("idx");f!==a?f<a?$(c.item).before(e):d===c.item.siblings(".selected").length?$(c.item).after(e):c.item.siblings(".selected").last().after(e):d=b})}})},setEvents:function(){$(".js-file-checkbox").on("change",function(){var a=$(this);a.parent().toggleClass("selected",a.prop("checked"))})},initScheduledDate:function(){var a,b,d,e;if(i.val())a=moment(i.val()),b=a.format("hh:mm A"),d=a.format("YYYY-MM-DD"),e=a.format("HH:mm"),c=!0;else{a=moment(panda.getEnvs("today"),"yyyy/MM/DD HH:mm:ss").add(1,"h"),d=a.format("YYYY-MM-DD"),b=a.format("hh:00 A"),e=a.format("HH:00"),c=!1}j.val(d),k.val(b),l.val(e)},publishNow:function(a){panda.stopEvent(a),panda.alert({title:"Are you sure?",body:"Publishing it now.",isConfirm:!0,cb:function(){c=!1,$("#episode").submit()}})},removeAll:function(a){panda.stopEvent(a),$(".js-contents").empty()},removeContent:function(a){panda.stopEvent(a),$(this).parent().remove()},removeSelect:function(a){panda.stopEvent(a),$(".js-file-checkbox:checked").parent().remove()},resetMultiInputNames:function(a){var b=!1;$(".js-contents").children(".preview-file").each(function(a){b=!0,$(this).find(".js-update-name").each(function(){var b=$(this).data("field"),c=b.replace("__idx__",a);$(this).attr("name",c)})}),b||(panda.stopEvent(a),panda.hideOverlay())},toggleBookType:function(){var a="true"===$(this).val();$(".js-book-file").toggleClass("hidden",!a),$(".js-book-edit").toggleClass("hidden",a),a?b.clear():$(".js-epub-file-name").val(""),$(".js-file-result").val("")},toggleCheckbox:function(){$(this).prev().prev().click()},toggleSchedule:function(){var a=$(this).val();c="schedule"===a,$(".js-schedule").toggleClass("hidden",!c),$(".js-publish").toggleClass("hidden",c)},toggleStatus:function(){$(".js-free-alert").isExists()&&$(".js-free-alert").toggleClass("hidden","true"!==$(this).val())},setDate:function(){var a=j.val(),b=$(this),c=moment(a+" "+b.val(),["YYYY-MM-DDhh:mm a"]),d=c.isValid();b.toggleClass("warning",!d),d&&(b.val(c.format("hh:mm A")),l.val(c.format("HH:mm")))},setPublishDate:function(a){if(c){k.hasClass("warning")&&(panda.stopEvent(a),panda.hideOverlay());moment(j.val()+" "+l.val(),["YYYY-MM-DD HH:mm"]).isValid()?i.val(moment(j.val()+" "+l.val()).format("YYYY-MM-DD HH:mm")):(j.val(""),j.focus(),panda.stopEvent(a),panda.hideOverlay())}else i.val("");return!0},validateBook:function(){var c=!0,d="true"===$(".js-content-type:checked").val();""===f.val().trim()&&(f.val(""),f.parent().next().removeClass("hidden"),c=!1),(d&&""===$(".js-epub-file-name").val()||!d&&b.isEmpty())&&(panda.alert({body:"Content is empty."}),c=!1),b.isOverLimit()&&(panda.alert({body:"Content is too long. Please enter up to 15000 characters."}),c=!1),c&&(d?$("#episode").submit():b.isEmpty()||a.uploadToR("HERO_NOVEL",{html:b.getMarkup()},function(a){$(".js-file-result").val(JSON.stringify(a)),$("#wordsCnt").val(b.getWords()),$("#episode").submit()}))},showFreeButton:function(a){panda.stopEvent(a);var b=$(this);$(".js-episode-status").removeClass("hidden"),$(".js-ep-status").filter('[value="true"]').click(),b.addClass("hidden")},submitComic:function(a){d.resetMultiInputNames(a)},submit:function(a){if($(this).data("submit"))return!1;panda.showLoading(),d.setPublishDate(a),e||d.submitComic(a)}}},panda.heroContent.chinaLiterature=function(){var a={},b=/(https?:\/\/www.webnovel.com\/book\/)\d+[\/\w-_]+/,c=/(https?:\/\/www.webnovel.com\/book\/)/;return a={init:function(){return a},importSeries:function(){$(".js-import-cl").on("click",a.handleImportPopup)},importEpisode:function(){$(".js-list-cl-vol").on("click",a.createEpisodes)},createEpisodes:function(a){panda.stopEvent(a),panda.getActionFormSubmit().attr({method:"post"}),panda.showLoading(),panda.actionFormSubmit($(this).getHref())},handleImportPopup:function(a){panda.stopEvent(a);var d=panda.templateCompile("tpCLBook");panda.showOverlay(d,!0),d.find(".js-create-cl").on("click",function(a){panda.stopEvent(a);var d=$(this),e=d.getHref(),f=$(".js-input").val().trim(),g=b.test(f);if($(".js-alert").toggleClass("hidden",g),g){var h=f.replace(c,""),i=h.indexOf("/"),j=i>0,k=j?h.substring(0,i):h;$.getJSON("/hero/tapas-series/validate/"+k,{isPlan:!0},function(a){a.data.exist?panda.alert({body:"The book is already imported. ID is "+a.data.series.id}):(panda.getActionFormSubmit().append($('<input type="hidden" name="cbid">').val(k)),panda.actionFormSubmit(e))})}})}}},panda.namespace("coins"),panda.coins.main=function(){var a,b={},c=$("#transactionTable"),d=$(".body-holder",c),e=function(a){var b=panda.convertQuerystringToObj(a);$.getJSON(a,b,function(a){var b=a.data;d[0].innerHTML=b.body})};return b={init:function(a){return a&&panda.require("coins.shop").drawPopup("/coins/popup","announcement",a),b.setEvents(),b},setEvents:function(){a=panda.require("fn.dockedMenu"),$('[data-toggle="tooltip"]').tooltip(),c.on("click",".paging-prevnext",function(a){panda.stopEvent(a),e($(this).getHref())})}}},panda.coins.shop=function(){var a,b,c,d,e,f,g,h,i={},j="menu_buy",k=function(a){var b=$(this);panda.stopEvent(a),$(".js-complete-btn").hasClass("loading")||(panda.hideOverlay(),setTimeout(function(){i.openCoinTierPopup.apply(b)},300))};return i={init:function(){return e=panda.require("coins.stripe"),f=panda.require("coins.paypal"),g=panda.require("coins.hyprmx"),h=panda.require("coins.timer"),i},appendBtn:function(b){return a=b,i.setEvents(),i},setEvents:function(){a.on("click",i.openCoinTierPopup)},setCoinSuccessCallback:function(a){return d=a,i},showWarningTooltip:function(a,b){var c=a.find(".coin-status"),d=panda.require("tip.amount"),e=d.getData();if(e){e.amount<=c.find(".js-current-balance").data("currentBalance")&&b>0&&setTimeout(function(){c.tooltip({html:!0,title:"<p>Only ink you buy or earn may be used for tipping.</p><p>Click the ? for details.</p>",placement:"bottom",trigger:"hover",container:$(".modal-backdrop")}).tooltip("show")},1)}},drawPopup:function(a,d,e){j=d||j,$.getJSON(a,{gaCategory:j},function(a){var d=a.data.html,f=panda.templateCompile("tpCoinShop",{html:d});c=a.data.stripe_key,b=a.data.token,h.show(f.find(".js-time-limit")),f.find(".js-coin-btn").on("click",function(a){var b=$(this),c=b.parent();if(panda.stopEvent(a),c.hasClass("disabled"))return panda.showGlobalMessage("This tier is expired.",!0,!1,1500),!1;panda.addGATrackEvent({category:j,action:"tier",label:b.data("tierName")});var d=panda.templateCompile(b.data("templateId"));panda.hideOverlay(),i.openPurchasePopup(d,{amount:b.data("rawAmount"),itemAmount:b.data("itemAmount"),email:b.data("email"),gaCategory:j})}),g.setting(a.data.user_id,!0,f.find(".js-video-btn"),j,e),panda.showOverlay(f,!0),f.find('[data-toggle="tooltip"]').tooltip(),"tip"===j&&i.showWarningTooltip(f,a.data.current_bonus)})},openCoinTierPopup:function(a){var b=$(this),c=b.getHref();j=b.data("gaCategory"),panda.stopEvent(a),i.drawPopup(c)},openPurchasePopup:function(a,g){var h=a.find(".js-complete-btn");g.completeBtn=h,g.successCallback=d,a.on("click",".js-change-coin-btn",k).on("click",".js-card",function(a){panda.stopEvent(a),e.open(c,g)}).on("click",".js-paypal",function(a){if(panda.stopEvent(a),$(this).hasClass("loaded"))return!1;$(this).addClass("loaded"),f.open(b,g)}),h.on("click",function(a){($(this).hasClass("disabled")||$(this).hasClass("loading"))&&panda.stopEvent(a)}),setTimeout(function(){panda.showOverlay(a,!0),$('[data-toggle="tooltip"]').tooltip()},5)}}},panda.coins.stripe=function(){var a,b,c,d,e={},f=function(a){panda.stopEvent(a);var e=$(this);if(e.hasClass("disabled")||e.hasClass("loading"))return!1;panda.addGATrackEvent({category:b.gaCategory,action:"complete",label:"complete_btn"});var f={isPlain:!0,payload:c,card:d,byPaypal:!1,isSkipCommonAlert:!0};e.removeClass("disabled").addClass("loading"),$.postJSON(e.getHref(),f,function(a){if(e.removeClass("loading").addClass("loaded"),a.code>=400)panda.alert({body:a.msg}),e.removeClass("loaded").addClass("disabled");else{var c=a.data.price_tier,d=a.data.transaction_id,f=panda.templateCompile("tpPurchaseCoinResult",{imgPath:c.name,amount:c.formatted_coin_amount});panda.hideOverlay(),setTimeout(function(){if("undefined"!=typeof ga&&(ga("ecommerce:addTransaction",{id:d,affiliation:"Tapas ink shop - web",revenue:c.dollar_price,currency:"USD"}),ga("ecommerce:addItem",{id:d,name:c.name,sku:c.product_id,price:c.dollar_price,currency:"USD"}),ga("ecommerce:send")),b.isMobile){var a=b.successCallback||panda.goPage();panda.callback(a)}else panda.showOverlay(f,!0,function(){var a=b.successCallback||panda.goPage();panda.callback(a)})},300)}})};return e={init:function(){return a&&a.close(),e},open:function(e,g){a&&a.close(),$("#paypal-button").empty(),$(".js-paypal").removeClass("loaded"),c=null,b=g,a=StripeCheckout.configure({key:e,image:panda.getEnvs("appDomain")+"/resources/images/tapamon-stripe.png",locale:"US",token:function(a){b.completeBtn.removeClass("disabled"),c=a.id,d=a.card.id,f.apply(b.completeBtn)}});var h=pInt(b.itemAmount);a.open({name:"Tapas Media, Inc.",description:"Get "+panda.formattedString(h)+" Tapas ink",amount:b.amount,email:b.email})}}},panda.coins.paypal=function(){var a,b,c={};return c={init:function(){return b="prod"===panda.getEnvs("env"),c},open:function(c,d){a=d,braintree.client.create({authorization:c},function(c,d){if(c)return panda.alert({body:"Error loading PayPal client."}),void a.completeBtn.removeClass("loading loaded").addClass("disabled");braintree.paypalCheckout.create({client:d},function(c,d){if(c)return panda.alert({body:"Error creating PayPal Checkout."}),void a.completeBtn.removeClass("loading loaded").addClass("disabled");paypal.Button.render({env:b?"production":"sandbox",payment:function(){return d.createPayment({flow:"checkout",amount:a.amount/100,currency:"USD",intent:"sale",displayName:"Tapas Media, Inc."})},onAuthorize:function(b){return d.tokenizePayment(b,function(b,c){if(a.completeBtn.removeClass("disabled").addClass("loading"),b)return panda.alert({body:"Uh oh, something went wrong. Please try it again."}),a.completeBtn.removeClass("loading loaded").addClass("disabled"),!1;panda.addGATrackEvent({category:a.gaCategory,action:"complete",label:"complete_btn"}),$.postJSON(a.completeBtn.getHref(),{isPlain:!0,payload:c.nonce,byPaypal:!0},function(b){a.completeBtn.removeClass("loading").addClass("loaded");var c=b.data.price_tier,d=b.data.transaction_id,e=panda.templateCompile("tpPurchaseCoinResult",{imgPath:c.name,amount:c.formatted_coin_amount});panda.hideOverlay(),setTimeout(function(){if("undefined"!=typeof ga&&(ga("ecommerce:addTransaction",{id:d,affiliation:"Tapas ink shop - web",revenue:c.dollar_price,currency:"USD"}),ga("ecommerce:addItem",{id:d,name:c.name,sku:c.product_id,price:c.dollar_price,currency:"USD"}),ga("ecommerce:send")),a.isMobile){var b=a.successCallback||panda.goPage();panda.callback(b)}else panda.showOverlay(e,!0,function(){var b=a.successCallback||panda.goPage();panda.callback(b)})},300)})})},onCancel:function(c){b||console.log("checkout.js payment cancelled",JSON.stringify(c,0,2)),panda.alert({body:"Payment cancelled."}),a.completeBtn.removeClass("loading loaded").addClass("disabled"),$("#paypal-button").empty(),$(".js-paypal").removeClass("loaded")},onError:function(c){b||console.error("checkout.js error",c),panda.alert({body:"Uh oh, something went wrong. Please try it again."}),a.completeBtn.removeClass("loading loaded").addClass("disabled"),$("#paypal-button").empty(),$(".js-paypal").removeClass("loaded")}},"#paypal-button").then(function(){})})})}}},panda.coins.hyprmx=function(){var a,b,c,d,e={},f=!0,g=!1,h=!1,i=panda.getEnvs("distributorid");return e={init:function(){return e},setting:function(e,j,k,l,m){c=Math.floor(65534*Math.random())+1,b=e,f=j,a=k||$(".js-video-btn"),d=l,h=m||!1,g=!1;var n="https://live.hyprmx.com/embedded_offers/videos_available_jsonp?uid="+b+"&distributorid="+i;$.getScript(n)},createForm:function(){return $("<form />").attr({method:"post",name:"hyprmx"}).hide().appendTo("body")},showVideo:function(a){panda.stopEvent(a),panda.hideOverlay(),panda.addGATrackEvent({category:f?"coins":"m_coins",action:"video"});var d=panda.templateCompile("tpRewardVideo"),g="https://live.hyprmx.com/embedded_offers/player?uid="+b+"&distributorid="+i+"&partner_code="+c;d.find("#ads-iframe").css("display","block"),panda.showOverlay(d,!0,e.hideVideo);var h=e.createForm();h.attr({target:"ads-iframe",action:g}),h.submit()},toggleVideoBtn:function(b){1===parseInt(b)&&(a.on("click tap",e.showVideo),a.parent("li").removeClass("disabled").find(".coin-price").tooltip("destroy"),a.find(".js-video-title").text("Earn free ink"),a.find(".js-video-label").html("Watch"),h&&a.find(".coin-amount").append('<p class="special-label new">New</p>'))},reward:function(){g=!0,$.getJSON("/reward-video/coin",{idx:c},function(a){panda.hideOverlay();var b=a.data,c=parseInt(b.reward_amount);if(c>0){var e=panda.templateCompile("tpRewardVideoConfirm",{amount:c});panda.showOverlay(e,!0,function(){f?panda.require("coins.shop").drawPopup("/coins/popup",d,h):panda.goPage()})}})},hideVideo:function(){g||(f?panda.require("coins.shop").drawPopup("/coins/popup",d,h):panda.goPage())}}},panda.coins.timer=function(){var a={};return a={init:function(){return a},show:function(a){if(a){var b=a.data("date");if(b)var c=b.indexOf("Z"),d=b.substring(0,c+1),e=new Date(d).getTime(),f=setInterval(function(){var b=(new Date).getTime(),c=e-b,d=Math.floor(c/864e5),g=Math.floor(c%864e5/36e5),h=Math.floor(c%36e5/6e4),i=Math.floor(c%6e4/1e3);a.text(d+"d "+g+"h "+h+"m "+i+"s "),c<0&&(clearInterval(f),a.closest("li").addClass("disabled"),a.text("Expired"))},1e3)}}}};var pInt=function(a){return parseInt(a||0,10)};panda.namespace("tip"),panda.tip.main=function(){var a,b,c,d,e,f,g,h={},i=panda.getEnvs("isMobileView"),j=25,k=999999,l=!1,m=0,n={amount:0,label:0};return h={init:function(a){return a&&(b=a.seriesId,c=a.seriesTitle),d=panda.require("tip.amount"),e=panda.require("coins.shop"),$.getJSON("/who-am-i",function(a){f=a.data.user}),i?(h.haveToSign(),$(".js-support-button").on("tap",function(a){panda.stopEvent(a),panda.goPage($(this).getHref())}),$(".js-support-pop-btn").on("tap",h.showPopup),g=$(".js-pageable-list"),h.showMore($("body"))):(h.haveToSign(),$(".js-support-btn").on("click",h.showPopup)),h},haveToSign:function(){$(".have-to-sign").on("click",function(a){return panda.stopEvent(a),panda.account.signin.load.call($(".have-to-sign")),!1})},setDefault:function(a,d,e){return h.haveToSign(),b=d,c=e,a.on("click",h.showPopup),h},showMore:function(a){var b=a.find(".js-support-desc"),c=b.parent().height();if(c<b.height())for(var d,e=b.html(),f=e.split(" "),g=-1,h=function(){a.find(".js-max-height").removeClass("max-height"),b.html(f.join(" "))};;)if(b.html(f.slice(0,g--).join(" ")+'<span class="js-more">... <a class="more-btn">more</a></span>'),(d=b.height())<=c||d<=0){b.find(".js-more").on("click",h);break}a.find(".js-max-height").removeClass("invisible")},showPopupByCall:function(){h.showPopup.call($(".js-support-btn"))},showPopup:function(b){panda.stopEvent(b);var c=$(this);$.getJSON(c.getHref(),function(b){var f=b.data,j=f.html,k=panda.templateCompile("tpSupportPopup",{html:j});m=f.current_tip_balance,k.on("input",".js-amount-input",h.enterAmount).on("input",".js-msg-input",h.countWords).on("click",".js-post-btn",h.postMessage),a=k;var l=d.getData();l&&h.enterAmount.apply(k.find(".js-amount-input").val(l.label)),panda.showOverlay(k,!1);var n=k.find(".js-buy-coins-btn");i?n.on("tap",function(a){panda.stopEvent(a);var b=c.data("returnUrl");panda.goPage("/coins?ga_category=m_support&return_url="+b)}):(g=k.find(".js-message-list").parent().on("scroll",h.pagingMessage).end(),n.on("click",function(a){panda.stopEvent(a),panda.hideOverlay(),setTimeout(function(){e.setCoinSuccessCallback(function(){h.showPopup.apply($(".js-support-btn"))}).drawPopup("/coins/popup","support")},100)}),setTimeout(function(){h.showMore(k)},1))})},countWords:function(){var a=$(this),b=a.val().trim(),c=a.closest(".js-support-message"),d=c.find(".js-words"),e=$(".js-amount-input");d.text(b.length),d.parent().toggleClass("error",b.length>pInt(d.data("limit"))),h.handlePost(e,a,c,d.parent())},enterAmount:function(){var a=$(this),b=a.val().trim(),c=a.closest(".js-support-message"),e=c.find(".js-words"),f=$(".js-msg-input");panda.isNumber(b)||(b=b.replace(/[^\d]+/g,"")),b=b.replace(/\s+/g,"");var g=d.getInfo(b),i=g.label;a.val(0===i?"":i),a.removeClass("error"),h.storeAmountData(b,i),h.handlePost(a,f,c,e.parent()),h.validateTipBalance(b)},storeAmountData:function(a,b){n={amount:a,label:b},d.storeData(a,b)},handlePost:function(a,b,c,d){var e=i?c.parent().find(".js-post-btn"):c.find(".js-post-btn"),f=a.val().trim().replace(/[^\d]+/g,""),g=!d.hasClass("error")&&""!==f&&f>=j&&f<=k&&!a.hasClass("error");e.toggleClass("disabled",!g)},loadMessage:function(){var a,b=g.data("url"),c=g.data("page"),d=g.data("since");$.getJSON(b,{keepOverlay:!0,page:c,since:d},function(b){var c=b.data,d=c.pagination;a=g.find(".js-loading-indicator").remove(),g.append(c.body),g.data("page",d.page).data("since",d.since).data("next",d.has_next),d.has_next&&g.append(a)})},pagingMessage:function(a){var b=$(this),c=g.data("next");c&&a.originalEvent.target.scrollHeight===a.originalEvent.target.scrollTop+b.innerHeight()?h.loadMessage():c||g.parent().off("scroll",h.pagingMessage)},postMessage:function(d){panda.stopEvent(d);var e,f,o,p,q=$(this),r=$(".js-msg-input");q.hasClass("disabled")||l||(o=pInt(n.amount))>=j&&o<=k&&(l=!0,q.addClass("loading").find("span").text("Posting..."),e=r.val().trim(),f=q.getHref(),i||g.closest(".messages-wrap").scrollTop(0),h.renderInstantMessage(n.label,e),p={isPlain:!0,keepOverlay:!i,amount:o,message:e,sid:b,via:i?"mweb":"web"},$.postJSON(f,p,function(b){l=!1;var d,e=b.data,f=e.not_enough_balance;if(f)panda.require("coins.shop").drawPopup("/coins/popup?tip_amount="+o,"tip");else{if(d=e.relative_time+(c?'<span class="dot"></span>'+c:""),i)q.removeClass("loading").find("span").text("Give your support"),g.find(".js-instant-msg").removeClass("js-instant-msg").find(".js-info").html(d),panda.hideOverlay();else{var j=$('li[data-type="tipper"]');j.isExists()&&h.updateStat(e,j),q.removeClass("loading").find("span").text("Give your support"),m=pInt(e.current_tip_balance),a.find(".js-current-balance").data("currentBalance",e.current_balance).text(e.current_balance_str),g.find(".js-instant-msg").removeClass("loading js-instant-msg").find(".js-info").html(d)}var k=$(".js-supporters"),n=k.removeClass("hidden").data("cnt"),p=e.tipper_cnt-1;k.find(".js-new-supporter").removeClass("hidden"),k.data("cnt",p),p>n&&p>0&&k.find(".js-other-supporters").text("and "+p+panda.makePlural(i?" other":" other supporter",p)).removeClass("hidden"),h.renderProgressBar(e)}}))},renderProgressBar:function(a){var b=$(".js-progress-bar"),c=a.support_goal,d=c.amount,e=c.income,f=c.percentage;b.isExists()&&c.enabled&&(b.find("span").css({width:f+"%"}),b.next().html('<span class="bold">'+panda.formattedString(e)+"</span> of "+panda.formattedString(d)+" ink goal"))},renderInstantMessage:function(a,b){var c={amount:a,message:b,uname:f.uname,name:f.display_name,thumb:f.profile_pic_url},d=panda.templateCompile("tpSupportMessageFragment",c);g.hasClass("empty")?g.html(d).removeClass("empty"):g.prepend(d)},updateStat:function(a,b){var c=a.tipper_cnt,d=a.tipper_cnt_str,e=panda.formattedString(c);b.find(".js-cnt").text(d),b.tooltip("destroy").tooltip({placement:"right",trigger:"hover",container:$("#page-wrap"),title:function(){var a=$(this).data("type");return e+" "+panda.makePlural(a,c)}})},validateTipBalance:function(b){var c,d,e,f,g=pInt(b),h=g>m,l=g<j,n=g>k;g<1||(c=a.find(".coin-status"),d=a.find(".js-amount-error"),e=a.find(".js-amount-input"),i?d.toggleClass("hidden",!(h||l||n)).find(".js-down").toggleClass("hidden",l).end().find(".js-up").toggleClass("hidden",n||h):(h&&(f="Get more ink"+(i?"":" <span>or adjust amount</span>")),l&&(f="Please enter 25 or more"),!h&&n&&(f="Please adjust amount"),d.html(f).toggleClass("in",h||l||n)),c.find(".amount").toggleClass("error",h),e.toggleClass("error",l||n))}}},panda.tip.amount=function(){var a={},b="tipHistory",c={},d=panda.getEnvs("userId");return a={init:function(){return c=JSON.parse(localStorage.getItem(b))||{},a},getData:function(){var a=localStorage.getItem(b);if(a){var c=JSON.parse(a);return void 0!==c[d]?c[d]:null}return{amount:0,label:0}},storeData:function(a,e){c[d]={amount:a,label:e},localStorage.setItem(b,JSON.stringify(c))},getInfo:function(a){var b="string"==typeof a&&a.indexOf(",")>=0,c=b?a.replace(/,/gi,""):a,d=pInt(c);return{amount:d,label:d>999?panda.formattedString(d):d}}}},panda.namespace("pushMessage"),panda.pushMessage.main=function(){var a,b,c,d={},e=panda.getEnvs("isMobileView"),f="/resources/js/firebase-sw.js",g=e?"m-notifications":"notifications",h=$(window),i="";return d={init:function(b){return c=b||!1,a=panda.require("pushMessage.storage"),d.loadServiceWorker(),d},loadServiceWorker:function(){"serviceWorker"in navigator&&(b=firebase.messaging(),navigator.serviceWorker.register(f).then(function(a){return b.useServiceWorker(a),b.getToken()}).then(function(b){a.hasValidExpireDate()||(null===b||""===a.getTokenStorage()?d.handleShowPushNoticeBar():b!==a.getTokenStorage()&&(i=a.getTokenStorage(),a.setTokenStorage(""),d.sendTokenToServer(b)))}).catch(function(a){panda.log(a.message)}))},requestPermission:function(){b.requestPermission().then(function(){return b.getToken()}).then(function(b){i=a.getTokenStorage(),a.setTokenStorage(""),d.sendTokenToServer(b)}).catch(function(a){panda.log(a.message)})},handleShowPushNoticeBar:function(){d.renderPushNotificationBar(),h.on("beforeunload",function(){$(".js-push-notice-bar").isExists()&&(a.storeExpireDate(10),panda.addGATrackEvent({category:g,action:"exit"}))})},renderPushNotificationBar:function(){var b=$(".global-nav"),e=panda.templateCompile("tpPushNoticeButterBar");e.on("click tap",".js-dismiss-btn",function(b){a.storeExpireDate(15),d.hidePushNoticeBar(b),panda.addGATrackEvent({category:g,action:"dismiss"})}).on("click tap",".js-push-activate-btn",function(a){d.requestPermission(),d.hidePushNoticeBar(a),panda.addGATrackEvent({category:g,action:"ok"})}),c&&e.css({position:"fixed"}),b.after(e)},hidePushNoticeBar:function(a){panda.stopEvent(a),$(".js-push-notice-bar").remove()},sendTokenToServer:function(b){a.hasTokenStorage()||$.postJSON("/push-message",{isPlain:!0,token:b,old_token:i},function(c){200===c.code&&a.setTokenStorage(b)})}}},panda.pushMessage.storage=function(){var a,b={},c=panda.getEnvs("userId"),d="pushNotification_"+c,e="userToken_"+c;return b={init:function(){return a=localStorage.getItem(d),b},hasTokenStorage:function(){return""!==b.getTokenStorage()},getTokenStorage:function(){return localStorage.getItem(e)||""},setTokenStorage:function(a){localStorage.setItem(e,a)},hasValidExpireDate:function(){var a=b.getExpireDate();if(a){var c=Date.now(),d=pInt(a)<pInt(c);return d&&b.storeExpireDate(),!d}return!1},getExpireDate:function(){return localStorage.getItem(d)},storeExpireDate:function(b){var c=0;if(b){var e=Date.now();b=pInt(b),c=e+24*b*60*60}a=c,localStorage.setItem(d,a)}}};